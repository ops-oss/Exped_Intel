<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition</title>

  <link rel="stylesheet" href="/fonts.css" />

  <style>
    :root{
      --bg: rgb(232, 229, 226);
      --ink: rgb(30, 30, 30);
      --paper: rgb(255, 255, 255);
      --accent: rgb(254, 87, 51);
      --font-sans: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;
      --h1: clamp(40px, 18vw, 88px);
      --label: 14px;
      --body: 18px;
      --border: rgba(0,0,0,.16);
      --border-soft: rgba(0,0,0,.10);
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink); font-family:var(--font-sans);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    img{ display:block; width:100%; height:auto }
    a{ color:inherit; text-underline-offset:2px }

    .page{ max-width:1120px; margin:0 auto; padding:24px 16px 40px; display:grid; row-gap:20px; }
    .title{ font-size:var(--h1); line-height:1.02; font-weight:700; letter-spacing:-0.02em; }

    /* Approved: ghost actions under title */
    .actions{ display:flex; gap:18px; flex-wrap:wrap; }
    .btn-ghost{
      display:inline-flex; align-items:center; gap:10px;
      padding:12px 18px; background:transparent; color:inherit;
      border:1px solid var(--border); border-radius:8px; font-weight:600;
      text-decoration:none; cursor:pointer;
    }
    .btn-ghost .ico{ width:20px; height:20px; stroke:currentColor; }

    /* Approved: labels with subtle line icons */
    .label{ font-size:var(--label); letter-spacing:.18em; text-transform:uppercase; opacity:.7 }
    .label.with-icon{ display:flex; align-items:center; gap:.5rem; }
    .label .ico{ width:18px; height:18px; stroke:currentColor; opacity:.9; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:16px 28px; align-items:start; margin-top:8px; }
    @media (min-width:960px){ .grid2{ grid-template-columns:repeat(4,1fr); } }
    .value{ font-size:clamp(18px,2.6vw,28px); line-height:1.28 }

    .fullbleed{ width:100vw; margin-left:calc(50% - 50vw); }
    #heroLink{ display:block; }
    .credit{ text-align:right; font-size:14px; margin-top:8px; color:var(--accent); padding-right:16px; }
    .credit a{ text-decoration:underline; cursor:pointer; }

    .mission{ font-size:var(--body); line-height:1.6; margin-top:8px; white-space:pre-wrap; max-width:720px; margin-left:auto; margin-right:auto; text-align:left; }

    /* NEW: Expedition Itinerary chip section */
    .exp-itin { max-width:900px; margin:10px auto 0; border:1px solid rgba(0,0,0,.08); border-radius:10px; background:rgba(255,255,255,.35); padding:16px; }
    .exp-itin h2{ margin:0 0 10px; font-size:clamp(18px,3.2vw,24px); letter-spacing:-0.01em; }
    .exp-rows{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:700px){ .exp-rows{ grid-template-columns:1fr 1fr } }
    .exp-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .exp-row .kv-label{ font-weight:700; font-size:14.5px; letter-spacing:.01em; margin-right:2px; }

    /* Chips (Locked style) */
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; font-size:14px; line-height:1;
      border:1.5px solid rgba(0,0,0,.22); border-radius:6px;
      background: rgba(255,255,255,.66); color:inherit; white-space:nowrap;
    }
    .chip.secondary {
      border:1px solid rgba(0,0,0,.16);
      background: rgba(0,0,0,.06);   /* slightly darker so it reads as secondary */
      font-size:13.5px;
    }
    .chip svg { width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; flex:0 0 auto; }

    /* Day blocks with chips (Locked layout) */
    .itinerary-days { max-width:900px; margin: 10px auto 0; }
    .day {
      padding: 18px 16px;
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 10px;
      background: rgba(255,255,255,.35);
      margin: 18px 0;
    }
    .day h3 { font-size: clamp(18px,3.2vw,24px); margin: 0 0 8px; letter-spacing: -0.01em; }
    .day .preview { margin: 2px 0 14px; color: rgba(30,30,30,.75); font-size: 16.5px; line-height: 1.6; }
    .kv-row { display:flex; align-items:center; gap:12px; padding:8px 0; border-top:1px dashed rgba(0,0,0,.08); }
    .kv-row:first-of-type { border-top:0; }
    .kv-label { flex:0 0 210px; font-weight:700; font-size:14.5px; letter-spacing:.01em; white-space:nowrap; }
    @media (max-width:720px){ .kv-label{ flex-basis:150px } }
    @media (max-width:520px){
      .kv-row{ flex-direction:column; align-items:flex-start; gap:6px }
      .kv-label{ width:100%; flex-basis:100% }
    }

    .embed{ aspect-ratio:16/9 } .embed iframe{ width:100%; height:100%; border:0; display:block }

    .gpx-actions{ margin-top:14px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:12px 18px; font-weight:700; border-radius:28px; text-decoration:none; border:1px solid rgba(0,0,0,.12); background:var(--paper); }
    #gpxBtn{ background:#000; color:#fff; border-color:#000; }

    @media (max-width:810px){ .value{ font-size:clamp(18px,4.6vw,24px) } }
    @media (max-width:480px){
      .page{ padding:20px 20px 32px }
      .grid2{ grid-template-columns:1fr 1fr }
      .embed{ aspect-ratio:3/4 }
      .credit{ font-size:13px }
      .mission{ padding:0 12px }
    }

    #status{ font-size:12px; opacity:.7; max-width:720px; margin:0 auto; }
  </style>
</head>
<body>
  <!-- inline neutral icon sprite (you can swap to Tabler later) -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
    <!-- top actions -->
    <symbol id="i-bookmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M7 3h10a2 2 0 0 1 2 2v16l-7-4-7 4V5a2 2 0 0 1 2-2z"/>
    </symbol>
    <symbol id="i-share" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.6 13.5l6.8 3.9M15.4 6.6L8.6 10.5"/>
    </symbol>
    <symbol id="i-print" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M6 9V3h12v6"/><rect x="6" y="13" width="12" height="8" rx="2"/><path d="M6 17h12"/><path d="M18 9h1a3 3 0 0 1 3 3v1H2v-1a3 3 0 0 1 3-3h1"/>
    </symbol>

    <!-- meta labels -->
    <symbol id="i-compass" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"/><path d="M15.5 8.5l-3.6 1.5-1.5 3.6 3.6-1.5z"/>
    </symbol>
    <symbol id="i-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4 12H2M22 12h-2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/>
    </symbol>
    <symbol id="i-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 21s-6-5.2-6-9.8A6 6 0 1 1 18 11.2C18 15.8 12 21 12 21z"/><circle cx="12" cy="11.2" r="2.4"/>
    </symbol>
    <symbol id="i-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/>
    </symbol>

    <!-- chips (locked set used in itinerary + days) -->
    <symbol id="c-distance" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="5" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><path d="M7 12h10"></path>
    </symbol>
    <symbol id="c-elevation" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 17l6-6 4 4 8-8"></path><path d="M12 7v-3"></path><path d="M12 20v-3"></path>
    </symbol>
    <symbol id="c-campsite" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 20h18L12 4 3 20z"></path>
    </symbol>
    <symbol id="c-trail" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 3v18"></path><path d="M7 6h10l-2-3H9z"></path><path d="M17 13H7l2 3h6z"></path>
    </symbol>
    <symbol id="c-terrain" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 20l7-12 4 6 3-4 4 10H3z"></path>
    </symbol>
    <symbol id="c-water" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 3c-4 5-6 8-6 11a6 6 0 0 0 12 0c0-3-2-6-6-11z"></path>
    </symbol>
    <symbol id="c-safety" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 3l7 4v5c0 5-3.5 8-7 9-3.5-1-7-4-7-9V7l7-4z"></path><path d="M9.5 12.5l2 2 3.5-3.5"></path>
    </symbol>
    <symbol id="c-decision" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M6 20c0-4 4-6 8-6h4"></path><path d="M6 4h4"></path><path d="M18 4h-4v6"></path>
    </symbol>
    <symbol id="c-morale" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="7" width="18" height="13" rx="2"></rect><circle cx="12" cy="13.5" r="3.5"></circle><path d="M8 7l2-3h4l2 3"></path>
    </symbol>
    <symbol id="c-gps" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="2"></circle>
      <path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.9 4.9l2.1 2.1M17 17l2.1 2.1M4.9 19.1l2.1-2.1M17 7l2.1-2.1"/>
    </symbol>
    <symbol id="c-objective" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2v20"></path><path d="M12 6l4 3-4 3-4-3 4-3z"></path>
    </symbol>
  </svg>

  <div class="page">
    <div id="status">Loading…</div>

    <h1 id="title" class="title"></h1>

    <!-- APPROVED ACTIONS -->
    <div class="actions" aria-label="Page actions">
      <button id="btnBookmark" class="btn-ghost" type="button">
        <svg class="ico"><use href="#i-bookmark"/></svg><span>Bookmark</span>
      </button>
      <button id="btnShare" class="btn-ghost" type="button">
        <svg class="ico"><use href="#i-share"/></svg><span>Share</span>
      </button>
      <button id="btnPrint" class="btn-ghost" type="button">
        <svg class="ico"><use href="#i-print"/></svg><span>Print</span>
      </button>
    </div>

    <!-- APPROVED META GRID -->
    <div class="grid2">
      <div>
        <div class="label with-icon">
          <svg class="ico" aria-hidden="true"><use href="#i-compass"/></svg><span>Category</span>
        </div>
        <div id="category" class="value"></div>
      </div>
      <div>
        <div class="label with-icon">
          <svg class="ico" aria-hidden="true"><use href="#i-sun"/></svg><span>Season</span>
        </div>
        <div id="season" class="value"></div>
      </div>
      <div>
        <div class="label with-icon">
          <svg class="ico" aria-hidden="true"><use href="#i-pin"/></svg><span>Location</span>
        </div>
        <div id="location" class="value"></div>
      </div>
      <div>
        <div class="label with-icon">
          <svg class="ico" aria-hidden="true"><use href="#i-calendar"/></svg><span>Date</span>
        </div>
        <div id="date" class="value"></div>
      </div>
    </div>

    <div class="fullbleed">
      <a id="heroLink" href="#" target="_blank" rel="noopener noreferrer" aria-label="Photo credit link">
        <img id="hero" alt="Expedition hero" />
      </a>
      <div id="credit" class="credit"></div>
    </div>

    <!-- Non-day text (will render here) -->
    <div id="mission" class="mission"></div>

    <!-- Expedition Itinerary chips (new) -->
    <section id="expItin" class="exp-itin" style="display:none">
      <h2>Expedition Itinerary</h2>
      <div class="exp-rows" id="expRows"></div>
    </section>

    <!-- Day blocks with chips (new) -->
    <div id="itineraryDays" class="itinerary-days"></div>

    <!-- Map / GPX embeds (unchanged) -->
    <div class="embed">
      <iframe id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>

    <div class="embed" id="gpxEmbedWrap">
      <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
    <div class="gpx-actions" id="gpxActions">
      <a id="gpxBtn" class="btn" href="#" download>DOWNLOAD GPX</a>
      <a id="gpxStudioLink" class="btn" href="#" target="_blank" rel="noopener">Open in GPX Studio</a>
      <span id="trailheads" style="opacity:.7"></span>
    </div>
  </div>

  <p class="gpx-note" style="text-align:center; font-size:14px; opacity:.75; margin:6px 0 0;">
    Starter GPX — review and adjust in your mapping app.<br>
    <strong>Do not rely on it as your only navigation source.</strong>
  </p>

  <script>
    /* ---- actions: bookmark/share/print ---- */
    (function(){
      const key = 'ei_bookmarks';
      const btnBm = document.getElementById('btnBookmark');
      const btnShare = document.getElementById('btnShare');
      const btnPrint = document.getElementById('btnPrint');

      const url = location.href.split('#')[0];
      const titleEl = document.getElementById('title');

      function getSet(){
        try{ return new Set(JSON.parse(localStorage.getItem(key)||'[]')); }
        catch{ return new Set(); }
      }
      function saveSet(set){
        try{ localStorage.setItem(key, JSON.stringify([...set])); }catch{}
      }
      function updateBmState(){
        const set = getSet();
        const active = set.has(url);
        btnBm.dataset.active = active ? 'true' : 'false';
        btnBm.querySelector('span').textContent = active ? 'Bookmarked' : 'Bookmark';
      }
      btnBm.addEventListener('click', () => {
        const set = getSet();
        if(set.has(url)) set.delete(url); else set.add(url);
        saveSet(set); updateBmState();
      });
      btnShare.addEventListener('click', async () => {
        const title = document.title || (titleEl?.textContent?.trim()) || 'Expedition';
        if (navigator.share) {
          try{ await navigator.share({ title, url }); }catch{}
        } else {
          try{
            await navigator.clipboard.writeText(url);
            btnShare.querySelector('span').textContent = 'Link copied';
            setTimeout(()=>btnShare.querySelector('span').textContent='Share', 1400);
          }catch{}
        }
      });
      btnPrint.addEventListener('click', () => window.print());
      updateBmState();
    })();
  </script>

  <!-- data fetch + render -->
  <script>
    const $ = (id) => document.getElementById(id);
    const qp = (k) => new URL(location.href).searchParams.get(k);
    const get = (o,p)=>p.split('.').reduce((a,c)=>a?.[c],o);
    const first = (o,keys)=>{ for(const k of keys){ const v=get(o,k); if(typeof v==="string"&&v.trim()) return v.trim(); if(v) return v; } return ""; };

    function getSlug(){
      const q = qp("slug"); if (q) return q;
      const parts = (location.pathname||"/").split("/").filter(Boolean);
      const i = parts.findIndex(p=>p.toLowerCase()==="expedition" || p.toLowerCase()==="trip");
      return i>-1 ? parts[i+1] : null;
    }

    const MAPBOX_TOKEN = "pk.eyJ1IjoiZXhwZWQtaW50ZWwiLCJhIjoiY21kc3Vrc2FtMHZkNjJrcTN6ajlmZzhlMyJ9.APi1rguilYM8GZKBnbyWFg";
    function gpxStudioURL(gpxUrl){
      if(!gpxUrl) return "";
      const options = { token: MAPBOX_TOKEN, files: [ gpxUrl ], distanceUnits: "imperial" };
      return "https://gpx.studio/embed?options=" + encodeURIComponent(JSON.stringify(options));
    }

    function safeParse(text){
      try{
        let x = JSON.parse(text);
        if (typeof x === "string") {
          try { x = JSON.parse(x); } catch {}
        }
        return x;
      }catch{ return null; }
    }

    function normalizeData(raw){
      if (typeof raw === "string") {
        const again = safeParse(raw);
        if (again) raw = again;
      }
      if (raw && (raw.schema_version || raw.hero_image || raw.image_link || raw.mission_text)) return raw;
      let full = null, flat = null;
      if (typeof raw?.index_json === "string") { full = safeParse(raw.index_json); }
      else if (raw?.index_json && typeof raw.index_json === "object") { full = raw.index_json; }
      if (typeof raw?.flat_json === "string") { flat = safeParse(raw.flat_json); }
      else if (raw?.flat_json && typeof raw.flat_json === "object") { flat = raw.flat_json; }
      let out = { ...(full || {}), ...(flat || {}) };
      if (out && !out.image_link) out.image_link = out.imageLink || out.credit_link || out.image_credit_link || "";
      if (out && !out.image_credit) out.image_credit = out.imageCredit || out.photo_credit || "";
      if (out && !out.hero_image) out.hero_image = out.hero?.url || out.image || out.heroImage || "";
      return Object.keys(out).length ? out : raw;
    }

    const isValidUnsplashPhoto = (u)=>{
      try{
        const x = new URL(u);
        return x.hostname === "unsplash.com" && /^\/photos\/[A-Za-z0-9_-]+/.test(x.pathname);
      }catch{ return false; }
    };

    /* ---------- CHIP RENDER HELPERS (locked) ---------- */
    const CHIP_SVG = {
      distance: '<svg><use href="#c-distance"/></svg>',
      elevation: '<svg><use href="#c-elevation"/></svg>',
      campsite : '<svg><use href="#c-campsite"/></svg>',
      trail    : '<svg><use href="#c-trail"/></svg>',
      terrain  : '<svg><use href="#c-terrain"/></svg>',
      water    : '<svg><use href="#c-water"/></svg>',
      safety   : '<svg><use href="#c-safety"/></svg>',
      decision : '<svg><use href="#c-decision"/></svg>',
      morale   : '<svg><use href="#c-morale"/></svg>',
      gps      : '<svg><use href="#c-gps"/></svg>',
      objective: '<svg><use href="#c-objective"/></svg>'
    };

    function chipHTML(key, text, secondary=false){
      const svg = CHIP_SVG[key] || '';
      return `<span class="chip${secondary?' secondary':''}">${svg}${text}</span>`;
    }

    function splitMission(m){
      const lines = m.split(/\r?\n/);
      const days = []; let pre = []; let cur = null;
      const isDay = (t)=>/^DAY\s*\d+:/i.test(t);

      for(const raw of lines){
        const t = raw.trim(); if(!t) continue;
        if(/^-{3,}$/.test(t)) continue; // ignore separators

        if(isDay(t)){ if(cur) days.push(cur); cur = { title:t, preview:"", bullets:[] }; continue; }

        if(cur){
          if(!/^[-–]\s+/.test(t) && !cur.preview){ cur.preview = t; continue; }
          const m = t.match(/^[-–]\s*([^:]+):\s*(.*)$/);
          if(m) cur.bullets.push({ label:m[1].trim(), value:m[2].trim() });
          else  cur.bullets.push({ label:"", value:t });
        }else{
          pre.push(t);
        }
      }
      if(cur) days.push(cur);
      return { preText: pre.join("\n"), days };
    }

    function chipKeyForDay(label){
      const L = (label||"").toLowerCase();
      if (L.startsWith("distance")) return "distance";
      if (L.includes("gain") || L.includes("loss")) return "elevation";
      if (L.startsWith("campsite")) return "campsite";
      if (L.startsWith("primary trail")) return "trail";
      if (L.startsWith("terrain")) return "terrain";
      if (L.startsWith("water") || L.startsWith("key water")) return "water";
      if (L.startsWith("safety")) return "safety";
      if (L.startsWith("decision")) return "decision";
      if (L.startsWith("morale")) return "morale";
      return null;
    }

    function renderDay(day){
      const primOrder = ["distance","elevation","campsite"];
      const primary = {}; const secondary = [];

      for(const b of day.bullets){
        const key = chipKeyForDay(b.label);
        if(!key) continue;
        if(primOrder.includes(key) && !primary[key]) primary[key] = b.value;
        else secondary.push({ key, value: b.value, label: b.label });
      }

      let html = `<section class="day">`;
      html += `<h3>${day.title.replace(/^DAY\s*/i,"DAY ")}</h3>`;
      if(day.preview) html += `<p class="preview">${day.preview}</p>`;

      for(const k of primOrder){
        if(!primary[k]) continue;
        const labelText = (k==="distance") ? "Distance"
                       : (k==="elevation") ? "Elevation Gain/Loss"
                       : "Campsite";
        html += `<div class="kv-row"><div class="kv-label">${labelText}:</div><div class="kv-value">${chipHTML(k, primary[k], false)}</div></div>`;
      }

      const secMap = {
        trail:"Primary trail(s)", terrain:"Terrain", water:"Water",
        safety:"Safety", decision:"Decision point", morale:"Morale marker"
      };
      for(const s of secondary){
        const labelText = secMap[s.key] || (s.label||"Info");
        html += `<div class="kv-row"><div class="kv-label">${labelText}:</div><div class="kv-value">${chipHTML(s.key, s.value, true)}</div></div>`;
      }

      html += `</section>`;
      return html;
    }

    /* Parse expedition itinerary info from preText (before the first DAY) */
    function parseExpeditionItinerary(preText){
      // capture key lines into map
      const out = {};
      const add = (k,v)=>{ if(v && !out[k]) out[k]=v; };
      const lines = preText.split(/\r?\n/).map(t=>t.trim()).filter(Boolean);

      for(const t of lines){
        const m = t.match(/^([^:]+):\s*(.*)$/);
        if(m){
          const key = m[1].toLowerCase();
          const val = m[2].trim();
          if(key.startsWith('primary objective')) add('objective', val);
          else if(key.startsWith('trip duration')) add('duration', val);
          else if(key.startsWith('total estimated mileage')) add('mileage', val);
          else if(key.startsWith('experience level')) add('experience', val);
          else if(key.startsWith('terrain type')) add('terrain', val);
          else if(key.includes('cumulative elevation')) add('elevation', val);
          else if(key.startsWith('start and end trailhead')) add('trailheads', val);
          else if(key.startsWith('gps coordinates')) add('gps', val);
          else if(key.startsWith('expedition itinerary')) add('title', val);
        }
      }
      return out;
    }

    function renderExpeditionChips(info){
      const rows = [];

      // Row 1: Distance / Elevation / GPS
      const r1 = [];
      if(info.mileage)   r1.push(chipHTML('distance', info.mileage));
      if(info.elevation) r1.push(chipHTML('elevation', info.elevation));
      if(info.gps)       r1.push(chipHTML('gps', info.gps));
      if(r1.length) rows.push({label:'Route Stats', chips:r1});

      // Row 2: Objective / Terrain
      const r2 = [];
      if(info.objective) r2.push(chipHTML('objective', info.objective));
      if(info.terrain)   r2.push(chipHTML('terrain', info.terrain));
      if(r2.length) rows.push({label:'Profile', chips:r2});

      // Row 3: Trailheads (secondary chip)
      const r3 = [];
      if(info.trailheads) r3.push(chipHTML('trail', info.trailheads, true));
      if(r3.length) rows.push({label:'Start / End', chips:r3});

      return rows.map(row => {
        return `<div class="exp-row"><div class="kv-label">${row.label}:</div><div class="kv-chips">${row.chips.join(' ')}</div></div>`;
      }).join('');
    }

    async function main(){
      const status = $("status");
      const slug = getSlug();
      if(!slug){ status.textContent="Missing slug (?slug= or /expedition/{slug})"; return; }

      const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json?cb=${Date.now()}`;
      status.textContent = "Fetching…";

      let data;
      try{
        const res = await fetch(jsonURL, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        let raw = safeParse(text);
        if (raw === null) raw = {};
        data = normalizeData(raw);
      }catch(e){
        status.textContent = "Fetch failed: "+e.message;
        return;
      }

      $("title").textContent = first(data,["title","name"]) || "";
      $("category").textContent = first(data,["category","type"]) || "";
      $("season").textContent = first(data,["season"]) || "";
      $("location").textContent = first(data,["location","place"]) || "";
      const d = first(data,["date","when"]);
      $("date").textContent = /^\d{4}-\d{2}-\d{2}$/.test(d)
        ? new Date(d+"T00:00:00Z").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"})
        : (d||"");

      const hero = first(data,["hero_image","hero.url","image"]);
      if (hero) $("hero").src = hero;

      const creditName = first(data,["image_credit","credit","photo_credit"]) || "";
      let creditLink = first(data,["image_link","credit_link","image_credit_link"]) || "";
      if (!isValidUnsplashPhoto(creditLink)) creditLink = "";
      $("credit").innerHTML = creditName
        ? (creditLink
            ? `<a href="${creditLink}" target="_blank" rel="noopener noreferrer" title="${creditLink}">${creditName}</a>`
            : creditName)
        : "";
      const heroLinkEl = $("heroLink");
      if (heroLinkEl) {
        if (creditLink) {
          heroLinkEl.href = creditLink;
          heroLinkEl.style.pointerEvents = "auto";
        } else {
          heroLinkEl.removeAttribute("href");
          heroLinkEl.style.pointerEvents = "none";
        }
      }

      /* --------- build pre-text + days --------- */
      const mission = first(data,["mission_text","mission","brief","summary"]) || "";
      const { preText, days } = splitMission(mission);

      // Render preText (simple bold treatment for all-caps labels)
      const formattedPre = preText
        .split(/\r?\n/)
        .map(line => {
          const t = line.trim(); if(!t) return "";
          if (/^-{3,}$/.test(t)) return "";
          const m = t.match(/^([^:]+):\s*(.*)$/);
          if (m && !/[a-z]/.test(m[1])) return `<strong>${m[1].trim()}:</strong> ${m[2]}`;
          if (!/[a-z]/.test(t)) return `<strong>${t}</strong>`;
          return t;
        })
        .join("<br/>");
      $("mission").innerHTML = formattedPre;

      // Expedition Itinerary chips (from preText)
      const itinInfo = parseExpeditionItinerary(preText);
      const expRows = renderExpeditionChips(itinInfo);
      if(expRows){
        $("expRows").innerHTML = expRows;
        $("expItin").style.display = "block";
      }

      // Days
      $("itineraryDays").innerHTML = days.map(renderDay).join("");

      // Map / GPX
      const mapURL = first(data,["map_embed_url","map_embed","map.url"]);
      if (mapURL) $("map").src = mapURL;

      const gpxURL = first(data,["gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"]);
      if (gpxURL) {
        const studio = gpxStudioURL(gpxURL);
        $("gpxStudio").src = studio;
        $("gpxStudioLink").href = studio;
        $("gpxBtn").href = gpxURL;
        $("gpxBtn").download = (slug||"route") + ".gpx";
        const th = [first(data,["start_trailhead","start"]), first(data,["end_trailhead","end"])].filter(Boolean).join(" → ");
        if (th) $("trailheads").textContent = th;
      } else {
        $("gpxEmbedWrap").innerHTML = `<div style="opacity:.7;font-size:14px">No GPX URL found (expected <code>gpx_download_link</code>).</div>`;
        $("gpxActions").style.display = "none";
      }

      $("status").textContent = "";
      setTimeout(()=>$("status").remove(), 10);
    }

    if (typeof window !== "undefined") main();
  </script>
</body>
</html>
