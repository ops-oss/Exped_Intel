<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Expedition – Preview</title>

<!-- Fonts + sprite preload -->
<link rel="stylesheet" href="/fonts.css"/>
<link rel="preload" href="/assets/icons.svg?v=4" as="image" type="image/svg+xml"/>

<style>
  :root{
    --bg:#e8e5e2; --ink:#1e1e1e; --paper:#fff; --accent:#fe5733;
    --label:14px; --body:18px; --h1:clamp(40px,18vw,88px);
    --border:rgba(0,0,0,.12); --tint:rgba(0,0,0,.06);
    --chip-border:rgba(0,0,0,.22); --chip-fill:rgba(255,255,255,.66);
    --chip2-border:rgba(0,0,0,.16); --chip2-fill:rgba(0,0,0,.06);
    --label-w:210px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family:"Poppins",system-ui,-apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  img{display:block;width:100%;height:auto}
  a{color:inherit;text-underline-offset:2px}
  .page{max-width:1120px;margin:0 auto;padding:24px 16px 40px;display:grid;row-gap:20px}
  .title{font-size:var(--h1);line-height:1.02;font-weight:700;letter-spacing:-0.02em}
  .actions{display:flex;gap:18px;flex-wrap:wrap}
  .btn-ghost{display:inline-flex;align-items:center;gap:10px;padding:12px 18px;background:transparent;color:inherit;border:1px solid var(--border);border-radius:8px;font-weight:600;text-decoration:none;cursor:pointer}
  .btn-ghost .ico{width:20px;height:20px;stroke:currentColor}
  .btn-ghost[data-active="true"]{background:var(--paper)}
  .label{font-size:var(--label);letter-spacing:.18em;text-transform:uppercase;opacity:.7}
  .label.with-icon{display:flex;align-items:center;gap:.45rem}
  .label .ico{width:clamp(16px,1.6vw,20px);height:clamp(16px,1.6vw,20px);stroke:currentColor;opacity:.9;flex:0 0 auto}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px 28px;align-items:start;margin-top:8px}
  @media (min-width:960px){.grid2{grid-template-columns:repeat(4,1fr)}}
  .value{font-size:clamp(18px,2.6vw,28px);line-height:1.28}
  .fullbleed{width:100vw;margin-left:calc(50% - 50vw)}
  #heroLink{display:block}
  .credit{text-align:right;font-size:14px;margin-top:8px;color:var(--accent);padding-right:16px}
  .credit a{text-decoration:underline;cursor:pointer}
  .section{margin-top:26px}
  .section h3{font-size:clamp(18px,2.2vw,22px);margin:0 0 10px;font-weight:700;letter-spacing:-0.01em}
  .kv{display:grid;grid-template-columns:minmax(12ch,1fr) minmax(0,2fr);row-gap:.75rem;column-gap:1rem;align-items:start;grid-auto-rows:minmax(1.6em,auto)}
  .kv .k{font-weight:700;line-height:1.45}
  .kv .v{line-height:1.45;overflow-wrap:anywhere;word-break:break-word;hyphens:auto}
  .kv.single{grid-template-columns:1fr}
  .kv.single .v{grid-column:1 / -1}
  .embed{aspect-ratio:16/9}
  @media (max-width:640px){ .embed{aspect-ratio:3/4} }
  .embed iframe{width:100%;height:100%;border:0;display:block}
  .gpx-actions{margin-top:14px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 18px;font-weight:700;border-radius:28px;text-decoration:none;border:1px solid var(--border);background:#000;color:#fff}
  .btn .ico{width:20px;height:20px}
  .gpx-note{font-size:14px;text-align:center;max-width:720px;margin:6px auto 0;opacity:.95}
  .row{display:flex;align-items:center;gap:12px;padding:8px 0;border-top:1px dashed rgba(0,0,0,.08)}
  .row:first-of-type{border-top:0}
  .row .labelB{flex:0 0 var(--label-w);font-weight:700;font-size:14.5px;letter-spacing:.01em;white-space:nowrap}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;font-size:14px;line-height:1;border:1.5px solid var(--chip-border);border-radius:6px;background:var(--chip-fill);color:var(--ink);white-space:nowrap}
  .chip.secondary{border:1px solid var(--chip2-border);background:var(--chip2-fill);font-size:13.5px}
  .chip svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex:0 0 auto}
  .day{padding:18px 16px;border:1px solid rgba(0,0,0,.08);border-radius:10px;background:rgba(255,255,255,.35);margin:18px 0}
  .day h4{font-size:clamp(18px,3.2vw,24px);margin:0 0 8px;letter-spacing:-0.01em}
  .day .preview{margin:2px 0 14px;color:rgba(30,30,30,.75);font-size:16.5px;line-height:1.6}
  @media (max-width:720px){ :root{--label-w:150px} }
  @media (max-width:520px){
    :root{--label-w:100%}
    .row{flex-direction:column;align-items:flex-start;gap:6px}
    .row .labelB{width:100%}
  }
  #status{font-size:12px;opacity:.7;max-width:720px;margin:0 auto}

  /* ===== POLISH OVERRIDES ===== */
  :root{
    --hdr-size-min: 24px; --hdr-size-max: 32px; --hdr-letter: -0.02em; --hdr-weight: 700; --hdr-var: 720; --hdr-bottom: 22px;
    --div: rgba(0,0,0,.10); --div-soft: rgba(0,0,0,.06);
    --page-pad-sm: 20px;
    --toc-accent: var(--accent, #fe5733); --toc-ink: var(--ink, #1e1e1e);
    --toc-border: rgba(0,0,0,.12); --toc-bg: color-mix(in srgb, var(--paper, #fff) 86%, transparent);
    --toc-panel-w: min(420px, 86vw); --toc-top-pad: 14px; --toc-right-pad: 16px;
  }
  .section{ margin-top:34px; padding-top:18px; border-top:1px solid var(--div); }
  .section>h3{ font-size:clamp(var(--hdr-size-min),4.8vw,var(--hdr-size-max)); line-height:1.18; letter-spacing:var(--hdr-letter); margin:0 0 var(--hdr-bottom); font-weight:var(--hdr-weight); font-variation-settings:"wght" var(--hdr-var); scroll-margin-top:80px; color: color-mix(in srgb, var(--ink) 92%, #000); }
  .kv{ column-gap:1rem; row-gap:1rem; } .kv .k{ font-weight:700; opacity:.9; padding-block:6px; } .kv .v{ opacity:.98; padding-block:6px; } .kv>:nth-child(n+3){ border-top:1px dashed var(--div-soft); }
  .day{ margin:20px 0; border-radius:12px; background:rgba(255,255,255,.38); }
  .row{ padding:10px 0; } .chip{ line-height:1.1; }
  @media (max-width:520px){ .page{ padding-inline:var(--page-pad-sm); } .section{ margin-top:32px; padding-top:14px; } .section>h3{ margin-bottom:24px; } }
  @media (min-width:960px){ .section{ margin-top:42px; padding-top:20px; border-top:1px solid rgba(0,0,0,.11); } }
  @media (prefers-reduced-motion:reduce){ *{ animation-duration:.01ms!important; transition-duration:.01ms!important; } }
  @media print{ .section, .day{ break-inside:avoid; } h3{ break-after:avoid; } .ei-toc-toggle, .ei-toc-panel, .ei-toc-dim{ display:none!important; } }

  /* Hero: mobile */
  @media (max-width:640px){
    .fullbleed{ width:90vw; margin-left:calc(50% - 50vw); }
    #hero{ width:90vw; height:100svh; object-fit:cover; display:block; }
  }

  /* TOC chip style */
  .ei-toc-toggle{ position:fixed; top:14px; right:16px; z-index:999; width:34px; height:34px; border-radius:8px; background:rgba(255,255,255,.55); backdrop-filter:saturate(120%) blur(2px); border:1px solid var(--chip2-border); display:grid; place-items:center; cursor:pointer; }
  .ei-toc-toggle .lines{ position:relative; width:20px; height:14px; }
  .ei-toc-toggle .lines::before,.ei-toc-toggle .lines::after{ content:""; position:absolute; left:0; right:0; height:2px; background: currentColor; border-radius:2px; transition: transform .18s ease, opacity .18s ease; }
  .ei-toc-toggle .lines::before{ top:0; } .ei-toc-toggle .lines::after{ bottom:0; }
  .ei-open .ei-toc-toggle .lines::before{ transform: translateY(6px) rotate(45deg); }
  .ei-open .ei-toc-toggle .lines::after{ transform: translateY(-6px) rotate(-45deg); }
  .ei-toc-panel{ position:fixed; inset:0 0 0 auto; width:min(420px,86vw); transform:translateX(100%); background: color-mix(in srgb, var(--paper) 88%, transparent); border-left:1px solid var(--chip2-border); box-shadow:-16px 0 32px rgba(0,0,0,.06); z-index:998; transition:transform .22s ease; display:flex; flex-direction:column; gap:12px; padding:16px 14px; }
  .ei-open .ei-toc-panel{ transform:translateX(0); }
  .ei-toc-dim{ position:fixed; inset:0; background:rgba(0,0,0,.12); opacity:0; pointer-events:none; transition:opacity .22s ease; z-index:997; }
  .ei-open .ei-toc-dim{ opacity:1; pointer-events:auto; }
  .ei-toc-title{ font-weight:700; letter-spacing:-.01em; opacity:.85; margin:2px 4px 2px; }
  .ei-toc-list{ list-style:none; margin:0; padding:6px 2px; display:flex; flex-direction:column; gap:8px; }
  .ei-toc-list a{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; line-height:1.05; font-size:14px; font-weight:600; border:1.5px solid var(--chip-border); border-radius:6px; background: var(--chip-fill); color: color-mix(in srgb, var(--ink) 78%, #000); text-decoration:none; }
  .ei-toc-list a[aria-current="true"]{ border-color: color-mix(in srgb, var(--accent) 35%, var(--chip-border)); background: color-mix(in srgb, var(--accent) 10%, var(--chip-fill)); color: var(--ink); }
  .ei-toc-list a:focus-visible{ outline:2px solid var(--accent); outline-offset:2px; }
  *{ -webkit-tap-highlight-color: transparent; }
  .section>h3:focus{ outline:none; box-shadow:none; }

  /* Chips container */
  #expChips{ display:flex; flex-wrap:wrap; gap:10px 12px; margin-top:12px !important; }
  #expChips .chip{ margin:0; }
</style>
</head>
<body>
<div class="page">
  <div id="status">Loading…</div>
  <h1 id="title" class="title"></h1>

  <!-- Top actions -->
  <div class="actions">
    <button id="btnBookmark" class="btn-ghost">
      <svg class="ico"><use href="/assets/icons.svg?v=4#i-bookmark" xlink:href="/assets/icons.svg?v=4#i-bookmark"/></svg>
      <span>Bookmark</span>
    </button>
    <button id="btnShare" class="btn-ghost">
      <svg class="ico"><use href="/assets/icons.svg?v=4#i-share" xlink:href="/assets/icons.svg?v=4#i-share"/></svg>
      <span>Share</span>
    </button>
    <button id="btnPrint" class="btn-ghost">
      <svg class="ico"><use href="/assets/icons.svg?v=4#i-print" xlink:href="/assets/icons.svg?v=4#i-print"/></svg>
      <span>Print</span>
    </button>
  </div>

  <!-- Header grid -->
  <div class="grid2">
    <div>
      <div class="label with-icon">
        <svg class="ico"><use href="/assets/icons.svg?v=4#i-compass" xlink:href="/assets/icons.svg?v=4#i-compass"/></svg>
        <span>Category</span>
      </div>
      <div id="category" class="value"></div>
    </div>
    <div>
      <div class="label with-icon">
        <svg class="ico"><use href="/assets/icons.svg?v=4#i-sun" xlink:href="/assets/icons.svg?v=4#i-sun"/></svg>
        <span>Season</span>
      </div>
      <div id="season" class="value"></div>
    </div>
    <div>
      <div class="label with-icon">
        <svg class="ico"><use href="/assets/icons.svg?v=4#i-pin" xlink:href="/assets/icons.svg?v=4#i-pin"/></svg>
        <span>Location</span>
      </div>
      <div id="location" class="value"></div>
    </div>
    <div>
      <div class="label with-icon">
        <svg class="ico"><use href="/assets/icons.svg?v=4#i-calendar" xlink:href="/assets/icons.svg?v=4#i-calendar"/></svg>
        <span>Date</span>
      </div>
      <div id="date" class="value"></div>
    </div>
  </div>

  <!-- Hero -->
  <div class="fullbleed">
    <a id="heroLink" href="#" target="_blank" rel="noopener noreferrer"><img id="hero" alt="Expedition hero"/></a>
    <div id="credit" class="credit"></div>
  </div>

  <!-- Expedition Itinerary (summary chips) -->
  <section id="expItin" class="section" style="display:none">
    <h3>Expedition Itinerary</h3>
    <div id="expKV" class="kv"></div>
    <div id="expChips" style="margin-top:8px"></div>
  </section>

  <!-- ORDERED SECTIONS -->
  <section class="section"><h3>Permits & Entry</h3><div id="permits_entry"></div></section>

  <section class="section">
    <h3>Shuttle / Transportation</h3>
    <div id="shuttle_transportation"></div>
    <div class="embed" style="margin-top:10px"><iframe id="shuttle_map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
  </section>

  <section class="section"><h3>Permit & Shuttle Timeline</h3><div id="permit_timeline"></div></section>
  <section class="section"><h3>Multi-Trailhead Logistics</h3><div id="multi_trailhead"></div></section>
  <section class="section"><h3>Key Considerations</h3><div id="key_considerations"></div></section>

  <!-- DAYS -->
  <section class="section"><h3>Itinerary Overview</h3><div id="itineraryDays"></div></section>

  <!-- GPX -->
  <div class="section">
    <h3>GPX Route & Elevation</h3>
    <div class="embed" id="gpxEmbedWrap"><iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
    <div class="gpx-actions" id="gpxActions">
      <a id="gpxBtn" class="btn" href="#" download>
        <svg class="ico"><use href="/assets/icons.svg?v=4#i-download" xlink:href="/assets/icons.svg?v=4#i-download"/></svg>
        DOWNLOAD GPX
      </a>
      <a id="gpxStudioLink" class="btn" href="#" target="_blank" rel="noopener">
        <svg class="ico"><use href="/assets/icons.svg?v=4#i-external" xlink:href="/assets/icons.svg?v=4#i-external"/></svg>
        Open in GPX Studio
      </a>
      <span id="trailheads" style="opacity:.8"></span>
    </div>
    <div class="gpx-note">Starter GPX — review and adjust in your mapping app.<br/><strong>Do not rely on it as your only navigation source.</strong></div>
  </div>

  <!-- Text sections -->
  <section class="section"><h3>Campsite Intel</h3><div id="campsite_intel"></div></section>
  <section class="section"><h3>Weather & Altitude Notes</h3><div id="weather_altitude"></div></section>
  <section class="section"><h3>Gear Checklist</h3><div id="gear_checklist"></div></section>
  <section class="section"><h3>Optional Modification</h3><div id="optional_mod"></div></section>
  <section class="section"><h3>Risk Matrix & Hazard Timeline</h3><div id="risk_matrix"></div></section>
  <section class="section"><h3>Conditions Watch</h3><div id="conditions_watch"></div></section>
  <section class="section"><h3>Bailout Summary</h3><div id="bailout_summary"></div></section>
  <section class="section"><h3>Emergency Contacts & Numbers</h3><div id="emergency"></div></section>
  <section class="section"><h3>Final Brief Summary</h3><div id="final_brief"></div></section>
  <section class="section"><h3>Field Disclaimer</h3><div id="field_disclaimer"></div></section>
</div>

<script>
/* ---------- utils ---------- */
const $ = id => document.getElementById(id);
const safeParse = t => { try { return JSON.parse(t); } catch { return null; } };

/* ---------- chips: use the external sprite everywhere ---------- */
const SPRITE = '/assets/icons.svg?v=4';
const CHIP_SVG = {
  distance:  `<svg><use href="${SPRITE}#c-distance"  xlink:href="${SPRITE}#c-distance"/></svg>`,
  elevation: `<svg><use href="${SPRITE}#c-elevation" xlink:href="${SPRITE}#c-elevation"/></svg>`,
  campsite:  `<svg><use href="${SPRITE}#c-campsite"  xlink:href="${SPRITE}#c-campsite"/></svg>`,
  trail:     `<svg><use href="${SPRITE}#c-trail"     xlink:href="${SPRITE}#c-trail"/></svg>`,
  terrain:   `<svg><use href="${SPRITE}#c-terrain"   xlink:href="${SPRITE}#c-terrain"/></svg>`,
  water:     `<svg><use href="${SPRITE}#c-water"     xlink:href="${SPRITE}#c-water"/></svg>`,
  safety:    `<svg><use href="${SPRITE}#c-safety"    xlink:href="${SPRITE}#c-safety"/></svg>`,
  decision:  `<svg><use href="${SPRITE}#c-decision"  xlink:href="${SPRITE}#c-decision"/></svg>`,
  morale:    `<svg><use href="${SPRITE}#c-morale"    xlink:href="${SPRITE}#c-morale"/></svg>`,
  gps:       `<svg><use href="${SPRITE}#c-gps"       xlink:href="${SPRITE}#c-gps"/></svg>`
};
const chipHTML=(k,t,secondary=false)=>`<span class="chip${secondary?' secondary':''}">${CHIP_SVG[k]||''}${t}</span>`;

/* ---------- KV or paragraph-only renderer ---------- */
function kvOrParagraph(containerId, text){
  const el = $(containerId); 
  if(!el){ return; }
  if(!text){ el.innerHTML=''; return; }
  const lines = String(text).split(/\r?\n/).map(s => s.trim().replace(/^-\s*/, "")).filter(Boolean);
  const hasKV = lines.some(l => /^[^:]+:\s*\S/.test(l));
  if(hasKV){
    const rows=[];
    for(const l of lines){ const m=l.match(/^([^:]+):\s*(.*)$/); if(m){ rows.push(`<div class="k">${m[1]}</div><div class="v">${m[2]}</div>`); } }
    el.innerHTML = `<div class="kv">${rows.join('')}</div>`;
  }else{
    el.innerHTML = `<div class="kv single"><div class="v">${lines.join('<br/>')}</div></div>`;
  }
}

/* ---------- day + expedition render ---------- */
function renderDay(day){
  const title = (day.title || '').replace(/\s+TO\s+/gi, ' → ');
  let html = `<article class="day"><h4>${title}</h4>`;
  if(day.preview) html += `<p class="preview">${day.preview}</p>`;
  const prim=[["distance","Distance"],["elevation","Elevation Gain/Loss"],["campsite","Campsite"]];
  prim.forEach(([k,l])=>{ const v=day.chips?.[k]; if(v) html+=`<div class="row"><div class="labelB">${l}:</div><div>${chipHTML(k,v,false)}</div></div>`; });
  const secOrder=["trail","terrain","water","safety","decision","morale"];
  const labels={trail:"Primary trail(s)",terrain:"Terrain",water:"Key water sources",safety:"Safety",decision:"Decision point",morale:"Morale marker"};
  secOrder.forEach(k=>{ const v=day.chips?.[k]; if(v) html+=`<div class="row"><div class="labelB">${labels[k]}:</div><div>${chipHTML(k,v,true)}</div></div>`; });
  return html+`</article>`;
}
function renderExpeditionKV(info){
  const kv=$('expKV'); if(!kv) return; kv.innerHTML='';
  const add=(k,v)=>{ if(v) kv.insertAdjacentHTML('beforeend', `<div class="k">${k}</div><div class="v">${v}</div>`); };
  add("EXPEDITION ITINERARY", info.route||"Teton Crest Trail Traverse");
  add("PRIMARY OBJECTIVE", info.objective||"End-to-End Traverse");
  add("TRIP DURATION", info.duration||"");
  add("TOTAL ESTIMATED MILEAGE", info.mileage||"");
  add("EXPERIENCE LEVEL", info.experience||"");
  add("TERRAIN TYPE", info.terrain||"");
}
function renderExpeditionChips(info){
  const host=$('expChips'); if(!host) return;
  const chips=[];
  if(info.elevation) chips.push(chipHTML('elevation', info.elevation));
  if(info.trailheads) chips.push(chipHTML('trail', info.trailheads, true));
  if(info.gps) chips.push(chipHTML('gps', info.gps));
  host.innerHTML = chips.join(' ');
}

/* ---------- data loader ---------- */
const SUPABASE_BASE = 'https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/';
function computeSrc(){
  const qp=new URLSearchParams(location.search).get('src');
  if(qp) return qp;
  const m = location.pathname.match(/\/trip\/([^\/?#]+)\/?$/);
  const slug = m?.[1] || 'teton-crest-trail-expedition';
  return SUPABASE_BASE + encodeURIComponent(slug) + '.json';
}
async function loadData(){
  const url = computeSrc();
  console.log('EI JSON URL →', url);
  try{
    const res = await fetch(url,{cache:'no-store',headers:{accept:'application/json'}});
    if(!res.ok) throw new Error(`Fetch failed: ${res.status}`);
    const text = await res.text();
    const raw = safeParse(text) ?? {};
    return raw;
  }catch(err){
    console.warn('Falling back to inline JSON:', err);
    return safeParse(document.getElementById('ei-data')?.textContent)||{};
  }
}

/* ---------- Main ---------- */
(async ()=>{
  const status=$('status');
  let data={};
  try{ data = await loadData(); } catch(e){ console.error(e); status.textContent='Could not load expedition data.'; }

  data = inflateFromMission(data);

  // Title/meta
  $('title').textContent = data.title||'';
  document.title = data.title ? `Expedition – ${data.title}` : 'Expedition – Preview';
  $('category').textContent = data.category||'';
  $('season').textContent = data.season||'';
  $('location').textContent = data.location||'';
  const d=data.date||'';
  $('date').textContent = /^\d{4}-\d{2}-\d{2}$/.test(d) ? new Date(d+'T00:00:00Z').toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}) : d;

  // Hero + credit
  if(data.hero_image) $('hero').src = data.hero_image;
  const creditName=data.image_credit||''; const creditLink=data.image_link||'';
  $('credit').innerHTML = creditName ? (creditLink ? `<a href="${creditLink}" target="_blank" rel="noopener">${creditName}</a>` : creditName) : '';
  if(creditLink) { const a=$('heroLink'); a.href=creditLink; a.style.pointerEvents='auto'; } else { const a=$('heroLink'); a.removeAttribute('href'); a.style.pointerEvents='none'; }

  // Expedition itinerary
  const ei = data.expedition_itinerary||{};
  if(ei.route||ei.objective||ei.duration||ei.mileage||ei.experience||ei.terrain||ei.elevation||ei.trailheads||ei.gps){
    $('expItin').style.display='block';
    renderExpeditionKV(ei);
    renderExpeditionChips(ei);
  }

  // Ordered sections
  kvOrParagraph('permits_entry', data.permits_entry);
  kvOrParagraph('shuttle_transportation', data.shuttle_transportation);
  const mapURL = data.map_embed_url || data.shuttle_map_url || "";
  if (mapURL && $('shuttle_map')) $('shuttle_map').src = mapURL;
  kvOrParagraph('permit_timeline', data.permit_timeline);
  kvOrParagraph('multi_trailhead', data.multi_trailhead);
  kvOrParagraph('key_considerations', data.key_considerations);

  // Days
  const days = Array.isArray(data.days)?data.days:[];
  $('itineraryDays').innerHTML = days.map(renderDay).join('');

  // GPX
  const gpxURL=data.gpx_download_link||'';
  if(gpxURL){
    const studio="https://gpx.studio/embed?options="+encodeURIComponent(JSON.stringify({
      token:"pk.eyJ1IjoiZXhwZWQtaW50ZWwiLCJhIjoiY21kc3Vrc2FtMHZkNjJrcTN6ajlmZzhlMyJ9.APi1rguilYM8GZKBnbyWFg",
      files:[gpxURL],
      distanceUnits:"imperial"
    }));
    $('gpxStudio').src=studio; $('gpxStudioLink').href=studio; $('gpxBtn').href=gpxURL; $('gpxBtn').download=(data.slug||'route')+'.gpx';
    const th=[data.start_trailhead,data.end_trailhead].filter(Boolean).join(' → ');
    if(th) $('trailheads').textContent=th;
  }else{
    $('gpxEmbedWrap').innerHTML=`<div style="opacity:.7;font-size:14px">No GPX URL set.</div>`;
    $('gpxActions').style.display='none';
  }

  // Remaining text sections
  kvOrParagraph('campsite_intel', data.campsite_intel);
  kvOrParagraph('weather_altitude', data.weather_altitude);
  kvOrParagraph('gear_checklist', data.gear_checklist);
  kvOrParagraph('optional_mod', data.optional_mod);
  kvOrParagraph('risk_matrix', data.risk_matrix);
  kvOrParagraph('conditions_watch', data.conditions_watch);
  kvOrParagraph('bailout_summary', data.bailout_summary);
  kvOrParagraph('emergency', data.emergency);
  kvOrParagraph('final_brief', data.final_brief);
  kvOrParagraph('field_disclaimer', data.field_disclaimer);

  function hideTrulyEmptySections(){
    document.querySelectorAll('.section').forEach(s=>{
      if (s.querySelector('#gpxEmbedWrap')) return; // Never hide GPX
      const hasContent = Array.from(s.querySelectorAll('div[id]')).some(n=>{
        return n.innerText.trim() || n.querySelector('iframe, a, .chip');
      });
      if (!hasContent) s.style.display = 'none';
    });
  }
  hideTrulyEmptySections();

  status.textContent=''; setTimeout(()=>status.remove(),10);
})();

/* ===== In-page nav builder (unchanged) ===== */
(() => {
  const heads = [...document.querySelectorAll('.section > h3')];
  if (!heads.length) return;

  const sections = heads.map(h3 => {
    let id = h3.id || h3.textContent.trim().toLowerCase()
      .replace(/[^a-z0-9\s\-&]+/g,'')
      .replace(/\s*&\s*/g,'-and-')
      .replace(/\s+/g,'-');
    if (!id) id = 'sec-' + Math.random().toString(36).slice(2,7);
    if (document.getElementById(id) && h3.id !== id) { id += '-' + Math.random().toString(36).slice(2,4); }
    h3.id = id;
    if (!h3.hasAttribute('tabindex')) h3.setAttribute('tabindex','-1');
    return { id, title: h3.textContent.trim() };
  });

  const btn = document.createElement('button');
  btn.className = 'ei-toc-toggle';
  btn.type = 'button';
  btn.setAttribute('aria-label','Open section menu');
  btn.innerHTML = '<span class="lines" aria-hidden="true"></span>';

  const panel = document.createElement('aside');
  panel.className = 'ei-toc-panel';
  panel.setAttribute('aria-label','Sections');
  panel.innerHTML = '<div class="ei-toc-title">Sections</div><ul class="ei-toc-list" role="list"></ul>';

  const dim = document.createElement('div'); dim.className = 'ei-toc-dim';

  const ul = panel.querySelector('.ei-toc-list');
  sections.forEach(({id, title}) => {
    const li = document.createElement('li'); const a = document.createElement('a');
    a.href = '#'+id; a.textContent = title; a.addEventListener('click', () => close(true));
    li.appendChild(a); ul.appendChild(li);
  });

  document.body.append(btn, panel, dim);

  const open = () => { document.documentElement.classList.add('ei-open'); btn.setAttribute('aria-label','Close section menu'); (panel.querySelector('a[aria-current="true"]') || panel.querySelector('a'))?.focus(); };
  const close = (focusHeading) => { document.documentElement.classList.remove('ei-open'); btn.setAttribute('aria-label','Open section menu'); if (focusHeading) setTimeout(() => document.getElementById(location.hash.slice(1))?.focus?.(), 250); };

  btn.addEventListener('click', () => document.documentElement.classList.contains('ei-open') ? close() : open());
  dim.addEventListener('click', () => close());
  window.addEventListener('keydown', e => { if (e.key === 'Escape') close(); });

  const links = [...panel.querySelectorAll('a')];
  const byId = Object.fromEntries(sections.map(s => [s.id, links.find(a => a.hash === '#'+s.id)]));
  const io = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      const link = byId[entry.target.id];
      if (!link) return;
      if (entry.isIntersecting) { links.forEach(a => a.removeAttribute('aria-current')); link.setAttribute('aria-current','true'); }
    });
  }, { rootMargin: '-45% 0px -45% 0px', threshold: [0, 0.001] });
  heads.forEach(h => io.observe(h));
})();
</script>

<!-- Instant sample JSON (unchanged) -->
<script id="ei-data" type="application/json">
{ ... your sample JSON unchanged ... }
</script>
</body>
</html>
