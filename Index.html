<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Expedition</title>

  <link rel="stylesheet" href="/fonts.css"/>

  <style>
    :root{
      --bg: rgb(232,229,226);
      --ink: rgb(30,30,30);
      --paper: #fff;
      --accent: rgb(254,87,51);
      --muted: rgba(30,30,30,.58);
      --line: rgba(30,30,30,.16);
      --chip: rgba(0,0,0,.045);
      --font-sans: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;
      --h1: clamp(40px,18vw,88px);
      --label: 14px;
      --body: 18px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink); font-family:var(--font-sans);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    img{ display:block; width:100%; height:auto }
    a{ color:inherit; text-underline-offset:2px }

    .page{ max-width:1120px; margin:0 auto; padding:24px 16px 40px; display:grid; row-gap:22px }
    .title{ font-size:var(--h1); line-height:1.02; font-weight:700; letter-spacing:-.02em }

    .label{ font-size:var(--label); letter-spacing:.18em; text-transform:uppercase; opacity:.72; display:inline-flex; align-items:center; gap:8px }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:16px 28px; align-items:start; margin-top:8px }
    @media (min-width:960px){ .grid2{ grid-template-columns:repeat(4,1fr) } }
    .value{ font-size:clamp(18px,2.6vw,28px); line-height:1.28 }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:6px 0 4px }
    .btn-ghost{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
      font-weight:600; background:transparent; border:1px solid var(--line); color:var(--ink);
      border-radius:8px; cursor:pointer;
    }
    .btn-ghost:hover{ background:rgba(0,0,0,.04) }
    .btn-ghost:active{ background:rgba(0,0,0,.06) }
    .btn-ghost:focus-visible{ outline:2px solid rgba(30,30,30,.28); outline-offset:2px }

    .ico{ width:20px; height:20px; display:inline-block }
    .ico.sm{ width:16px; height:16px }

    .fullbleed{ width:100vw; margin-left:calc(50% - 50vw) }
    #heroLink{ display:block }
    .credit{ text-align:right; font-size:14px; margin-top:8px; color:var(--accent); padding-right:16px }
    .credit a{ text-decoration:underline; cursor:pointer }

    .embed{ aspect-ratio:16/9 } .embed iframe{ width:100%; height:100%; border:0; display:block }
    .section{ padding:18px 0 6px; border-top:1px solid var(--line) }
    .section h2{
      margin:0 0 10px; font-size:clamp(22px,4.4vw,32px); line-height:1.24; letter-spacing:-.02em;
      display:flex; align-items:center; gap:10px
    }
    .section h3{
      margin:14px 0 6px; font-size:clamp(18px,3.8vw,24px); font-weight:700; letter-spacing:-.01em
    }
    .section .lead{ color:var(--muted); font-size:var(--body); line-height:1.6 }

    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 6px }
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:16px;
      border:1px solid var(--line); background:var(--chip); font-weight:600; font-size:15px
    }
    .chip .ico{ width:18px; height:18px }

    .gpx-actions{ margin-top:14px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:12px 18px; font-weight:700; border-radius:28px; text-decoration:none; border:1px solid var(--ink); background:#000; color:#fff }
    .btn.alt{ background:transparent; color:var(--ink); border-color:var(--line) }

    .note{ font-size:13px; opacity:.7 }

    @media (max-width:810px){ .value{ font-size:clamp(18px,4.6vw,24px) } }
    @media (max-width:480px){
      .page{ padding:20px 20px 32px }
      .grid2{ grid-template-columns:1fr 1fr }
      .embed{ aspect-ratio:3/4 }
      .credit{ font-size:13px }
    }

    #status{ font-size:12px; opacity:.7; max-width:720px; margin:0 auto }

    /* icon bullets injected on section titles via data-attr */
    .with-ico{ display:flex; align-items:center; gap:10px }
    .with-ico .ico{ width:24px; height:24px }
  </style>
</head>
<body>
  <div class="page">
    <div id="status">Loading…</div>

    <!-- Title + Actions + Meta (APPROVED BLOCK) -->
    <h1 id="title" class="title"></h1>

    <div class="actions">
      <button id="actBookmark" class="btn-ghost"><svg class="ico"><use href="#i-bookmark"/></svg><span>Bookmark</span></button>
      <button id="actShare" class="btn-ghost"><svg class="ico"><use href="#i-share"/></svg><span>Share</span></button>
      <button id="actPrint" class="btn-ghost"><svg class="ico"><use href="#i-print"/></svg><span>Print</span></button>
    </div>

    <div class="grid2 meta4">
      <div>
        <div class="label"><svg class="ico sm"><use href="#i-star"/></svg><span>Category</span></div>
        <div id="category" class="value"></div>
      </div>
      <div>
        <div class="label"><svg class="ico sm"><use href="#i-sun"/></svg><span>Season</span></div>
        <div id="season" class="value"></div>
      </div>
      <div>
        <div class="label"><svg class="ico sm"><use href="#i-pin"/></svg><span>Location</span></div>
        <div id="location" class="value"></div>
      </div>
      <div>
        <div class="label"><svg class="ico sm"><use href="#i-calendar"/></svg><span>Date</span></div>
        <div id="date" class="value"></div>
      </div>
    </div>

    <!-- Hero -->
    <div class="fullbleed">
      <a id="heroLink" href="#" target="_blank" rel="noopener noreferrer" aria-label="Photo credit link">
        <img id="hero" alt="Expedition hero"/>
      </a>
      <div id="credit" class="credit"></div>
    </div>

    <!-- Expedition Itinerary (intro text) -->
    <section class="section" id="sec-itinerary">
      <h2 class="with-ico"><svg class="ico"><use href="#i-flag"/></svg><span>Expedition Itinerary</span></h2>
      <div id="intro" class="lead"></div>
    </section>

    <!-- Permits & Entry -->
    <section class="section" id="sec-permits">
      <h2 class="with-ico"><svg class="ico"><use href="#i-id"/></svg><span>Permits & Entry</span></h2>
      <div id="permits"></div>
    </section>

    <!-- Shuttle / Transportation + Google Map -->
    <section class="section" id="sec-shuttle">
      <h2 class="with-ico" style="font-size:clamp(24px,5vw,34px)"><svg class="ico"><use href="#i-bus"/></svg><span>Shuttle / Transportation</span></h2>
      <div id="shuttle"></div>
      <div class="embed" id="mapWrap" style="margin-top:10px">
        <iframe id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- Permit & Shuttle Timeline -->
    <section class="section" id="sec-timeline">
      <h2 class="with-ico"><svg class="ico"><use href="#i-timeline"/></svg><span>Permit & Shuttle Timeline</span></h2>
      <div id="timeline"></div>
    </section>

    <!-- Days (chips) -->
    <section class="section" id="sec-days">
      <h2 class="with-ico"><svg class="ico"><use href="#i-route"/></svg><span>Daily Plan</span></h2>
      <div id="days"></div>
    </section>

    <!-- Other sections (conditions, risk, contacts, gear, etc.) -->
    <section class="section" id="sec-others">
      <div id="others"></div>
    </section>

    <!-- GPX Route & Elevation -->
    <section class="section" id="sec-gpx">
      <h2 class="with-ico" style="font-size:clamp(24px,5vw,34px)"><svg class="ico"><use href="#i-gpx"/></svg><span>GPX Route &amp; Elevation</span></h2>
      <div class="embed" id="gpxEmbedWrap">
        <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <div class="gpx-actions" id="gpxActions">
        <a id="gpxBtn" class="btn" href="#" download><svg class="ico"><use href="#i-download"/></svg>DOWNLOAD GPX</a>
        <a id="gpxStudioLink" class="btn alt" href="#" target="_blank" rel="noopener"><svg class="ico"><use href="#i-open"/></svg>Open in GPX Studio</a>
        <span id="trailheads" style="opacity:.7"></span>
      </div>
      <div class="note" style="margin-top:6px">⚠️ GPX files are a <strong>starter only</strong> — always verify against current conditions and official sources.</div>
    </section>

    <!-- Field Disclaimer (always last) -->
    <section class="section" id="sec-disclaimer">
      <h2 class="with-ico"><svg class="ico"><use href="#i-warning"/></svg><span>Field Disclaimer</span></h2>
      <div id="disclaimer" class="lead"></div>
    </section>
  </div>

  <!-- Icon sprite (neutral, thin stroke) -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
    <!-- top actions & meta -->
    <symbol id="i-bookmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12a1 1 0 0 1 1 1v16l-7-4-7 4V4a1 1 0 0 1 1-1z"/></symbol>
    <symbol id="i-share" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="2"/><circle cx="6" cy="12" r="2"/><circle cx="18" cy="19" r="2"/><path d="M8 11l8-5M8 13l8 5"/></symbol>
    <symbol id="i-print" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M7 9V4h10v5M7 17H5a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-2"/><path d="M7 14h10v6H7z"/></symbol>
    <symbol id="i-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3 2.9 5.9 6.5.9-4.7 4.5 1.1 6.4L12 17.8 6.2 20.7l1.1-6.4L2.6 9.8l6.5-.9L12 3z"/></symbol>
    <symbol id="i-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M2 12h2m16 0h2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M19.8 4.2l-1.4 1.4M4.2 19.8l1.4-1.4"/></symbol>
    <symbol id="i-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s7-6.2 7-12a7 7 0 1 0-14 0c0 5.8 7 12 7 12z"/><circle cx="12" cy="10" r="2.5"/></symbol>
    <symbol id="i-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 10h18"/></symbol>

    <!-- section icons -->
    <symbol id="i-flag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M4 21V4m0 0c6-2 9 2 14 0v10c-5 2-8-2-14 0"/></symbol>
    <symbol id="i-id" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="16" rx="2"/><circle cx="9" cy="12" r="2.5"/><path d="M14 8h5M14 12h5M14 16h5"/></symbol>
    <symbol id="i-bus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="13" rx="2"/><path d="M4 13h16M6 20h2m8 0h2M6 16h0m10 0h0"/></symbol>
    <symbol id="i-timeline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><circle cx="7" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="17" cy="12" r="2"/></symbol>
    <symbol id="i-route" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19c2-6 8-6 10-10s6-4 6-4"/><circle cx="4" cy="19" r="1.6"/><circle cx="20" cy="5" r="1.6"/></symbol>
    <symbol id="i-gpx" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 8-8"/><path d="M20 9V4h-5"/></symbol>
    <symbol id="i-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M6 11l6 6 6-6"/><path d="M5 21h14"/></symbol>
    <symbol id="i-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M14 3h7v7"/><path d="M10 14 21 3"/><rect x="3" y="7" width="14" height="14" rx="2"/></symbol>
    <symbol id="i-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2 2 20h20L12 2z"/><path d="M12 8v5M12 17h.01"/></symbol>

    <!-- small chip icons -->
    <symbol id="i-mile" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="6" width="18" height="12" rx="2"/><path d="M7 10h10M7 14h6"/></symbol>
    <symbol id="i-elev" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 17l6-6 4 4 8-8"/></symbol>
    <symbol id="i-water" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3s6 7 6 10a6 6 0 1 1-12 0c0-3 6-10 6-10z"/></symbol>
    <symbol id="i-tip" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v6M6 22h12M8 14a4 4 0 1 1 8 0"/></symbol>
    <symbol id="i-bail" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18M12 3v18"/></symbol>
    <symbol id="i-decision" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18"/><path d="M12 7h7l-2 3 2 3h-7M12 17H5"/></symbol>
    <symbol id="i-morale" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M8 10h.01M16 10h.01"/><path d="M8 15c2 2 6 2 8 0"/></symbol>
  </svg>

  <script>
    const $  = (id) => document.getElementById(id);
    const qp = (k) => new URL(location.href).searchParams.get(k);
    const get = (o,p)=>p.split('.').reduce((a,c)=>a?.[c],o);
    const first = (o,keys)=>{ for(const k of keys){ const v=get(o,k); if(typeof v==="string"&&v.trim()) return v.trim(); if(v) return v; } return ""; };

    function getSlug(){
      const q = qp("slug"); if (q) return q;
      const parts = (location.pathname||"/").split("/").filter(Boolean);
      const i = parts.findIndex(p=>p.toLowerCase()==="expedition" || p.toLowerCase()==="trip");
      return i>-1 ? parts[i+1] : null;
    }

    // GPX Studio helper
    const MAPBOX_TOKEN = "pk.eyJ1IjoiZXhwZWQtaW50ZWwiLCJhIjoiY21kc3Vrc2FtMHZkNjJrcTN6ajlmZzhlMyJ9.APi1rguilYM8GZKBnbyWFg";
    function gpxStudioURL(gpxUrl){
      if(!gpxUrl) return "";
      const options = { token: MAPBOX_TOKEN, files: [ gpxUrl ], distanceUnits: "imperial" };
      return "https://gpx.studio/embed?options=" + encodeURIComponent(JSON.stringify(options));
    }

    function safeParse(text){
      try{
        let x = JSON.parse(text);
        if (typeof x === "string") {
          try { x = JSON.parse(x); } catch {}
        }
        return x;
      }catch{ return null; }
    }

    function normalizeData(raw){
      if (typeof raw === "string") {
        const again = safeParse(raw);
        if (again) raw = again;
      }
      if (raw && (raw.schema_version || raw.hero_image || raw.image_link || raw.mission_text)) return raw;
      let full = null, flat = null;
      if (typeof raw?.index_json === "string") { full = safeParse(raw.index_json); }
      else if (raw?.index_json && typeof raw.index_json === "object") { full = raw.index_json; }
      if (typeof raw?.flat_json === "string") { flat = safeParse(raw.flat_json); }
      else if (raw?.flat_json && typeof raw.flat_json === "object") { flat = raw.flat_json; }
      let out = { ...(full || {}), ...(flat || {}) };
      if (out && !out.image_link) out.image_link = out.imageLink || out.credit_link || out.image_credit_link || "";
      if (out && !out.image_credit) out.image_credit = out.imageCredit || out.photo_credit || "";
      if (out && !out.hero_image) out.hero_image = out.hero?.url || out.image || out.heroImage || "";
      return Object.keys(out).length ? out : raw;
    }

    const isValidUnsplashPhoto = (u)=>{
      try{
        const x = new URL(u);
        return x.hostname === "unsplash.com" && /^\/photos\/[A-Za-z0-9_-]+/.test(x.pathname);
      }catch{ return false; }
    };

    // Simple section splitter + day chip extractor
    function splitSections(text){
      // returns {intro, permits, shuttle, timeline, days:[...], others, disclaimer}
      const blocks = text.split(/\n\s*⸻\s*\n/g); // your dividers
      const out = { intro:"", permits:"", shuttle:"", timeline:"", days:[], others:"", disclaimer:"" };
      for(const b of blocks){
        const t = b.trim();
        if (/^PERMITS\s*&\s*ENTRY/i.test(t)) out.permits = t;
        else if (/^SHUTTLE\s*\/\s*TRANSPORTATION/i.test(t)) out.shuttle = t;
        else if (/^PERMIT\s*&\s*SHUTTLE\s*TIMELINE/i.test(t)) out.timeline = t;
        else if (/^FIELD\s*DISCLAIMER/i.test(t)) out.disclaimer = t;
        else if (/^DAY\s*\d+:/i.test(t)) out.days.push(t);
        else out.intro += (out.intro? "\n\n":"") + t;
      }
      return out;
    }

    function htmlFromLines(block){
      return block.split(/\r?\n/).map(line=>{
        const t=line.trim(); if(!t) return "";
        if (/^DAY\s*\d+:/i.test(t)) return `<h3>${t}</h3>`;
        const m = t.match(/^([^:]+):\s*(.*)$/);
        if (m && !/[a-z]/.test(m[1])) return `<strong>${m[1].trim()}:</strong> ${m[2]}`;
        return t;
      }).join("<br/>");
    }

    function chipsFrom(text){
      const chips = [];
      const add = (icon,label)=>chips.push(`<span class="chip"><svg class="ico"><use href="#${icon}"/></svg>${label}</span>`);
      // distance
      const mi = text.match(/(\d+(?:\.\d+)?)\s*mi/gi); if (mi) add("i-mile", mi[0].replace(/^\s+/,''));
      // elevation
      const el = text.match(/[+]\s*\d{2,5}\s*ft\s*\/\s*-\s*\d{2,5}\s*ft/); if (el) add("i-elev", el[0].replace(/\s+/g,' '));
      // water
      if (/water|stream|fill/i.test(text)) add("i-water", (text.match(/(fill|water|streams?)/i)||["Water"])[0].replace(/^\w/,c=>c.toUpperCase()));
      // tips
      if (/tip|start early|layer/i.test(text)) add("i-tip", (text.match(/(Start early|Layer|Tip[s]?)/i)||["Trail tips"])[0]);
      // bailout
      if (/bailout|exit/i.test(text)) add("i-bail", (text.match(/Bailout:[^.\n]+/i)||["Bailout"])[0]);
      // decision
      if (/decision/i.test(text)) add("i-decision", (text.match(/Decision[^.\n]*/i)||["Decision"])[0]);
      // morale
      if (/morale/i.test(text)) add("i-morale", (text.match(/Morale[^.\n]*/i)||["Morale"])[0]);
      return chips.join("");
    }

    async function main(){
      const status = $("status");
      const slug = getSlug();
      if(!slug){ status.textContent="Missing slug (?slug= or /expedition/{slug})"; return; }

      const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json?cb=${Date.now()}`;
      status.textContent = "Fetching…";

      let data;
      try{
        const res = await fetch(jsonURL, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        let raw = safeParse(text);
        if (raw === null) raw = {};
        data = normalizeData(raw);
      }catch(e){
        status.textContent = "Fetch failed: "+e.message;
        return;
      }

      // Populate top
      $("title").textContent = first(data,["title","name"]) || "";
      $("category").textContent = first(data,["category","type"]) || "";
      $("season").textContent = first(data,["season"]) || "";
      $("location").textContent = first(data,["location","place"]) || "";
      const d = first(data,["date","when"]);
      $("date").textContent = /^\d{4}-\d{2}-\d{2}$/.test(d)
        ? new Date(d+"T00:00:00Z").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"})
        : (d||"");

      const hero = first(data,["hero_image","hero.url","image"]);
      if (hero) $("hero").src = hero;

      const creditName = first(data,["image_credit","credit","photo_credit"]) || "";
      let creditLink = first(data,["image_link","credit_link","image_credit_link"]) || "";
      if (!isValidUnsplashPhoto(creditLink)) creditLink = "";
      $("credit").innerHTML = creditName
        ? (creditLink
            ? `<a href="${creditLink}" target="_blank" rel="noopener noreferrer" title="${creditLink}">${creditName}</a>`
            : creditName)
        : "";
      const heroLinkEl = $("heroLink");
      if (heroLinkEl) {
        if (creditLink) { heroLinkEl.href = creditLink; heroLinkEl.style.pointerEvents = "auto"; }
        else { heroLinkEl.removeAttribute("href"); heroLinkEl.style.pointerEvents = "none"; }
      }

      // Content sections
      const mission = first(data,["mission_text","mission","brief","summary"]) || "";
      const parts = splitSections(mission);

      // intro under "Expedition Itinerary"
      $("intro").innerHTML = htmlFromLines(parts.intro);

      // permits
      $("permits").innerHTML = htmlFromLines(parts.permits);

      // shuttle (text)
      $("shuttle").innerHTML = htmlFromLines(parts.shuttle);

      // timeline
      $("timeline").innerHTML = htmlFromLines(parts.timeline);

      // days
      const daysWrap = $("days");
      if (parts.days.length){
        daysWrap.innerHTML = parts.days.map(block=>{
          const lines = block.split(/\r?\n/).filter(Boolean);
          const title = lines.shift();
          const body = lines.join("\n");
          const chips = chipsFrom(body);
          return `
            <article class="section" style="border-top:0;padding:0 0 14px">
              <h3>${title}</h3>
              <div class="lead" style="margin:6px 0 8px">${htmlFromLines(body)}</div>
              ${chips ? `<div class="chips">${chips}</div>` : ``}
            </article>
          `;
        }).join("");
      }

      // others (everything else that wasn't categorized gets appended here)
      const others = [];
      ["CAMPSITE INTEL","WEATHER & ALTITUDE NOTES","GEAR CHECKLIST","OPTIONAL MODIFICATION","RISK MATRIX & HAZARD TIMELINE","CONDITIONS WATCH","BAILOUT SUMMARY","EMERGENCY CONTACTS & NUMBERS","FINAL BRIEF SUMMARY"].forEach(h=>{
        const m = mission.match(new RegExp(`${h}[\\s\\S]*?(?=\\n\\s*⸻|$)`,"i"));
        if (m) others.push(`<div class="section"><h2>${h}</h2><div>${htmlFromLines(m[0])}</div></div>`);
      });
      $("others").innerHTML = others.join("");

      // disclaimer
      $("disclaimer").innerHTML = htmlFromLines(parts.disclaimer);

      // Map
      const mapURL = first(data,["map_embed_url","map_embed","map.url"]);
      if (mapURL) $("map").src = mapURL; else $("mapWrap").style.display = "none";

      // GPX
      const gpxURL = first(data,["gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"]);
      if (gpxURL) {
        const studio = gpxStudioURL(gpxURL);
        $("gpxStudio").src = studio;
        $("gpxStudioLink").href = studio;
        $("gpxBtn").href = gpxURL;
        $("gpxBtn").download = (getSlug()||"route") + ".gpx";
        const th = [first(data,["start_trailhead","start"]), first(data,["end_trailhead","end"])].filter(Boolean).join(" → ");
        if (th) $("trailheads").textContent = th;
      } else {
        $("gpxEmbedWrap").innerHTML = `<div style="opacity:.7;font-size:14px">No GPX URL found (expected <code>gpx_download_link</code>).</div>`;
        $("gpxActions").style.display = "none";
      }

      status.textContent = "";
      setTimeout(()=>status.remove(),10);

      // —— Top actions ——
      const bookmarkedKey = "ei:bookmark:" + (location.pathname || location.href);
      const actBookmark = $("actBookmark"), actShare = $("actShare"), actPrint = $("actPrint");
      function syncBookmarkUI(){
        const on = localStorage.getItem(bookmarkedKey) === "1";
        actBookmark?.setAttribute("aria-pressed", on ? "true" : "false");
        if (actBookmark) actBookmark.style.background = on ? "rgba(0,0,0,.06)" : "transparent";
      }
      actBookmark?.addEventListener("click", ()=>{
        const on = localStorage.getItem(bookmarkedKey) === "1";
        localStorage.setItem(bookmarkedKey, on ? "0" : "1");
        syncBookmarkUI();
      });
      actShare?.addEventListener("click", async ()=>{
        try{
          if (navigator.share) await navigator.share({ title: document.title, url: location.href });
          else await navigator.clipboard.writeText(location.href);
        }catch{}
      });
      actPrint?.addEventListener("click", ()=> window.print());
      syncBookmarkUI();
    }

    if (typeof window!=="undefined") main();
  </script>
</body>
</html>
