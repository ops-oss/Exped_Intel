<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition</title>

  <!-- If you want perfect Framer typography, keep your exported fonts.css here -->
  <link rel="stylesheet" href="/fonts.css" />

  <style>
    /* --- TOKENS ----------------------------------------------------------- */
    :root{
      /* from your export */
      --bg: rgb(232, 229, 226);            /* page background */
      --ink: rgb(30, 30, 30);              /* text */
      --paper: rgb(255, 255, 255);         /* surface, if needed */
      --accent: rgb(254, 87, 51);

      --font-sans: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;

      /* type scale approximating your Framer page */
      --h1: clamp(34px, 7.6vw, 64px);
      --label: 14px;
      --body: 18px;
    }

    /* --- GLOBAL ----------------------------------------------------------- */
    *,*::before,*::after { box-sizing: border-box; }
    html,body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.45;
    }
    img { display:block; max-width:100%; height:auto; }
    a { color: inherit; text-underline-offset: 2px; }

    /* --- LAYOUT ----------------------------------------------------------- */
    .page {
      display:grid;
      grid-template-columns: minmax(16px,1fr) minmax(0,1120px) minmax(16px,1fr);
      grid-auto-rows: min-content;
      row-gap: 28px;
    }
    .page > * { grid-column: 2; }

    /* Title & meta block (TOP) */
    .title { font-size: var(--h1); font-weight: 700; line-height: 1.06; letter-spacing: -0.01em; }
    .metaGrid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 28px 40px;
      margin-top: 16px;
    }
    .metaItem .label {
      font-size: var(--label);
      letter-spacing: .18em;
      text-transform: uppercase;
      opacity: .65;
      margin-bottom: 8px;
    }
    .metaItem .value {
      font-size: clamp(18px, 3.5vw, 28px);
      font-weight: 500;
      line-height: 1.25;
    }

    /* Hero (BELOW meta), no borders/radius */
    .hero { margin-top: 8px; }
    .credit {
      margin-top: 8px;
      text-align: right;        /* right-aligned under image */
      font-size: 14px;
      opacity: .8;
    }
    .credit a { color: var(--accent); text-decoration: none; }
    .credit a:hover { text-decoration: underline; }

    /* Content text block */
    .pre {
      white-space: pre-wrap;
      font-size: var(--body);
      line-height: 1.55;
    }

    /* Embeds (no borders/radius) */
    .embed { aspect-ratio: 16/9; }
    .embed iframe { width:100%; height:100%; border:0; display:block; }

    /* GPX actions (button centered BELOW iframe) */
    .gpx-actions{
      margin-top: 14px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;
    }
    .btn {
      display:inline-flex; align-items:center; gap:10px;
      padding: 12px 18px;
      border: 0;
      border-radius: 999px;
      background: var(--ink);
      color: white;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }
    .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 3px; }

    /* Responsive tweaks */
    @media (max-width: 960px) {
      .page { grid-template-columns: 12px minmax(0, 810px) 12px; }
    }
    @media (max-width: 600px) {
      .page { grid-template-columns: 10px minmax(0, 1fr) 10px; }
      .metaGrid { grid-template-columns: 1fr 1fr; gap: 20px; }
    }

    /* tiny status line while testing */
    .status { font-size: 12px; opacity:.65; text-align:center; }
  </style>
</head>
<body>
  <div class="page">
    <div id="status" class="status">Loading…</div>

    <!-- TOP: title + meta -->
    <header>
      <h1 id="title" class="title"></h1>
      <div class="metaGrid">
        <div class="metaItem">
          <div class="label">Category</div>
          <div id="category" class="value"></div>
        </div>
        <div class="metaItem">
          <div class="label">Season</div>
          <div id="season" class="value"></div>
        </div>
        <div class="metaItem">
          <div class="label">Location</div>
          <div id="location" class="value"></div>
        </div>
        <div class="metaItem">
          <div class="label">Date</div>
          <div id="date" class="value"></div>
        </div>
      </div>
    </header>

    <!-- Hero BELOW meta -->
    <figure class="hero">
      <img id="hero" alt="Expedition hero image" />
      <figcaption id="credit" class="credit"></figcaption>
    </figure>

    <!-- Mission text -->
    <section>
      <div id="mission" class="pre"></div>
    </section>

    <!-- Google Map (no section header) -->
    <section>
      <div class="embed">
        <iframe id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- GPX Studio (iframe first, button BELOW and centered) -->
    <section id="gpxSection">
      <div id="gpxEmbedWrap" class="embed" style="margin-top:12px">
        <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <div id="gpxActions" class="gpx-actions">
        <a id="gpxBtn" class="btn" href="#" download>Download GPX</a>
      </div>
      <div id="trailheads" class="status" style="margin-top:8px"></div>
    </section>
  </div>

  <script>
    // --- tiny helpers -------------------------------------------------------
    const $ = id => document.getElementById(id);
    const get = (o,p) => p.split('.').reduce((a,k)=>a?.[k], o);
    const first = (o,keys)=> keys.map(k=>get(o,k)).find(v=>v!==undefined && v!==null && v!=="");

    function getSlug(){
      // supports /expedition/{slug} and ?slug=...
      const url = new URL(location.href);
      const q = url.searchParams.get("slug");
      if (q) return q;
      const parts = url.pathname.split("/").filter(Boolean);
      const i = parts.findIndex(p => p.toLowerCase()==="expedition");
      return i>-1 ? parts[i+1] : null;
    }

    function gpxStudioURL(src){
      if (!src) return "";
      return "https://gpx.studio/?state="+encodeURIComponent(JSON.stringify({
        traces:[{ url: src }],
        settings:{ units:"imperial" }
      }));
    }

    async function main(){
      const status = $("status");
      const slug = getSlug();
      if(!slug){ status.textContent="Missing slug. Use /expedition/{slug} or ?slug=..."; return; }

      const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json`;

      try{
        status.textContent = "Fetching…";
        const res = await fetch(jsonURL, { cache:"no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // Title & meta
        $("title").textContent = first(data,["title"]) || "";
        $("category").textContent = first(data,["category"]) || "";
        $("season").textContent   = first(data,["season"])   || "";
        $("location").textContent = first(data,["location"]) || "";
        $("date").textContent     = first(data,["date"])     || "";

        // Hero below meta
        const hero = first(data,["hero_image","hero.url","image"]);
        if (hero) $("hero").src = hero;

        // Credit hyperlink uses image_link preferentially
        const creditName = first(data,["image_credit","credit","photo_credit"]);
        const creditHref = first(data,[
          "image_link",               // <— your Unsplash page URL
          "image_credit_link",
          "credit_link",
          "unsplash_link",
          "unsplash_url"
        ]) || (hero && /images\.unsplash\.com/i.test(hero) ? hero : "");

        $("credit").innerHTML = creditName
          ? (creditHref
             ? `<a href="${creditHref}" target="_blank" rel="noopener noreferrer">${creditName}</a>`
             : creditName)
          : "";

        // Mission text (preserve line breaks)
        const mission = first(data,["mission_text","mission"]) || "";
        $("mission").innerHTML = mission.replace(/\n/g,"<br>");

        // Map iframe
        $("map").src = first(data,["map_embed_url","map_embed"]) || "";

        // GPX (iframe first, button centered below)
        const gpxURL = first(data,[
          "gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"
        ]);
        if (gpxURL){
          const studio = gpxStudioURL(gpxURL);
          $("gpxStudio").src = studio;
          $("gpxBtn").href = gpxURL;
          $("gpxBtn").download = (slug || "route") + ".gpx";
          const th = [ first(data,["start_trailhead","start"]),
                       first(data,["end_trailhead","end"]) ]
                      .filter(Boolean).join(" → ");
          $("trailheads").textContent = th;
        } else {
          $("gpxSection").style.display = "none";
        }

        status.textContent = "Loaded ✓";
        setTimeout(()=>status.style.display="none", 800);
      }catch(err){
        status.textContent = `Failed to load: ${err.message}`;
      }
    }

    main();
  </script>
</body>
</html>
