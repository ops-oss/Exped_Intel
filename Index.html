<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition</title>

  <!-- Keep your @font-face bundle in /fonts.css -->
  <link rel="stylesheet" href="/fonts.css" />

  <style>
  /* Framer-like base + your tokens */
  :root{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  *{box-sizing:border-box;-webkit-font-smoothing:inherit}
  h1,h2,h3,h4,h5,h6,p,figure{margin:0}
  body,input,textarea,select,button{font-size:12px;font-family:sans-serif}

  body{
    /* YOUR token values */
    --token-1f6852e9-1497-4551-bef7-299f387d8f98: rgb(232,229,226); /* page bg */
    --token-7712de8b-cd5c-4040-8ffb-91f4bea9bb25: rgb(30,30,30);    /* ink */
    --token-35c36f3c-8523-4623-83f9-76c6f492ff46: rgb(255,255,255); /* white */
    --token-427ec4a1-6126-417a-9822-7f4f7c9d8aff: rgb(254,87,51);   /* accent */

    --bg: var(--token-1f6852e9-1497-4551-bef7-299f387d8f98);
    --ink: var(--token-7712de8b-cd5c-4040-8ffb-91f4bea9bb25);
    --paper: var(--token-35c36f3c-8523-4623-83f9-76c6f492ff46);
    --accent: var(--token-427ec4a1-6126-417a-9822-7f4f7c9d8aff);

    --font-sans: "Poppins", Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;

    --radius-l: 12px;
    --radius-m: 10px;
    --radius-s: 8px;

    --h1: clamp(36px, 8vw, 72px);
    --h2: clamp(18px, 3.2vw, 28px);
    --h3: clamp(16px, 2.6vw, 22px);
    --body: clamp(15px, 2.3vw, 18px);
    --small: 13px;
  }

  html, body { height: 100%; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--ink);
    font-family: var(--font-sans);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  img { display:block; max-width:100%; height:auto; }
  a { color: inherit; text-underline-offset: 2px; }

  /* Layout wrapper */
  .page {
    display: grid;
    grid-template-columns: minmax(16px, 1fr) minmax(0, 1120px) minmax(16px, 1fr);
    grid-auto-rows: min-content;
    row-gap: 28px;
  }
  .page > * { grid-column: 2; }

  /* Title + meta grid */
  .title-wrap { padding-top: 4px; }
  .title { font-size: var(--h1); line-height: 1.04; font-weight: 700; letter-spacing:-0.02em; }

  .meta-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px 40px;
    margin-top: 24px;
  }
  .meta-block .label{
    font-size: var(--small);
    letter-spacing: 0.16em;
    text-transform: uppercase;
    opacity: .65;
    margin-bottom: 6px;
  }
  .meta-block .val{
    font-size: clamp(18px, 4.5vw, 28px);
    line-height: 1.2;
    font-weight: 500;
  }

  /* HERO — moved BELOW meta + no radius now */
  .hero { position: relative; }
  .hero img { width: 100%; height: auto; display:block; }
  .credit {
    position: absolute;
    right: 16px; bottom: 12px;
    color: var(--accent);
    background: transparent;
    font-size: 12px;
  }

  /* Sections with thin border */
  .section {
    background: transparent;
    border: 1px solid rgba(0,0,0,.10);
    border-radius: var(--radius-l);
    padding: 18px;
  }
  .section h2 { font-size: var(--h2); margin: 2px 0 12px; }

  /* Mission */
  .pre { white-space: pre-wrap; line-height: 1.55; font-size: var(--body); }

  /* Embeds — no radius, no heavy border */
  .embed {
    border-radius: 0;              /* ← no radius */
    overflow: hidden;
    border: none;                  /* ← no border frame */
    aspect-ratio: 16/9;
    background: transparent;
  }
  .embed iframe { width: 100%; height: 100%; border: 0; display: block; }

  /* GPX */
  .gpx-row { display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap: wrap; }
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding: 14px 22px; border-radius: 999px;
    border: 1px solid rgba(0,0,0,.14);
    background: #000; color:#fff; cursor:pointer;
    font-weight:700; letter-spacing:.02em; text-decoration:none;
  }
  .btn:hover{ filter:brightness(1.05); }
  .debug{ font-size:12px; opacity:.6; }

  /* Status strip */
  .status { font-size: 12px; opacity: .7; text-align:center; padding: 6px 0; }

  /* Tablet 810 centered */
  @media (max-width: 1024px) {
    .page { grid-template-columns: 12px minmax(0, 810px) 12px; }
  }
  /* Phone */
  @media (max-width: 480px) {
    .page { grid-template-columns: 8px minmax(0, 1fr) 8px; }
    .title { font-size: clamp(34px, 10vw, 52px); }
    .credit { font-size: 12px; }
  }
  </style>
</head>
<body>
  <div class="page">
    <div id="status" class="status">Loading…</div>

    <!-- TITLE + META (stays on top) -->
    <section class="title-wrap">
      <h1 id="title" class="title"></h1>
      <div class="meta-grid">
        <div class="meta-block" data-hide-if-empty>
          <div class="label">Location</div>
          <div id="locationVal" class="val"></div>
        </div>
        <div class="meta-block" data-hide-if-empty>
          <div class="label">Date</div>
          <div id="dateVal" class="val"></div>
        </div>
        <div class="meta-block" data-hide-if-empty>
          <div class="label">Category</div>
          <div id="categoryVal" class="val"></div>
        </div>
        <div class="meta-block" data-hide-if-empty>
          <div class="label">Season</div>
          <div id="seasonVal" class="val"></div>
        </div>
      </div>
    </section>

    <!-- HERO — now below the meta block -->
    <figure class="hero">
      <img id="hero" alt="Expedition hero image" />
      <figcaption id="credit" class="credit"></figcaption>
    </figure>

    <!-- MISSION -->
    <section class="section">
      <h2>Mission Brief</h2>
      <div id="mission" class="pre"></div>
    </section>

    <!-- MAP -->
    <section class="section" data-hide-if-empty>
      <h2>Route Map (Google)</h2>
      <div class="embed">
        <iframe id="map" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- GPX -->
    <section class="section">
      <h2>Interactive GPX</h2>
      <div class="gpx-row">
        <a id="gpxBtn" class="btn" href="#" download>DOWNLOAD GPX</a>
        <span class="val" id="trailheads"></span>
      </div>
      <div class="embed" style="margin-top:12px">
        <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <!-- tiny debug helper to open the computed GPX Studio URL -->
      <div class="debug"><a id="gpxStudioLink" href="#" target="_blank" rel="noopener">Open GPX Studio URL</a></div>
    </section>
  </div>

  <script>
  function byId(id){ return document.getElementById(id); }
  function getParam(name){ const u=new URL(location.href); return u.searchParams.get(name); }
  function q(obj, path){ try{ return path.split('.').reduce((o,k)=>o?.[k], obj); }catch(e){ return undefined; } }
  function setText(id, val){ const el=byId(id); if(!el) return; if(!val){ el.closest('[data-hide-if-empty]')?.remove(); return } el.textContent=val; }
  function setHTML(id, val){ const el=byId(id); if(!el) return; if(!val){ el.closest('[data-hide-if-empty]')?.remove(); return } el.innerHTML=val; }
  function setSrc(id, val){ const el=byId(id); if(!el) return; if(!val){ el.closest('.embed,.hero,[data-hide-if-empty]')?.remove(); return } el.src=val; }

  function gpxStudioURL(gpxUrl){
    if(!gpxUrl) return "";
    const state={ traces:[{ url:gpxUrl }], settings:{ units:"imperial" } };
    return "https://gpx.studio/?state="+encodeURIComponent(JSON.stringify(state));
  }

  function getSlug(){
    const fromQuery=getParam("slug");
    if(fromQuery) return fromQuery;
    const parts=(location.pathname||"/").split("/").filter(Boolean);
    const idx=parts.findIndex(p=>p.toLowerCase()==="expedition");
    return idx>-1 ? parts[idx+1] : null;
  }

  function firstDefined(obj, keys){
    for(const k of keys){ const v=q(obj,k); if(v) return v; }
    return "";
  }

  // Optional: pretty date like "Sep 13, 2025" when JSON is YYYY-MM-DD
  function formatDateMaybe(val){
    if(!val) return val;
    if(/^\d{4}-\d{2}-\d{2}$/.test(val)){
      const d=new Date(val+"T00:00:00Z");
      const fmt=d.toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"});
      return fmt;
    }
    return val;
  }

  async function main(){
    const statusEl=byId("status");
    const slug=getSlug();

    if(!slug){ statusEl.textContent="Missing slug. Use ?slug={file} or /expedition/{slug}"; return; }

    // Supabase (bucket 'expedition', singular)
    const jsonURL=`https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json`;

    statusEl.textContent="Fetching expedition…";
    let data;
    try{
      const res=await fetch(jsonURL,{cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      data=await res.json();
    }catch(err){
      statusEl.textContent=`Failed to fetch ${jsonURL}: ${err.message}`;
      return;
    }

    // HERO + CREDIT
    setSrc("hero", firstDefined(data, ["hero_image","hero.url","image"]));
    const creditName=firstDefined(data, ["image_credit","credit","photo_credit"]);
    const creditLink=firstDefined(data, ["image_link","credit_link"]);
    if(creditName){
      byId("credit").innerHTML = creditLink
        ? `<a href="${creditLink}" target="_blank" rel="noopener noreferrer">${creditName}</a>`
        : creditName;
    } else {
      byId("credit").style.display="none";
    }

    // TITLE + META
    setText("title", firstDefined(data, ["title","name"]));
    setText("categoryVal", firstDefined(data, ["category","type"]));
    setText("seasonVal", firstDefined(data, ["season"]));
    setText("locationVal", firstDefined(data, ["location","place"]));
    setText("dateVal", formatDateMaybe(firstDefined(data, ["date","when"])));

    // MISSION
    const missionText=firstDefined(data, ["mission_text","mission","brief","summary"]);
    setHTML("mission", (missionText||"").replace(/\n/g,"<br/>"));

    // MAP
    const mapURL=firstDefined(data, ["map_embed_url","map_embed","map.url"]);
    setSrc("map", mapURL);

    // GPX (prioritize your exact key)
    const gpxURL=firstDefined(data, [
      "gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"
    ]);
    if(gpxURL){
      const btn=byId("gpxBtn");
      btn.href=gpxURL;
      btn.download=(slug||"route")+".gpx";
      setText("trailheads", [firstDefined(data,["start_trailhead","start"]), firstDefined(data,["end_trailhead","end"])].filter(Boolean).join(" → "));

      const studio=gpxStudioURL(gpxURL);
      setSrc("gpxStudio", studio);
      const link=byId("gpxStudioLink"); link.href=studio;
    }else{
      byId("gpxBtn").style.display="none";
      byId("gpxStudio")?.closest(".embed")?.remove();
      byId("gpxStudioLink").style.display="none";
    }

    statusEl.textContent="Loaded ✓";
    setTimeout(()=> statusEl.style.display="none", 1200);
  }

  if(typeof window!=="undefined") main();
  </script>
</body>
</html>
