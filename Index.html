<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition</title>

  <!-- Your exported font faces (the big Poppins/Inter block you pasted) -->
  <link rel="stylesheet" href="/fonts.css" />

  <style>
    /* === TOKENS (using your values) ======================================= */
    :root{
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    *{ box-sizing:border-box; -webkit-font-smoothing:inherit }
    h1,h2,h3,h4,h5,h6,p,figure{ margin:0 }
    body,input,textarea,select,button{ font-size:12px; font-family:sans-serif }

    /* Colors from the snippet you provided + a bg alias so the body matches */
    body{
      --token-1f6852e9-1497-4551-bef7-299f387d8f98: rgb(232, 229, 226); /* sand bg */
      --token-7712de8b-cd5c-4040-8ffb-91f4bea9bb25: rgb(30, 30, 30);    /* ink */
      --token-35c36f3c-8523-4623-83f9-76c6f492ff46: rgb(255, 255, 255); /* paper */
      --token-427ec4a1-6126-417a-9822-7f4f7c9d8aff: rgb(254, 87, 51);   /* accent */
    }

    /* Aliases so CSS stays readable */
    :root{
      --bg: var(--token-1f6852e9-1497-4551-bef7-299f387d8f98);
      --ink: var(--token-7712de8b-cd5c-4040-8ffb-91f4bea9bb25);
      --paper: var(--token-35c36f3c-8523-4623-83f9-76c6f492ff46);
      --accent: var(--token-427ec4a1-6126-417a-9822-7f4f7c9d8aff);

      /* Typography: point to your loaded families */
      --font-sans: "Poppins", "Inter", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;

      /* Radii & spacing tuned to your screenshots */
      --radius-xl: 20px;
      --radius-l: 16px;
      --radius-m: 12px;
      --radius-s: 8px;

      /* Type scale (close to Framer defaults you showed) */
      --h1: clamp(28px, 3vw, 44px);
      --h2: clamp(20px, 2.2vw, 32px);
      --h3: clamp(17px, 1.6vw, 22px);
      --body: 16px;
      --small: 13px;
    }

    /* === Base ============================================================= */
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    img { display:block; max-width:100%; height:auto; }
    a { color: inherit; text-underline-offset: 2px; }

    /* === Page grid ======================================================== */
    .page {
      display: grid;
      grid-template-columns: minmax(16px, 1fr) minmax(0, 1120px) minmax(16px, 1fr);
      grid-auto-rows: min-content;
      row-gap: 20px;
      padding: 20px 0 40px;
    }
    .page > * { grid-column: 2; }

    /* Status (during load) */
    .status { font-size: 12px; opacity: .65; text-align:center; padding: 6px 0; }

    /* === Hero ============================================================= */
    .hero {
      position: relative;
      border-radius: var(--radius-xl);
      overflow: hidden;
      background: var(--paper);
      border: 1px solid rgba(0,0,0,.06);
      /* Framer-like full bleed card look */
      aspect-ratio: 16/9;
    }
    .hero img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* ensures full-bleed visual like your live page */
    }
    .credit {
      position: absolute;
      right: 12px; bottom: 12px;
      background: rgba(0,0,0,.64);
      color: white;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: var(--small);
      line-height: 1;
    }

    /* === Title & Meta pills ============================================== */
    .title-wrap { padding: 8px 2px 0 2px; }
    .title { font-size: var(--h1); line-height: 1.08; font-weight: 700; }
    .meta {
      margin-top: 10px;
      font-size: var(--small);
      opacity: .9;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .pill {
      padding: 7px 12px;
      border-radius: 999px;
      background: var(--paper);
      border: 1px solid rgba(0,0,0,.08);
      line-height: 1;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* === Content cards (Mission / Map / GPX) ============================= */
    .card {
      background: var(--paper);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(0,0,0,.06);
      padding: 18px;
    }
    .card h2 { font-size: var(--h2); margin: 4px 0 12px; font-weight: 700; }
    .card h3 { font-size: var(--h3); margin: 16px 0 8px; font-weight: 600; }

    .pre {
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: var(--body);
    }

    /* Embeds (Google Map + GPX Studio) */
    .embed {
      background: #000;
      border-radius: var(--radius-l);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,.06);
      aspect-ratio: 16/9;
    }
    .embed iframe {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
    }

    /* GPX row */
    .gpx-row {
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      flex-wrap: wrap;
    }
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.12);
      background: var(--paper);
      cursor: pointer;
      font-weight: 700;
      text-decoration:none;
    }
    .btn:hover { border-color: rgba(0,0,0,.2); }

    /* === Tablet & Mobile ================================================== */
    @media (max-width: 1120px) {
      .page { grid-template-columns: 12px minmax(0, 1fr) 12px; }
    }
    /* Your “fixed 810” view: we center a max-width 810 look below this */
    @media (max-width: 1024px) {
      .page { grid-template-columns: minmax(12px, 1fr) minmax(0, 810px) minmax(12px, 1fr); }
    }
    @media (max-width: 480px) {
      .page { grid-template-columns: 8px minmax(0, 1fr) 8px; }
      .title { font-size: clamp(22px, 7vw, 30px); }
      .credit { font-size: 12px; }
      .card { border-radius: var(--radius-l); }
      .hero { border-radius: var(--radius-l); }
    }
  </style>
</head>
<body>
  <div class="page">
    <div id="status" class="status">Loading…</div>

    <!-- Hero -->
    <figure class="hero">
      <img id="hero" alt="Expedition hero image" />
      <figcaption id="credit" class="credit"></figcaption>
    </figure>

    <!-- Title + meta -->
    <section class="title-wrap">
      <h1 id="title" class="title"> </h1>
      <div class="meta">
        <span id="category" class="pill"> </span>
        <span id="season" class="pill"> </span>
        <span id="location" class="pill"> </span>
        <span id="date" class="pill mono"> </span>
      </div>
    </section>

    <!-- Mission Brief -->
    <section class="card" id="missionCard">
      <h2>Mission Brief</h2>
      <div id="mission" class="pre"> </div>
    </section>

    <!-- Google Map -->
    <section class="card" id="mapCard">
      <h2>Route Map (Google)</h2>
      <div class="embed">
        <iframe id="map" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- GPX Studio -->
    <section class="card" id="gpxCard">
      <h2>Interactive GPX</h2>
      <div class="gpx-row">
        <a id="gpxBtn" class="btn" href="#" download>⬇️ Download GPX</a>
        <span class="mono" id="trailheads"> </span>
      </div>
      <div class="embed" style="margin-top:12px">
        <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>
  </div>

  <script>
    // ---------------- Helpers ----------------
    const $ = id => document.getElementById(id);
    const pick = (o, path) => path.split('.').reduce((a,k)=>a && a[k], o);
    const setText = (id, val) => { const el=$(id); if(!val){el?.remove();return} el.textContent = val; };
    const setHTML = (id, val) => { const el=$(id); if(!val){el?.remove();return} el.innerHTML = val; };
    const setSrc = (id, val) => { const el=$(id); const wrap=el?.closest('.hero,.embed'); if(!val){wrap?.remove();return} el.src = val; };

    function gpxStudioURL(gpxUrl){
      if(!gpxUrl) return "";
      const state = { traces:[{ url:gpxUrl }], settings:{ units:"imperial" } };
      return "https://gpx.studio/?state=" + encodeURIComponent(JSON.stringify(state));
    }

    // /expedition/{slug} or ?slug= fallback
    function getSlug(){
      const url = new URL(location.href);
      const q = url.searchParams.get("slug");
      if (q) return q;
      const parts = (location.pathname||"/").split("/").filter(Boolean);
      const idx = parts.findIndex(p => p.toLowerCase() === "expedition");
      return idx > -1 ? parts[idx+1] : null;
    }

    async function main(){
      const status = $("status");
      const slug = getSlug();

      if(!slug){
        status.textContent = "Missing slug. Use /expedition/{slug} or ?slug={slug}";
        return;
      }

      // Your Supabase JSON (bucket: expedition — singular)
      const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json`;

      status.textContent = "Fetching expedition…";
      let data;
      try{
        const res = await fetch(jsonURL, { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        data = await res.json();
      }catch(err){
        status.textContent = `Failed to fetch ${jsonURL}: ${err.message}`;
        return;
      }

      // Fill hero + credit
      const hero = pick(data,"hero_image");
      if (hero) { $("hero").src = hero; } else { $(".hero")?.remove?.(); }
      const creditName = pick(data,"image_credit");
      const creditLink = pick(data,"image_link");
      if(creditName){
        $("credit").innerHTML = creditLink
          ? `Photo: <a href="${creditLink}" target="_blank" rel="noopener noreferrer">${creditName}</a>`
          : `Photo: ${creditName}`;
      } else {
        $("credit").remove();
      }

      // Title + pills
      setText("title", pick(data,"title"));
      setText("category", pick(data,"category"));
      setText("season", pick(data,"season"));
      setText("location", pick(data,"location"));
      setText("date", pick(data,"date"));

      // Mission (preserve line breaks)
      const missionText = pick(data,"mission_text");
      setHTML("mission", missionText ? missionText.replace(/\n/g,"<br/>") : "");

      // Google Map
      const mapURL = pick(data,"map_embed_url") || pick(data,"map_embed");
      if (mapURL) { $("map").src = mapURL; } else { $("mapCard").remove(); }

      // GPX
      const gpxURL = pick(data,"gpx_download_link") || pick(data,"gpx_url");
      if (gpxURL){
        $("gpxBtn").href = gpxURL;
        $("gpxBtn").download = (slug || "route") + ".gpx";
        const startTH = pick(data,"start_trailhead");
        const endTH   = pick(data,"end_trailhead");
        const thText = [startTH, endTH].filter(Boolean).join(" → ");
        if (thText) { $("trailheads").textContent = thText; } else { $("trailheads").remove(); }
        $("gpxStudio").src = gpxStudioURL(gpxURL);
      } else {
        $("gpxCard").remove();
      }

      status.textContent = "Loaded ✓";
      setTimeout(()=> status.remove(), 1200);
    }

    if (typeof window !== "undefined") { main(); }
  </script>
</body>
</html>
