<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition</title>

  <!-- Your exported font-face rules -->
  <link rel="stylesheet" href="/fonts.css" />

  <style>
    /* Your tokens (you pasted this earlier) */
    :root{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}*{box-sizing:border-box;-webkit-font-smoothing:inherit}h1,h2,h3,h4,h5,h6,p,figure{margin:0}body,input,textarea,select,button{font-size:12px;font-family:sans-serif}body{--token-1f6852e9-1497-4551-bef7-299f387d8f98: rgb(232, 229, 226);--token-7712de8b-cd5c-4040-8ffb-91f4bea9bb25: rgb(30, 30, 30);--token-35c36f3c-8523-4623-83f9-76c6f492ff46: rgb(255, 255, 255);--token-427ec4a1-6126-417a-9822-7f4f7c9d8aff: rgb(254, 87, 51)}

    /* Aliases so the rest of the CSS can be readable */
    :root{
      --bg: var(--token-1f6852e9-1497-4551-bef7-299f387d8f98);
      --ink: var(--token-7712de8b-cd5c-4040-8ffb-91f4bea9bb25);
      --paper: var(--token-35c36f3c-8523-4623-83f9-76c6f492ff46);
      --accent: var(--token-427ec4a1-6126-417a-9822-7f4f7c9d8aff);
      --font-sans: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;

      --h1: clamp(32px, 7vw, 56px);
      --h2: clamp(22px, 2.2vw, 32px);
      --h3: clamp(18px, 1.8vw, 24px);
      --body: 16px;
      --small: 13px;
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    img { display:block; max-width:100%; height:auto; }
    a { color: inherit; text-underline-offset: 2px; }

    /* Grid: content column + gutters */
    .page {
      display: grid;
      grid-template-columns: minmax(16px, 1fr) minmax(0, 1120px) minmax(16px, 1fr);
      grid-auto-rows: min-content;
      row-gap: 24px;
    }
    .page > * { grid-column: 2; }

    /* Title + meta (top) */
    .title-wrap { padding-top: 8px; }
    .title { font-size: var(--h1); line-height: 1.05; font-weight: 700; }
    .meta {
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px 32px;
      font-size: clamp(14px, 1.6vw, 18px);
    }
    .meta .label {
      letter-spacing: .18em;
      font-size: var(--small);
      opacity: .6;
    }
    .meta .value { font-weight: 500; }

    /* FULL-BLEED hero below meta */
    .hero-bleed { grid-column: 1 / -1; }
    .hero-bleed img { width: 100%; height: auto; }
    .credit {
      grid-column: 2;        /* align with content column */
      text-align: right;
      font-size: var(--small);
      margin-top: 8px;
    }
    .credit a { color: var(--accent); text-decoration: underline; }

    /* Body copy block (“Mission Brief” content) */
    .pre {
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: clamp(16px, 1.6vw, 18px);
    }

    /* Generic embed (no borders/radius) */
    .embed { aspect-ratio: 16/9; }
    .embed iframe { width: 100%; height: 100%; border: 0; display:block; }

    /* GPX area */
    .gpx { display: grid; row-gap: 12px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding: 12px 18px; border-radius: 999px; border: 1px solid rgba(0,0,0,.12);
      background: var(--paper); font-weight: 600; width: max-content; margin: 0 auto; /* centered */
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    /* Tablet */
    @media (max-width: 810px) {
      .page { grid-template-columns: 12px minmax(0, 1fr) 12px; }
      .meta { grid-template-columns: 1fr 1fr; gap: 16px 20px; }
    }
    /* Phone */
    @media (max-width: 480px) {
      .page { grid-template-columns: 8px minmax(0, 1fr) 8px; }
      .title { font-size: clamp(28px, 9vw, 40px); }
      .meta { grid-template-columns: 1fr 1fr; }
    }

    .status { font-size: 12px; opacity:.7; text-align:center; padding:6px 0; }
  </style>
</head>
<body>
  <div class="page">
    <div id="status" class="status">Loading…</div>

    <!-- Title + Meta -->
    <section class="title-wrap">
      <h1 id="title" class="title"></h1>
      <div class="meta">
        <div>
          <div class="label">CATEGORY</div>
          <div id="category" class="value"></div>
        </div>
        <div>
          <div class="label">SEASON</div>
          <div id="season" class="value"></div>
        </div>
        <div>
          <div class="label">LOCATION</div>
          <div id="location" class="value"></div>
        </div>
        <div>
          <div class="label">DATE</div>
          <div id="date" class="value mono"></div>
        </div>
      </div>
    </section>

    <!-- FULL-BLEED Hero (image) -->
    <figure class="hero-bleed">
      <img id="hero" alt="Expedition hero image" />
    </figure>
    <div id="credit" class="credit"></div>

    <!-- Mission Brief text -->
    <section>
      <div id="mission" class="pre"></div>
    </section>

    <!-- Google Map (no header) -->
    <section>
      <div class="embed">
        <iframe id="map" allowfullscreen loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
    </section>

    <!-- GPX Studio (embed first, button centered below) -->
    <section class="gpx">
      <div class="embed">
        <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <a id="gpxBtn" class="btn" href="#" download>
        <span>⬇️ Download GPX</span>
      </a>
      <div class="mono" id="trailheads" style="text-align:center;"></div>
    </section>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = (id) => document.getElementById(id);
    const get = (obj, path) => path.split('.').reduce((o,k)=>o?.[k], obj);
    const first = (obj, keys) => keys.map(k => get(obj, k)).find(v => v !== undefined && v !== null && v !== "");
    const setText = (id, val) => { const el=$(id); if(!val){el?.remove();return;} el.textContent=val; };
    const setHTML = (id, val) => { const el=$(id); if(!val){el?.remove();return;} el.innerHTML=val; };
    const setSrc  = (id, val) => { const el=$(id); if(!val){el?.closest('section,figure,div')?.remove();return;} el.src=val; };

    // Build GPX Studio URL from a public GPX file
    const gpxStudioURL = (gpxUrl) => {
      if(!gpxUrl) return "";
      const state = { traces: [{ url: gpxUrl }], settings: { units: "imperial" } };
      return "https://gpx.studio/?state=" + encodeURIComponent(JSON.stringify(state));
    };

    // Slug: supports /expedition/{slug} and ?slug=…
    function getSlug(){
      const u = new URL(location.href);
      const qs = u.searchParams.get("slug");
      if(qs) return qs;
      const parts = u.pathname.split("/").filter(Boolean);
      const idx = parts.findIndex(p => p.toLowerCase() === "expedition");
      return idx > -1 ? parts[idx+1] : parts[parts.length-1];
    }

    async function main(){
      const status = $("status");
      const slug = getSlug();
      if(!slug){ status.textContent="Missing slug (use /expedition/{slug} or ?slug=)"; return; }

      // Your Supabase bucket is "expedition" (singular)
      const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json`;

      status.textContent = "Fetching expedition…";
      let data;
      try{
        const res = await fetch(jsonURL, { cache: "no-store" });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        data = await res.json();
      }catch(err){
        status.textContent = `Failed to fetch ${jsonURL}: ${err.message}`;
        return;
      }

      // Title + meta
      setText("title",     first(data, ["title"]));
      setText("category",  first(data, ["category"]));
      setText("season",    first(data, ["season"]));
      setText("location",  first(data, ["location"]));
      setText("date",      first(data, ["date"]));

      // Hero + credit (credit links to image_link, not the image itself)
      const hero = first(data, ["hero_image","image"]);
      const creditName = first(data, ["image_credit","credit_name"]);
      const creditHref = first(data, [
        "image_link",               // Unsplash page URL (your sheet field)
        "image_credit_link",
        "credit_link",
        "unsplash_link",
        "unsplash_url"
      ]) || (hero && /images\.unsplash\.com/i.test(hero) ? hero : "");

      setSrc("hero", hero);

      if(creditName){
        const creditEl = $("credit");
        creditEl.innerHTML = creditHref
          ? `<a href="${creditHref}" target="_blank" rel="noopener noreferrer">${creditName} (Unsplash)</a>`
          : `${creditName} (Unsplash)`;
      } else {
        $("credit")?.remove();
      }

      // Mission text (keep line breaks)
      const missionText = first(data, ["mission_text","brief","content"]) || "";
      setHTML("mission", missionText.replace(/\\n/g, "<br/>"));

      // Google map (use map_embed_url or map_embed)
      const mapURL = first(data, ["map_embed_url","map_embed"]);
      setSrc("map", mapURL);

      // GPX (iframe + centered button below)
      const gpxURL = first(data, ["gpx_download_link","gpx_url","gpx"]);
      if(gpxURL){
        $("gpxBtn").href = gpxURL;
        $("gpxBtn").download = (slug || "route") + ".gpx";
        setSrc("gpxStudio", gpxStudioURL(gpxURL));
        const startTH = first(data, ["start_trailhead"]);
        const endTH   = first(data, ["end_trailhead"]);
        setText("trailheads", [startTH,endTH].filter(Boolean).join(" → "));
      } else {
        // hide the whole GPX section if not present
        $("gpxStudio")?.closest("section")?.remove();
      }

      status.textContent = "Loaded ✓";
      setTimeout(()=> status.remove(), 1200);
    }

    if (typeof window !== "undefined") main();
  </script>
</body>
</html>
