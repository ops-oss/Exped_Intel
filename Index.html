<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition</title>

  <!-- Your font-face bundle -->
  <link rel="stylesheet" href="/fonts.css" />

  <style>
    :root{
      /* from your tokens */
      --bg: rgb(232, 229, 226);
      --ink: rgb(30, 30, 30);
      --paper: rgb(255, 255, 255);
      --accent: rgb(254, 87, 51);
      --font-sans: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;

      /* desktop / tablet title scale */
      --h1: clamp(28px, 8vw, 64px);
      --label: 14px;
      --body: 18px;
    }

    /* global */
    *{ box-sizing: border-box }
    html, body { height: 100% }
    body{
      margin:0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--font-sans);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    img{ display:block; width:100%; height:auto }
    a{ color: inherit; text-underline-offset:2px }

    /* layout */
    .page{
      max-width: 1120px;
      margin: 0 auto;
      padding: 24px 16px 40px;
      display: grid;
      row-gap: 20px;
    }

    /* title + meta (top) */
    .title{ font-size: var(--h1); line-height: 1.08; font-weight: 700; letter-spacing: -0.02em }
    .label{ font-size: var(--label); letter-spacing: .18em; text-transform: uppercase; opacity:.7 }
    .grid2{
      display:grid; grid-template-columns: 1fr 1fr; gap: 16px 28px; align-items: start;
      margin-top: 8px;
    }
    .value{ font-size: clamp(18px, 2.6vw, 28px); line-height: 1.28 }

    /* hero image comes AFTER title/meta */
    .credit{
      text-align: right;
      font-size: 14px;
      margin-top: 8px;
      color: var(--accent);
    }

    /* mission text block (no borders) */
    .mission{
      font-size: var(--body);
      line-height: 1.6;
      margin-top: 8px;
      white-space: pre-wrap;
    }

    /* embeds (no borders/radius) */
    .embed{ aspect-ratio: 16/9 }
    .embed iframe{ width:100%; height:100%; border:0; display:block }

    /* GPX area: map first, then button */
    .gpx-actions{
      margin-top: 14px;
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:center;           /* center the button */
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding: 14px 22px;
      font-weight: 700;
      background: #000;                 /* solid black */
      color: #fff;                      /* white text */
      border: 0;
      border-radius: 999px;             /* pill */
      text-decoration: none;
    }

    /* responsive */
    @media (max-width: 810px){
      .grid2{ grid-template-columns: 1fr 1fr; gap: 10px 18px }
      .value{ font-size: clamp(18px, 4.6vw, 24px) }
    }

    /* phone tweaks to match your screenshots */
    @media (max-width: 480px){
      .page{ padding: 20px 12px 32px }

      /* title size: push larger on phones to match your design */
      .title{ font-size: clamp(34px, 16vw, 64px); line-height: 1.06 }

      /* taller, “portrait-ish” iframes on mobile */
      .embed{ aspect-ratio: 4 / 5; }   /* ~vertical for Google Map & GPX */

      /* hero credit stays subtle but readable under image */
      .credit{ font-size: 14px; }
    }

    /* load status (debug only) */
    #status{ font-size:12px; opacity:.7 }
  </style>
</head>
<body>
  <div class="page">
    <div id="status">Loading…</div>

    <!-- Title & meta FIRST -->
    <h1 id="title" class="title"></h1>

    <div class="grid2">
      <div>
        <div class="label">Category</div>
        <div id="category" class="value"></div>
      </div>
      <div>
        <div class="label">Season</div>
        <div id="season" class="value"></div>
      </div>
      <div>
        <div class="label">Location</div>
        <div id="location" class="value"></div>
      </div>
      <div>
        <div class="label">Date</div>
        <div id="date" class="value"></div>
      </div>
    </div>

    <!-- Hero image SECOND -->
    <img id="hero" alt="Expedition hero" />
    <div id="credit" class="credit"></div>

    <!-- Mission -->
    <div id="mission" class="mission"></div>

    <!-- Google Map (no header) -->
    <div class="embed">
      <iframe id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>

    <!-- GPX Studio (map first, then button) -->
    <div class="embed" id="gpxEmbedWrap">
      <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
    <div class="gpx-actions" id="gpxActions">
      <a id="gpxBtn" class="btn" href="#" download>DOWNLOAD GPX</a>
      <!-- keep the “Open in GPX Studio” action available but hidden per your request -->
      <a id="gpxStudioLink" class="btn" href="#" target="_blank" rel="noopener" style="display:none">Open in GPX Studio</a>
      <span id="trailheads" style="opacity:.7; display:none"></span>
    </div>
  </div>

  <script>
    // ------------ small helpers ------------
    const $ = (id) => document.getElementById(id);
    const qp = (k) => new URL(location.href).searchParams.get(k);
    const get = (o,p)=>p.split('.').reduce((a,c)=>a?.[c],o);
    const first = (o,keys)=>{ for(const k of keys){ const v=get(o,k); if(typeof v==="string"&&v.trim()) return v.trim(); if(v) return v; } return ""; };

    function getSlug(){
      const q = qp("slug"); if (q) return q;
      const parts = (location.pathname||"/").split("/").filter(Boolean);
      const i = parts.findIndex(p=>p.toLowerCase()==="expedition");
      return i>-1 ? parts[i+1] : null;
    }
    function unsplashish(u){ return typeof u==="string" && /images\.unsplash\.com/i.test(u); }
    function gpxStudioURL(gpxUrl){
      if(!gpxUrl) return "";
      // add a tiny cache-buster so GPX Studio always re-pulls the file
      const u = new URL(gpxUrl);
      u.searchParams.set("_t", Date.now().toString());
      return "https://gpx.studio/?state="+encodeURIComponent(JSON.stringify({
        traces:[{url:u.toString()}],
        settings:{units:"imperial"}
      }));
    }

    async function main(){
      const status = $("status");
      const slug = getSlug();
      if(!slug){ status.textContent="Missing slug (?slug= or /expedition/{slug})"; return; }

      const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json?cb=${Date.now()}`;
      status.textContent = "Fetching…";

      let data;
      try{
        const res = await fetch(jsonURL, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP "+res.status);
        data = await res.json();
      }catch(e){
        status.textContent = "Fetch failed: "+e.message;
        return;
      }

      // Title + meta
      $("title").textContent = first(data,["title","name"]) || "";
      $("category").textContent = first(data,["category","type"]) || "";
      $("season").textContent = first(data,["season"]) || "";
      $("location").textContent = first(data,["location","place"]) || "";
      const d = first(data,["date","when"]);
      $("date").textContent = /^\d{4}-\d{2}-\d{2}$/.test(d) ? new Date(d+"T00:00:00Z").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"}) : (d||"");

      // Hero + credit (credit is a link to image_link if present; fallback to hero if Unsplash)
      const hero = first(data,["hero_image","hero.url","image"]);
      if(hero) $("hero").src = hero;
      const creditName = first(data,["image_credit","credit","photo_credit"]);
      let creditLink = first(data,["image_link","credit_link","image_credit_link"]);
      if(!creditLink && unsplashish(hero)) creditLink = hero;
      $("credit").innerHTML = creditName ? (creditLink ? `<a href="${creditLink}" target="_blank" rel="noopener noreferrer">${creditName}</a>` : creditName) : "";

      // Mission
      const mission = first(data,["mission_text","mission","brief","summary"]) || "";
      $("mission").innerHTML = mission.replace(/\n/g,"<br/>");

      // Google Map (expect full embed URL in JSON)
      const mapURL = first(data,["map_embed_url","map_embed","map.url"]);
      if(mapURL) $("map").src = mapURL;

      // GPX embed + button (uses gpx_download_link / gpx_url)
      const gpxURL = first(data,["gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"]);
      if(gpxURL){
        const studio = gpxStudioURL(gpxURL);
        $("gpxStudio").src = studio;           // the iframe
        $("gpxStudioLink").href = studio;      // (hidden) direct link
        $("gpxBtn").href = gpxURL;             // download button
        $("gpxBtn").download = (slug||"route") + ".gpx";
      }else{
        $("gpxEmbedWrap").innerHTML = `<div style="opacity:.7;font-size:14px">No GPX URL found (expected <code>gpx_download_link</code>).</div>`;
        $("gpxActions").style.display = "none";
      }

      status.textContent = "";
      setTimeout(()=>status.remove(), 10);
    }

    if (typeof window !== "undefined") main();
  </script>
</body>
</html>
