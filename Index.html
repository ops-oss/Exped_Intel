<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition</title>

  <link rel="stylesheet" href="/fonts.css" />

  <style>
    :root{
      --bg: rgb(232, 229, 226);
      --ink: rgb(30, 30, 30);
      --paper: #fff;
      --accent: rgb(254, 87, 51);
      --font-sans: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;
      --h1: clamp(40px, 18vw, 88px);
      --label: 14px;
      --body: 18px;
      --line: rgba(0,0,0,.12);
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink); font-family:var(--font-sans);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    img{ display:block; width:100%; height:auto }
    a{ color:inherit; text-underline-offset:2px }

    .page{ max-width:1120px; margin:0 auto; padding:24px 16px 40px; display:grid; row-gap:20px; }
    .title{ font-size:var(--h1); line-height:1.02; font-weight:700; letter-spacing:-0.02em; margin:8px 0 0; }

    /* actions under title */
    .actions{ display:flex; gap:12px; flex-wrap:wrap; margin-top:10px }
    .btn{
      display:inline-flex; align-items:center; gap:10px; padding:10px 16px;
      border:1px solid var(--line); border-radius:999px; background:transparent;
      font-weight:700; text-decoration:none; color:inherit;
    }
    .btn svg{ width:20px; height:20px; display:block }
    .btn:active{ transform:translateY(1px) }

    .label{ font-size:var(--label); letter-spacing:.18em; text-transform:uppercase; opacity:.7; display:flex; align-items:center; gap:.45rem }
    .label .ico{ width:clamp(16px,1.6vw,20px); height:clamp(16px,1.6vw,20px); color:inherit }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:16px 28px; align-items:start; margin-top:8px; }
    @media (min-width:960px){ .grid2{ grid-template-columns:repeat(4,1fr); } }
    .value{ font-size:clamp(18px,2.6vw,28px); line-height:1.28 }

    .fullbleed{ width:100vw; margin-left:calc(50% - 50vw); }
    #heroLink{ display:block; }
    .credit{ text-align:right; font-size:14px; margin-top:8px; color:var(--accent); padding-right:16px; }
    .credit a{ text-decoration:underline; cursor:pointer; }

    /* mission formatter area */
    .mission{ font-size:var(--body); line-height:1.6; margin-top:8px; white-space:pre-wrap; max-width:820px; margin-left:auto; margin-right:auto; text-align:left; }
    .mission strong{ font-weight:800 }
    .section-rule{ height:1px; background:var(--line); width:100%; margin:18px 0; }

    /* section headings used outside mission */
    h2.section{
      font-size:clamp(22px,4.6vw,30px); font-weight:800; letter-spacing:-.01em;
      display:flex; align-items:center; gap:10px; margin:26px 0 8px;
    }
    h2.section svg{ width:26px; height:26px }

    /* embeds */
    .embed{ background:rgba(255,255,255,.6); border:1px solid var(--line); border-radius:16px; overflow:hidden; aspect-ratio:16/9 }
    .embed iframe{ width:100%; height:100%; border:0; display:block }
    @media (max-width:480px){ .embed{ aspect-ratio:3/4 } }

    /* GPX action row */
    .gpx-actions{ margin-top:14px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .btn-solid{ background:#000; color:#fff; border-color:#000; }
    .hint{ font-size:13px; opacity:.75; text-align:center; max-width:820px; margin:8px auto 0; }

    #status{ font-size:12px; opacity:.7; max-width:720px; margin:0 auto; }

    /* Icon sprite sizing helper (inside labels and injected headers) */
    .ico{ display:inline-block; color:currentColor }
    .ico svg{ display:block; width:100%; height:100% }
  </style>
</head>
<body>
  <!-- INLINE ICON SPRITE (matching ei_full_mock_days style) -->
  <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden">
    <symbol id="i-bookmark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linejoin="round">
      <path d="M6.5 3h11A1.5 1.5 0 0 1 19 4.5V21l-7-3.8L5 21V4.5A1.5 1.5 0 0 1 6.5 3z"/>
    </symbol>
    <symbol id="i-share" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M8 14l8-4M8 18l8-4"/><circle cx="16" cy="7" r="3"/><circle cx="8" cy="17" r="3"/><circle cx="16" cy="13" r="3"/>
    </symbol>
    <symbol id="i-print" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M7 8V4h10v4"/><rect x="4" y="8" width="16" height="8" rx="2"/><path d="M7 16v4h10v-4"/>
    </symbol>
    <symbol id="i-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 21s-7-6.2-7-11a7 7 0 1 1 14 0c0 4.8-7 11-7 11z"/><circle cx="12" cy="10" r="2.4"/>
    </symbol>
    <symbol id="i-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.5 4.5l1.5 1.5M18 18l1.5 1.5M4.5 19.5l1.5-1.5M18 6l1.5-1.5"/>
    </symbol>
    <symbol id="i-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="5" width="18" height="16" rx="2"/><path d="M3 10h18M8 3v4M16 3v4"/>
    </symbol>
    <symbol id="i-compass" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="9"/><path d="M15.5 8.5l-3.6 1.5-1.5 3.6 3.6-1.5z"/>
    </symbol>
    <symbol id="i-bus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="3" width="18" height="14" rx="2"/><path d="M8 21v-2M16 21v-2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/>
    </symbol>
    <symbol id="i-map" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"/><path d="M9 3v15"/><path d="M15 6v15"/>
    </symbol>
    <symbol id="i-route" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="6" cy="6" r="2"/><circle cx="18" cy="18" r="2"/><path d="M8 6h4a4 4 0 0 1 4 4v0a4 4 0 0 0 4 4"/>
    </symbol>
    <symbol id="i-signpost" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 3v18"/><path d="M4 6h10l3 3H7z"/><path d="M20 14H10l-3-3h10z"/>
    </symbol>
    <symbol id="i-mountain" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 21l9-18 9 18H3z"/><path d="M12 9l2 4h-4l2-4z"/>
    </symbol>
    <symbol id="i-ruler" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="6" width="18" height="12" rx="2"/></symbol>
    <symbol id="i-cloudsun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="5" cy="7" r="2"/><path d="M5 3v2M5 9v2M1 7h2M7 7h2"/><path d="M10 17h7a3 3 0 0 0 0-6 4 4 0 0 0-7 0 3 3 0 0 0 0 6z"/>
    </symbol>
    <symbol id="i-clipboard" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="6" y="4" width="12" height="16" rx="2"/><path d="M9 4V2h6v2"/>
    </symbol>
    <symbol id="i-shield-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2l8 4v6c0 5-3.5 9-8 10-4.5-1-8-5-8-10V6l8-4z"/><path d="M12 8v5"/><path d="M12 16h.01"/>
    </symbol>
    <symbol id="i-phone" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="7" y="2" width="10" height="20" rx="2"/><path d="M11 18h2"/>
    </symbol>
    <symbol id="i-file-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/><path d="M12 11v4"/><path d="M12 18h.01"/>
    </symbol>
  </svg>

  <div class="page">
    <div id="status">Loadingâ€¦</div>

    <h1 id="title" class="title"></h1>

    <!-- Actions -->
    <div class="actions" aria-label="Page actions">
      <button id="actBookmark" class="btn" type="button" title="Bookmark">
        <svg aria-hidden="true"><use href="#i-bookmark"/></svg><span>Bookmark</span>
      </button>
      <button id="actShare" class="btn" type="button" title="Share">
        <svg aria-hidden="true"><use href="#i-share"/></svg><span>Share</span>
      </button>
      <button id="actPrint" class="btn" type="button" title="Print">
        <svg aria-hidden="true"><use href="#i-print"/></svg><span>Print</span>
      </button>
    </div>

    <!-- Meta row with icons by the LABELS -->
    <div class="grid2">
      <div>
        <div class="label"><span class="ico" aria-hidden="true" style="width:20px;height:20px"><svg><use href="#i-compass"/></svg></span> Category</div>
        <div id="category" class="value"></div>
      </div>
      <div>
        <div class="label"><span class="ico" aria-hidden="true" style="width:20px;height:20px"><svg><use href="#i-sun"/></svg></span> Season</div>
        <div id="season" class="value"></div>
      </div>
      <div>
        <div class="label"><span class="ico" aria-hidden="true" style="width:20px;height:20px"><svg><use href="#i-pin"/></svg></span> Location</div>
        <div id="location" class="value"></div>
      </div>
      <div>
        <div class="label"><span class="ico" aria-hidden="true" style="width:20px;height:20px"><svg><use href="#i-calendar"/></svg></span> Date</div>
        <div id="date" class="value"></div>
      </div>
    </div>

    <!-- Hero -->
    <div class="fullbleed">
      <a id="heroLink" href="#" target="_blank" rel="noopener noreferrer" aria-label="Photo credit link">
        <img id="hero" alt="Expedition hero" />
      </a>
      <div id="credit" class="credit"></div>
    </div>

    <!-- Map near the top -->
    <h2 class="section"><svg aria-hidden="true"><use href="#i-bus"/></svg> Shuttle / Transportation Map</h2>
    <div class="embed">
      <iframe id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>

    <div class="section-rule"></div>

    <!-- Mission (JSON-rendered body with icons injected for headers + day lines) -->
    <div id="mission" class="mission"></div>

    <div class="section-rule"></div>

    <!-- GPX near the end -->
    <h2 class="section"><svg aria-hidden="true"><use href="#i-map"/></svg> GPX Route & Elevation</h2>
    <div class="embed" id="gpxEmbedWrap">
      <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    </div>
    <div class="gpx-actions" id="gpxActions">
      <a id="gpxBtn" class="btn btn-solid" href="#" download><svg aria-hidden="true"><use href="#i-route"/></svg> Download GPX</a>
      <a id="gpxStudioLink" class="btn" href="#" target="_blank" rel="noopener"><svg aria-hidden="true"><use href="#i-route"/></svg> Open in GPX Studio</a>
      <span id="trailheads" style="opacity:.7"></span>
    </div>
    <div class="hint">Starter GPX â€” review and adjust in your mapping app.<br><strong>Do not rely on it as your only navigation source.</strong></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const qp = (k) => new URL(location.href).searchParams.get(k);
    const get = (o,p)=>p.split('.').reduce((a,c)=>a?.[c],o);
    const first = (o,keys)=>{ for(const k of keys){ const v=get(o,k); if(typeof v==="string"&&v.trim()) return v.trim(); if(v) return v; } return ""; };

    function getSlug(){
      const q = qp("slug"); if (q) return q;
      const parts = (location.pathname||"/").split("/").filter(Boolean);
      const i = parts.findIndex(p=>p.toLowerCase()==="expedition" || p.toLowerCase()==="trip");
      return i>-1 ? parts[i+1] : null;
    }

    const MAPBOX_TOKEN = "pk.eyJ1IjoiZXhwZWQtaW50ZWwiLCJhIjoiY21kc3Vrc2FtMHZkNjJrcTN6ajlmZzhlMyJ9.APi1rguilYM8GZKBnbyWFg";
    function gpxStudioURL(gpxUrl){
      if(!gpxUrl) return "";
      const options = { token: MAPBOX_TOKEN, files: [ gpxUrl ], distanceUnits: "imperial" };
      return "https://gpx.studio/embed?options=" + encodeURIComponent(JSON.stringify(options));
    }

    function safeParse(text){
      try{
        let x = JSON.parse(text);
        if (typeof x === "string") {
          try { x = JSON.parse(x); } catch {}
        }
        return x;
      }catch{ return null; }
    }

    function normalizeData(raw){
      if (typeof raw === "string") {
        const again = safeParse(raw);
        if (again) raw = again;
      }
      if (raw && (raw.schema_version || raw.hero_image || raw.image_link || raw.mission_text)) return raw;
      let full = null, flat = null;
      if (typeof raw?.index_json === "string") { full = safeParse(raw.index_json); }
      else if (raw?.index_json && typeof raw.index_json === "object") { full = raw.index_json; }
      if (typeof raw?.flat_json === "string") { flat = safeParse(raw.flat_json); }
      else if (raw?.flat_json && typeof raw.flat_json === "object") { flat = raw.flat_json; }
      let out = { ...(full || {}), ...(flat || {}) };
      if (out && !out.image_link) out.image_link = out.imageLink || out.credit_link || out.image_credit_link || "";
      if (out && !out.image_credit) out.image_credit = out.imageCredit || out.photo_credit || "";
      if (out && !out.hero_image) out.hero_image = out.hero?.url || out.image || out.heroImage || "";
      return Object.keys(out).length ? out : raw;
    }

    const isValidUnsplashPhoto = (u)=>{
      try{
        const x = new URL(u);
        return x.hostname === "unsplash.com" && /^\/photos\/[A-Za-z0-9_-]+/.test(x.pathname);
      }catch{ return false; }
    };

    // Top action buttons
    (function wireActions(){
      const actBookmark = $("actBookmark");
      const actShare = $("actShare");
      const actPrint = $("actPrint");
      const key = "ei_bookmarks";
      const slug = getSlug() || location.href;

      function getSaved(){
        try{ return JSON.parse(localStorage.getItem(key) || "[]"); }catch{ return []; }
      }
      function setSaved(list){ localStorage.setItem(key, JSON.stringify(list)); }
      function isSaved(){ return getSaved().includes(slug); }
      function update(){ actBookmark.dataset.active = isSaved() ? "1" : "0"; }

      actBookmark.addEventListener("click", ()=>{
        const list = getSaved();
        const i = list.indexOf(slug);
        if(i>-1) list.splice(i,1); else list.push(slug);
        setSaved(list); update();
      });
      actShare.addEventListener("click", async ()=>{
        const url = location.href;
        try{
          if(navigator.share){
            await navigator.share({ title: document.title || "Expedition", url });
          }else{
            await navigator.clipboard.writeText(url);
            actShare.dataset.active = "1";
            setTimeout(()=>actShare.dataset.active="0", 900);
          }
        }catch{}
      });
      actPrint.addEventListener("click", ()=>window.print());
      update();
    })();

    // Render mission with icons on section headers + day lines
    function renderMission(mission){
      const headerIconMap = new Map([
        ["PERMITS & ENTRY","i-clipboard"],
        ["SHUTTLE / TRANSPORTATION","i-bus"],
        ["MULTI-TRAILHEAD LOGISTICS","i-signpost"],
        ["KEY CONSIDERATIONS","i-clipboard"],
        ["PERMIT & SHUTTLE TIMELINE","i-calendar"],
        ["CAMPSITE INTEL","i-clipboard"],
        ["WEATHER & ALTITUDE NOTES","i-cloudsun"],
        ["GEAR CHECKLIST","i-clipboard"],
        ["OPTIONAL MODIFICATION","i-signpost"],
        ["RISK MATRIX & HAZARD TIMELINE","i-shield-alert"],
        ["CONDITIONS WATCH","i-shield-alert"],
        ["BAILOUT SUMMARY","i-signpost"],
        ["EMERGENCY CONTACTS & NUMBERS","i-phone"],
        ["FINAL BRIEF SUMMARY","i-clipboard"],
        ["FIELD DISCLAIMER","i-file-warning"]
      ]);

      const lines = mission.split(/\r?\n/).map(line => line.trim());
      const out = [];

      for (let t of lines){
        if (!t) { out.push(""); continue; }

        // Horizontal rule lines like 'â¸»' or '---'
        if (/^(-{3,}|â¸»)$/.test(t)) { out.push('<div class="section-rule"></div>'); continue; }

        // DAY N: headers
        if (/^DAY\s*\d+:/i.test(t)){
          out.push(
            `<strong><span class="ico" aria-hidden="true" style="width:22px;height:22px;vertical-align:-3px"><svg><use href="#i-signpost"/></svg></span> ${t}</strong>`
          );
          continue;
        }

        // UPPERCASE headers with colon (e.g., PRIMARY OBJECTIVE: ...)
        const m = t.match(/^([^:]+):\s*(.*)$/);
        if (m && !/[a-z]/.test(m[1])) {
          const hdr = m[1].trim();
          const rest = m[2] || "";
          const iconId = headerIconMap.get(hdr);
          if (iconId){
            out.push(
              `<strong><span class="ico" aria-hidden="true" style="width:22px;height:22px;vertical-align:-3px"><svg><use href="#${iconId}"/></svg></span> ${hdr}:</strong> ${rest}`
            );
          } else {
            out.push(`<strong>${hdr}:</strong> ${rest}`);
          }
          continue;
        }

        // All-caps single-line headers without colon (e.g., EXPEDITION ITINERARY â€¦)
        if (!/[a-z]/.test(t)) {
          const iconId = headerIconMap.get(t);
          if (iconId){
            out.push(
              `<strong><span class="ico" aria-hidden="true" style="width:22px;height:22px;vertical-align:-3px"><svg><use href="#${iconId}"/></svg></span> ${t}</strong>`
            );
          } else {
            out.push(`<strong>${t}</strong>`);
          }
          continue;
        }

        // Normal paragraph/list line
        out.push(t);
      }

      return out.join("<br/>");
    }

    async function main(){
      const status = $("status");
      const slug = getSlug();
      if(!slug){ status.textContent="Missing slug (?slug= or /expedition/{slug})"; return; }

      const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json?cb=${Date.now()}`;
      status.textContent = "Fetchingâ€¦";

      let data;
      try{
        const res = await fetch(jsonURL, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        let raw = safeParse(text);
        if (raw === null) raw = {};
        data = normalizeData(raw);
      }catch(e){
        status.textContent = "Fetch failed: "+e.message;
        return;
      }

      $("title").textContent = first(data,["title","name"]) || "";
      $("category").textContent = first(data,["category","type"]) || "";
      $("season").textContent = first(data,["season"]) || "";
      $("location").textContent = first(data,["location","place"]) || "";
      const d = first(data,["date","when"]);
      $("date").textContent = /^\d{4}-\d{2}-\d{2}$/.test(d)
        ? new Date(d+"T00:00:00Z").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"})
        : (d||"");

      const hero = first(data,["hero_image","hero.url","image"]);
      if (hero) $("hero").src = hero;

      const creditName = first(data,["image_credit","credit","photo_credit"]) || "";
      let creditLink = first(data,["image_link","credit_link","image_credit_link"]) || "";
      if (!isValidUnsplashPhoto(creditLink)) creditLink = "";

      $("credit").innerHTML = creditName
        ? (creditLink
            ? `<a href="${creditLink}" target="_blank" rel="noopener noreferrer" title="${creditLink}">${creditName}</a>`
            : creditName)
        : "";

      const heroLinkEl = $("heroLink");
      if (heroLinkEl) {
        if (creditLink) {
          heroLinkEl.href = creditLink;
          heroLinkEl.style.pointerEvents = "auto";
        } else {
          heroLinkEl.removeAttribute("href");
          heroLinkEl.style.pointerEvents = "none";
        }
      }

      const missionRaw = first(data,["mission_text","mission","brief","summary"]) || "";
      $("mission").innerHTML = renderMission(missionRaw);

      const mapURL = first(data,["map_embed_url","map_embed","map.url"]);
      if (mapURL) $("map").src = mapURL;

      const gpxURL = first(data,["gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"]);
      if (gpxURL) {
        const studio = gpxStudioURL(gpxURL);
        $("gpxStudio").src = studio;
        $("gpxStudioLink").href = studio;
        $("gpxBtn").href = gpxURL;
        $("gpxBtn").download = (slug||"route") + ".gpx";
        const th = [first(data,["start_trailhead","start"]), first(data,["end_trailhead","end"])].filter(Boolean).join(" â†’ ");
        if (th) $("trailheads").textContent = th;
      } else {
        $("gpxEmbedWrap").innerHTML = `<div style="opacity:.7;font-size:14px">No GPX URL found (expected <code>gpx_download_link</code>).</div>`;
        $("gpxActions").style.display = "none";
      }

      status.textContent = "";
      setTimeout(()=>status.remove(), 10);
    }

    if (typeof window !== "undefined") main();
  </script>
</body>
</html>
