<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Expedition</title>

<!-- Brand base -->
<style>
  :root{
    --bg: #E8E5E2;
    --ink: #1E1E1E;
    --paper: #fff;
    --pill: rgba(0,0,0,.06);
    --ink-soft: rgba(0,0,0,.62);
    --accent:#000; /* used only for primary CTAs */
    --h1: clamp(36px, 9vw, 72px);
    --h2: clamp(22px, 4.2vw, 32px);
    --label: 13px;
    --body: clamp(18px, 2.7vw, 20px);
    --small: 14px;
    --radius: 14px;
    --radius-pill: 28px;
    --gap: 18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  img{display:block; width:100%; height:auto}
  a{color:inherit; text-underline-offset:2px}
  .page{max-width:1120px; margin:0 auto; padding:28px 16px 48px; display:grid; row-gap:22px}
  .title{font-size:var(--h1); line-height:1; font-weight:800; letter-spacing:-.02em}

  /* top actions */
  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; background:var(--pill); border:1px solid rgba(0,0,0,.08); font-weight:600; text-decoration:none}
  .btn.primary{background:#000; color:#fff; border-color:#000}
  .btn .ico{width:18px; height:18px; mask-size:contain; -webkit-mask-size:contain; background:currentColor}

  /* header facts */
  .facts{display:grid; grid-template-columns:1fr 1fr; gap:8px 22px}
  .fact{display:grid; gap:4px}
  .fact .label{font-size:var(--label); letter-spacing:.18em; text-transform:uppercase; color:var(--ink-soft)}
  .fact .value{font-size:clamp(18px,3.8vw,22px); font-weight:600}

  /* full-bleed hero */
  .fullbleed{width:100vw; margin-left:calc(50% - 50vw)}
  .credit{max-width:1120px; margin:6px auto 0; padding:0 16px; font-size:13px; color:#e35b4a; text-align:right}

  /* section blocks */
  section{scroll-margin-top:76px}
  .h2{display:flex; align-items:center; gap:10px; font-size:var(--h2); font-weight:800; letter-spacing:-.01em; margin:18px 0 8px}
  .h2 .ico{width:24px; height:24px; background:currentColor}
  .kv{display:grid; grid-template-columns: minmax(160px, 280px) 1fr; gap:10px 24px; align-items:start; font-size:var(--body)}
  .term{font-weight:800}
  .note{margin-top:8px; font-size:var(--small); color:var(--ink-soft)}

  /* chips / pills */
  .pills{display:flex; gap:10px; flex-wrap:wrap}
  .pill{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; background:var(--pill); border:1px solid rgba(0,0,0,.08); border-radius:var(--radius-pill); font-weight:600}
  .pill .ico{width:18px; height:18px; background:currentColor}

  /* itinerary day cards */
  .day{background:rgba(0,0,0,.05); border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:14px 14px 10px; margin:14px 0}
  .day h3{margin:0 0 6px; font-size:22px}
  .day p{margin:0 0 12px; font-size:var(--body); color:var(--ink)}
  .meta{display:flex; gap:10px; flex-wrap:wrap}
  .meta .pill{background:rgba(0,0,0,.06)}

  .embed{width:100%; aspect-ratio:16/9; border:0; border-radius:14px; overflow:hidden; background:#eee}
  /* taller on mobile for map + gpx */
  @media (max-width:600px){
    .embed{aspect-ratio:4/5}
  }

  /* disclaimer */
  .callout{margin-top:10px; font-size:var(--body)}
  .callout strong{font-weight:900}

  /* icons via CSS masks (single color, brand-neutral) */
  .ico{mask:no-repeat center / contain; -webkit-mask:no-repeat center / contain}
  .i-bookmark{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M7 3h10a2 2 0 0 1 2 2v16l-7-3-7 3V5a2 2 0 0 1 2-2z"/></svg>')}
  .i-like{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M12 21s-6.7-4.35-9.33-7A6 6 0 1 1 12 6a6 6 0 1 1 9.33 8c-2.63 2.65-9.33 7-9.33 7z"/></svg>')}
  .i-print{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M6 9V3h12v6H6zm12 2h2a2 2 0 0 1 2 2v6h-4v-4H6v4H2v-6a2 2 0 0 1 2-2h2v2h12v-2z"/></svg>')}
  .i-doc{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M14 2H6a2 2 0 0 0-2 2v16l6-3 6 3V8l-4-6z"/></svg>')}
  .i-triangle{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M12 3l10 18H2L12 3z"/></svg>')}
  .i-map{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M9 3l6 2 6-2v18l-6 2-6-2-6 2V5l6-2z"/></svg>')}
  .i-flag{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M6 3v18h2v-5h9l-2-4 2-4H8V3z"/></svg>')}
  .i-camp{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M12 3l9 18H3L12 3zM9 17h6l-3-6-3 6z"/></svg>')}
  .i-sun{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M12 4V2m0 20v-2m8-8h2M2 12h2m13.66 6.66l1.41 1.41M4.93 4.93l1.41 1.41m0 11.32L4.93 19.66M18.07 6.34l1.41-1.41M12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10z"/></svg>')}
  .i-pack{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M8 3h8a3 3 0 0 1 3 3v15H5V6a3 3 0 0 1 3-3zm0 6h8V7H8v2z"/></svg>')}
  .i-alert{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>')}
  .i-phone{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M6.6 10.8a15 15 0 0 0 6.6 6.6l2.2-2.2c.3-.3.7-.4 1.1-.3 1.2.4 2.6.7 4 .7.6 0 1 .4 1 1V22c0 .6-.4 1-1 1C10.1 23 1 13.9 1 2c0-.6.4-1 1-1h4.4c.6 0 1 .4 1 1 0 1.4.2 2.8.7 4 .1.4 0 .8-.3 1.1L6.6 10.8z"/></svg>')}
  .i-umbrella{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="black" d="M12 2C6.5 2 2 6 2 10h20c0-4-4.5-8-10-8zm0 10a2 2 0 0 0-2 2v5a2 2 0 0 0 4 0v-1h-2v-4a2 2 0 0 0-0-2z"/></svg>')}
  .i-generic{mask-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="black"/></svg>')}

  /* utilities */
  .muted{color:var(--ink-soft)}
  .divider{height:1px; background:rgba(0,0,0,.12); margin:18px 0}

  /* mobile */
  @media (max-width:800px){
    .facts{grid-template-columns:1fr}
    .kv{grid-template-columns: 1fr}
    .term{font-size:18px}
  }
</style>
</head>
<body>
<div class="page">

  <!-- Title -->
  <h1 id="title" class="title">Expedition</h1>

  <!-- Actions -->
  <div class="actions">
    <a class="btn" href="#" id="bookmarkBtn"><span class="ico i-bookmark"></span>Bookmark</a>
    <a class="btn" href="#" id="endorseBtn"><span class="ico i-like"></span>Endorse</a>
    <button class="btn" id="printBtn" type="button"><span class="ico i-print"></span>Print</button>
  </div>

  <!-- Header facts -->
  <div class="facts">
    <div class="fact">
      <div class="label"><span class="ico i-doc" style="width:14px;height:14px;vertical-align:-2px"></span> Category</div>
      <div id="hdrCategory" class="value"></div>
    </div>
    <div class="fact">
      <div class="label"><span class="ico i-sun" style="width:14px;height:14px;vertical-align:-2px"></span> Season</div>
      <div id="hdrSeason" class="value"></div>
    </div>
    <div class="fact">
      <div class="label"><span class="ico i-map" style="width:14px;height:14px;vertical-align:-2px"></span> Location</div>
      <div id="hdrLocation" class="value"></div>
    </div>
    <div class="fact">
      <div class="label"><span class="ico i-flag" style="width:14px;height:14px;vertical-align:-2px"></span> Date</div>
      <div id="hdrDate" class="value"></div>
    </div>
  </div>

  <!-- Hero -->
  <div class="fullbleed">
    <img id="hero" alt="" />
  </div>
  <div id="credit" class="credit"></div>

  <!-- Expedition Itinerary (top meta) -->
  <section id="meta">
    <div class="h2"><span class="ico i-doc"></span> Expedition Itinerary</div>
    <div class="kv">
      <div class="term">Route</div><div id="metaRoute"></div>
    </div>
  </section>

  <!-- Terrain -->
  <section id="terrain">
    <div class="h2"><span class="ico i-triangle"></span> Terrain Type</div>
    <div class="kv" id="terrainKV"></div>
  </section>

  <!-- Permits -->
  <section id="permits">
    <div class="h2"><span class="ico i-doc"></span> Permits & Entry</div>
    <div class="kv" id="permitsKV"></div>
    <div id="permitsVerify" class="note"></div>
  </section>

  <!-- Shuttle & Map -->
  <section id="shuttle">
    <div class="h2"><span class="ico i-map"></span> Shuttle / Transportation</div>
    <iframe id="map" class="embed" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    <div class="pills" id="shuttlePills" style="margin-top:12px"></div>
  </section>

  <!-- Multi-Trailhead Logistics -->
  <section id="multi">
    <div class="h2"><span class="ico i-flag"></span> Multi-Trailhead Logistics</div>
    <div class="kv" id="multiKV"></div>
  </section>

  <!-- Key Considerations -->
  <section id="keys">
    <div class="h2"><span class="ico i-umbrella"></span> Key Considerations</div>
    <div class="kv" id="keysKV"></div>
  </section>

  <!-- Timeline -->
  <section id="timeline">
    <div class="h2"><span class="ico i-doc"></span> Permit & Shuttle Timeline</div>
    <div class="kv" id="timelineKV"></div>
  </section>

  <!-- Itinerary Days -->
  <section id="days">
    <div class="h2"><span class="ico i-flag"></span> Itinerary Overview</div>
    <div id="dayWrap"></div>
  </section>

  <!-- Campsite Intel -->
  <section id="camps">
    <div class="h2"><span class="ico i-camp"></span> Campsite Intel</div>
    <div class="kv" id="campsKV"></div>
  </section>

  <!-- Weather & Altitude -->
  <section id="weather">
    <div class="h2"><span class="ico i-sun"></span> Weather & Altitude Notes</div>
    <div class="kv" id="weatherKV"></div>
  </section>

  <!-- Gear -->
  <section id="gear">
    <div class="h2"><span class="ico i-pack"></span> Gear Checklist</div>
    <div class="kv" id="gearKV"></div>
  </section>

  <!-- Optional Mods -->
  <section id="mods">
    <div class="h2"><span class="ico i-flag"></span> Optional Modification</div>
    <div class="kv" id="modsKV"></div>
  </section>

  <!-- Risk Matrix -->
  <section id="risk">
    <div class="h2"><span class="ico i-alert"></span> Risk Matrix & Hazard Timeline</div>
    <div class="kv" id="riskKV"></div>
  </section>

  <!-- Conditions -->
  <section id="conditions">
    <div class="h2"><span class="ico i-triangle"></span> Conditions Watch</div>
    <div class="kv" id="conditionsKV"></div>
  </section>

  <!-- Bailouts -->
  <section id="bail">
    <div class="h2"><span class="ico i-flag"></span> Bailout Summary</div>
    <div class="kv" id="bailKV"></div>
  </section>

  <!-- Emergency -->
  <section id="emergency">
    <div class="h2"><span class="ico i-phone"></span> Emergency Contacts & Numbers</div>
    <div class="kv" id="emKV"></div>
  </section>

  <!-- Final Brief -->
  <section id="final">
    <div class="h2"><span class="ico i-doc"></span> Final Brief Summary</div>
    <div class="kv" id="finalKV"></div>
  </section>

  <!-- GPX -->
  <section id="gpx">
    <div class="h2"><span class="ico i-map"></span> GPX Route & Elevation</div>
    <iframe id="gpxStudio" class="embed" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    <div class="actions" style="margin-top:12px">
      <a id="gpxBtn" class="btn primary" href="#" download><span class="ico i-doc"></span>Download GPX</a>
      <a id="gpxStudioLink" class="btn" href="#" target="_blank" rel="noopener"><span class="ico i-map"></span>Open in GPX Studio</a>
    </div>
    <p class="callout">Starter GPX — review and adjust in your mapping app.<br><strong>Do not rely on it as your only navigation source.</strong></p>
    <div class="pills" id="gpxStats" style="margin-top:8px"></div>
  </section>

  <!-- Disclaimer -->
  <section id="disclaimer">
    <div class="h2"><span class="ico i-doc"></span> Field Disclaimer</div>
    <div id="disclaimerText" style="font-size:var(--body); line-height:1.65"></div>
  </section>

</div>

<script>
  const $ = (id)=>document.getElementById(id);
  const qp = (k)=>new URL(location.href).searchParams.get(k);
  const get = (o,p)=>p.split('.').reduce((a,c)=>a?.[c],o);
  const first = (o,keys)=>{ for(const k of keys){ const v=get(o,k); if(typeof v==="string"&&v.trim()) return v.trim(); if(v) return v; } return ""; };

  function getSlug(){
    const q = qp("slug"); if (q) return q;
    const parts = (location.pathname||"/").split("/").filter(Boolean);
    const i = parts.findIndex(p=>["expedition","trip"].includes(p.toLowerCase()));
    return i>-1 ? parts[i+1] : null;
  }

  const MAPBOX_TOKEN = "pk.eyJ1IjoiZXhwZWQtaW50ZWwiLCJhIjoiY21kc3Vrc2FtMHZkNjJrcTN6ajlmZzhlMyJ9.APi1rguilYM8GZKBnbyWFg";
  function gpxStudioURL(gpxUrl){
    if(!gpxUrl) return "";
    const options = { token: MAPBOX_TOKEN, files: [ gpxUrl ], distanceUnits: "imperial" };
    return "https://gpx.studio/embed?options=" + encodeURIComponent(JSON.stringify(options));
  }

  function safeParse(text){
    try{ let x = JSON.parse(text); if (typeof x === "string") { try { x = JSON.parse(x) } catch{} } return x; }
    catch{ return null }
  }
  function normalizeData(raw){
    if (typeof raw === "string"){ const again = safeParse(raw); if (again) raw = again; }
    if (raw && (raw.schema_version || raw.hero_image || raw.image_link || raw.mission_text)) return raw;
    let full=null, flat=null;
    if (typeof raw?.index_json === "string") full = safeParse(raw.index_json);
    else if (raw?.index_json && typeof raw.index_json === "object") full = raw.index_json;
    if (typeof raw?.flat_json === "string") flat = safeParse(raw.flat_json);
    else if (raw?.flat_json && typeof raw.flat_json === "object") flat = raw.flat_json;
    let out = { ...(full||{}), ...(flat||{}) };
    if (out && !out.image_link) out.image_link = out.imageLink || out.credit_link || out.image_credit_link || "";
    if (out && !out.image_credit) out.image_credit = out.imageCredit || out.photo_credit || "";
    if (out && !out.hero_image) out.hero_image = out.hero?.url || out.image || out.heroImage || "";
    return Object.keys(out).length ? out : raw;
  }

  function pill(iconClass, text){
    const span = document.createElement("span");
    span.className = "pill";
    const i = document.createElement("span"); i.className = "ico " + (iconClass || "i-generic");
    span.appendChild(i);
    span.appendChild(document.createTextNode(" " + text));
    return span;
  }
  function kvRow(term, val){
    if(!val) return null;
    const wrapT = document.createElement("div"); wrapT.className="term"; wrapT.textContent = term;
    const wrapV = document.createElement("div"); wrapV.textContent = val;
    return [wrapT, wrapV];
  }

  // Break a long "label: value label: value" line into <div> with hard returns per label.
  function splitColonLines(text){
    return text.split(/(?:\s*-\s*)?(?=[A-Z][^:]*:\s)/g)
               .map(s=>s.trim()).filter(Boolean)
               .map(s=>s.replace(/\s*—\s*/g," — "))
               .join("\n");
  }

  async function main(){
    const slug = getSlug();
    if(!slug){ $("title").textContent="Missing slug"; return; }

    // fetch JSON
    const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json?cb=${Date.now()}`;
    let data={};
    try{
      const res = await fetch(jsonURL, {cache:"no-store"});
      const txt = await res.text();
      data = normalizeData(safeParse(txt) ?? {});
    }catch(e){ console.error(e); }

    // header
    $("title").textContent = first(data,["title","name"]) || "Expedition";
    $("hdrCategory").textContent = first(data,["category","type"]) || "";
    $("hdrSeason").textContent = first(data,["season"]) || "";
    $("hdrLocation").textContent = first(data,["location","place"]) || "";
    const d = first(data,["date","when"]);
    $("hdrDate").textContent = /^\d{4}-\d{2}-\d{2}$/.test(d)
      ? new Date(d+"T00:00:00Z").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"})
      : (d||"");

    const hero = first(data,["hero_image","hero.url","image"]);
    if (hero) $("hero").src = hero;
    const creditName = first(data,["image_credit","credit","photo_credit"]) || "";
    const creditLink = first(data,["image_link","credit_link","image_credit_link"]) || "";
    $("credit").innerHTML = creditName ? (creditLink ? `<a href="${creditLink}" target="_blank" rel="noopener">${creditName}</a>` : creditName) : "";

    // meta route
    $("metaRoute").textContent = first(data,["title","route","primary_objective","objective","name"])?.replace(/^EXPEDITION ITINERARY:\s*/i,"") || "";

    // terrain KV
    const terrainKV = $("terrainKV");
    (kvRow("Cumulative elevation gain/loss (ft)", first(data,["cum_elev","+elev","cumulative_elevation","+elevation"])) ?? []).forEach(n=>terrainKV.appendChild(n));
    (kvRow("Start and end trailhead", first(data,["start_end_trailhead","start_end","trailheads"])) ?? []).forEach(n=>terrainKV.appendChild(n));
    (kvRow("GPS coordinates", first(data,["gps","coordinates","gps_coordinates"])) ?? []).forEach(n=>terrainKV.appendChild(n));

    // permits KV
    const permitsKV = $("permitsKV");
    [["Requirement","permits.requirement"],
     ["Issuing agency/jurisdiction","permits.agency"],
     ["How to apply","permits.how"],
     ["Application window & deadline","permits.window"],
     ["Processing time & approval odds","permits.processing"],
     ["Cost & payment","permits.cost"],
     ["Required documents/ID","permits.documents"],
     ["Permit Pressure","permits.pressure"]]
     .forEach(([t,k])=>{
       const val = first(data,[k,t.toLowerCase().replace(/\s+/g,'_')]);
       const row = kvRow(t, val);
       if(row){ row.forEach(n=>permitsKV.appendChild(n)) }
     });
    const verify = first(data,["permits.verify","permits_verify","verify"]);
    $("permitsVerify").textContent = verify || "";

    // map + shuttle pills
    const mapURL = first(data,["map_embed_url","map_embed","map.url"]);
    if (mapURL) $("map").src = mapURL;
    const shuttleP = $("shuttlePills");
    [
      ["i-map", first(data,["shuttle.nearest_access","nearest_access"])],
      ["i-map", first(data,["shuttle.travel_time_start","travel_time_start"])],
      ["i-map", first(data,["shuttle.basecamp_pre","basecamp_pre"])],
      ["i-map", first(data,["shuttle.access_type","access_type"])],
      ["i-map", first(data,["shuttle.parking","parking"])],
      ["i-map", first(data,["shuttle.local_transport","local_transport"])],
      ["i-map", first(data,["shuttle.direction","direction"])],
      ["i-map", first(data,["shuttle.travel_time_finish","travel_time_finish"])],
      ["i-map", first(data,["shuttle.basecamp_post","basecamp_post"])],
      ["i-map", first(data,["shuttle.fuel_restrictions","fuel_restrictions"])]
    ].forEach(([ico,txt])=>{ if(txt) shuttleP.appendChild(pill(ico,txt)) })

    // multi KV
    const multiKV = $("multiKV");
    [["Staging plan","multi.staging"],["Vehicle retrieval","multi.vehicle"],["Backup plan","multi.backup"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>multiKV.appendChild(n)) });

    // keys KV
    const keysKV = $("keysKV");
    [["Permits & Quotas","keys.quotas"],["Seasonality","keys.seasonality"],["Shuttle & Staging","keys.staging"],["Objective Realities","keys.realities"],["Special Constraints","keys.constraints"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>keysKV.appendChild(n)) });

    // timeline KV (bold left)
    const timelineKV = $("timelineKV");
    [["90 Days Out","timeline.d90"],["30 Days Out","timeline.d30"],["7 Days Out","timeline.d7"],["48 Hours Out","timeline.h48"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>timelineKV.appendChild(n)) });

    // days
    const dayWrap = $("dayWrap");
    (get(data,"days")||[]).forEach((d,i)=>{
      const card = document.createElement("article"); card.className="day";
      const h = document.createElement("h3");
      h.textContent = d.title || `Day ${i+1}`;
      card.appendChild(h);
      const p = document.createElement("p");
      p.textContent = d.summary || d.desc || "";
      card.appendChild(p);
      const m = document.createElement("div"); m.className="meta";
      if (d.miles) m.appendChild(pill("i-doc", `${d.miles} mi`));
      if (d.gain || d.loss) m.appendChild(pill("i-triangle", `${d.gain?`+${d.gain}`:""} ${d.loss?`/ -${d.loss}`:""} ft`.trim()));
      card.appendChild(m);
      if (d.details){
        const details = document.createElement("div");
        details.className="pill"; details.style.display="block"; details.style.borderRadius="12px"; details.style.lineHeight="1.55";
        details.textContent = splitColonLines(d.details);
        card.appendChild(details);
      }
      dayWrap.appendChild(card);
    });

    // campsite intel
    const campsKV = $("campsKV");
    [["Camp names and elevation", "camps.names"],
     ["Fire restrictions","camps.fire"],
     ["Bear safety and food storage","camps.bear"],
     ["Best views (sunrise/sunset)","camps.views"],
     ["Noise level or solitude factor","camps.noise"],
     ["Nearest water source","camps.water"]]
     .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>campsKV.appendChild(n)) });

    // weather/altitude
    const weatherKV = $("weatherKV");
    [["Typical temps","weather.temps"],["Sun exposure","weather.sun"],["Acclimatization tips","weather.acclimatize"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>weatherKV.appendChild(n)) });

    // gear
    const gearKV = $("gearKV");
    [["Augments","gear.augments"],["Tips","gear.tips"]]
      .forEach(([t,k])=>{ const v = first(data,[k]) || first(data,["gear."+t.toLowerCase()]); const r = kvRow(t,v); if(r) r.forEach(n=>gearKV.appendChild(n)) });
    const core = first(data,["gear.core","gear.core_text"]);
    if (core){
      const full = document.createElement("div"); full.style.gridColumn="1 / -1"; full.textContent = core;
      gearKV.appendChild(full);
    }

    // mods
    const modsKV = $("modsKV");
    [["Shorten","mods.shorten"],["Extend","mods.extend"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>modsKV.appendChild(n)) });

    // risk
    const riskKV = $("riskKV");
    [["Weather","risk.weather"],["Terrain","risk.terrain"],["Wildlife","risk.wildlife"],["Human factors","risk.human"],["Comms","risk.comms"],["Time-of-day window","risk.window"],["Mitigations","risk.mitigations"],["Thresholds","risk.thresholds"],["Bailouts","risk.bailouts"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>riskKV.appendChild(n)) });

    // conditions
    const conditionsKV = $("conditionsKV");
    [["Verification source","conditions.source"]].forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>conditionsKV.appendChild(n)) });
    const condText = first(data,["conditions.text","conditions.desc"]);
    if(condText){ const full = document.createElement("div"); full.style.gridColumn="1/-1"; full.textContent=condText; conditionsKV.appendChild(full); }

    // bailouts
    const bailKV = $("bailKV");
    [["Day 1","bailouts.d1"],["Day 2","bailouts.d2"],["Day 3","bailouts.d3"],["Day 4","bailouts.d4"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>bailKV.appendChild(n)) });

    // emergency
    const emKV = $("emKV");
    [["Emergency (life-threatening)","emergency.911"],["Managing authority dispatch/ranger","emergency.dispatch"],["Satellite message plan","emergency.sat"],["Nearest hospital/ER","emergency.hospital"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>emKV.appendChild(n)) });

    // final brief
    const finalKV = $("finalKV");
    [["Trail hours per day","final.hours"],["Wake/sleep rhythm","final.rhythm"],["Estimated calories burned per day","final.calories"],["Water needed per person","final.water"],["Recommended pack weight range","final.pack"]]
      .forEach(([t,k])=>{ const v = first(data,[k]); const r = kvRow(t,v); if(r) r.forEach(n=>finalKV.appendChild(n)) });

    // GPX
    const gpxURL = first(data,["gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"]);
    if (gpxURL){
      const studio = gpxStudioURL(gpxURL);
      $("gpxStudio").src = studio;
      $("gpxStudioLink").href = studio;
      $("gpxBtn").href = gpxURL;
      $("gpxBtn").download = (slug||"route") + ".gpx";
      // small stats if available
      const stats = $("gpxStats");
      [["i-doc", first(data,["stats.miles","total_miles","mileage"]) && `~${first(data,["stats.miles","total_miles","mileage"])}`],
       ["i-triangle", first(data,["stats.gain"]) && `+${first(data,["stats.gain"])} ft`],
       ["i-triangle", first(data,["stats.loss"]) && `-${first(data,["stats.loss"])} ft`],
       ["i-flag", first(data,["trip_days","duration"]) && `${first(data,["trip_days","duration"])}`]
      ].forEach(([ico,txt])=>{ if(txt) stats.appendChild(pill(ico,txt)) });
    }

    // disclaimer
    $("disclaimerText").textContent = first(data,["disclaimer","field_disclaimer"]) || "";

    // buttons
    $("printBtn").addEventListener("click", ()=>window.print());
    $("bookmarkBtn").addEventListener("click", (e)=>{ e.preventDefault(); alert("Bookmarked (placeholder)"); });
    $("endorseBtn").addEventListener("click", (e)=>{ e.preventDefault(); alert("Endorsed (placeholder)"); });
  }

  main();
</script>
</body>
</html>
