<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Expedition</title>

<link rel="stylesheet" href="/fonts.css"/>

<style>
  :root{
    --bg:#e8e5e2; --ink:#1e1e1e; --paper:#fff; --accent:#fe5733;
    --font: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
    --h1: clamp(44px,18vw,86px);
    --body: 18px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--ink); font-family:var(--font);
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  img{ display:block; width:100%; height:auto }
  a{ color:inherit; text-underline-offset:2px }
  .page{ max-width:1120px; margin:0 auto; padding:24px 16px 48px; display:grid; row-gap:22px }
  .title{ font-size:var(--h1); line-height:1.02; font-weight:900; letter-spacing:-.02em; margin:.2em 0 .1em }
  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px 28px; align-items:start }
  @media (min-width:960px){ .grid2{ grid-template-columns:repeat(4,1fr); } }
  .label{ font-size:13px; letter-spacing:.18em; text-transform:uppercase; opacity:.7 }
  .value{ font-size:clamp(18px,2.6vw,28px); line-height:1.28 }

  .fullbleed{ width:100vw; margin-left:calc(50% - 50vw); overflow:hidden }
  .fullbleed img{ width:100vw; max-width:100vw; height:auto }

  .credit{ text-align:right; font-size:14px; margin-top:8px; color:var(--accent); padding-right:16px; }
  .credit a{ text-decoration:underline; cursor:pointer; }

  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin:.5rem 0 .75rem }
  .btn{ display:inline-flex; align-items:center; gap:.6rem; padding:.6rem 1rem; font-weight:700;
        border-radius:999px; text-decoration:none; border:1px solid rgba(0,0,0,.12);
        background:rgba(0,0,0,.06); color:inherit; cursor:pointer }
  .btn:focus-visible{ outline:2px solid rgba(0,0,0,.35); outline-offset:2px }

  .section{ padding:16px 0 6px; border-bottom:1px solid rgba(0,0,0,.06) }
  .section:last-child{ border-bottom:0 }
  .section h3{
    display:flex; align-items:center; gap:.6rem;
    font-weight:800; letter-spacing:-.01em;
    font-size:clamp(21px,6vw,26px);
    margin:24px 0 12px;
  }
  .section p{ font-size:clamp(16px,4.6vw,18px); line-height:1.55; margin:0 0 .6rem }

  .kv{
    display:grid;
    grid-template-columns:minmax(14ch,1fr) minmax(0,2fr);
    row-gap:.75rem; column-gap:1rem; align-items:start;
  }
  .kv .k,.kv .v{ line-height:1.5; font-size:clamp(17px,4.6vw,18.5px) }
  .kv .k{
    font-weight:800; display:inline-block; white-space:nowrap;
    overflow:hidden; text-overflow:ellipsis; hyphens:none; word-break:normal; overflow-wrap:normal;
  }
  .kv .v{ overflow-wrap:anywhere; word-break:break-word; hyphens:auto }

  /* Day blocks */
  .day{
    background:var(--bg);
    border:1px solid rgba(0,0,0,.10);
    border-radius:14px; padding:14px 14px 12px; margin:14px 0;
  }
  .day h4{ margin:0 0 .4rem; font-size:clamp(18px,5vw,22px); letter-spacing:-.01em }
  .pillbar{ display:flex; gap:8px; flex-wrap:wrap; margin:.4rem 0 .5rem }
  .pill{
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.45rem .7rem; border-radius:999px; background:rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.10);
    font-weight:700; font-size:15px;
  }
  .pill:empty{ display:none }

  .meta{ background:rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.10); border-radius:12px; padding:.75rem .85rem; }
  .meta p{ margin:.4rem 0 }

  /* Timeline grid */
  .timeline{
    display:grid; grid-template-columns:minmax(11ch,1fr) 2fr; gap:.55rem 1rem;
  }
  .timeline .when{ font-weight:800 }

  /* GPX area */
  .embed{ aspect-ratio:16/9 } .embed iframe{ width:100%; height:100%; border:0; display:block }
  .gpx-actions{ margin-top:14px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
  #gpxBtn{ background:#000; color:#fff; border-color:#000; }
  .gpx-note{ text-align:center; max-width:34rem; margin:8px auto 0; opacity:.9 }
  .gpx-note b{ display:block; margin-top:.2rem }

  @media (max-width:810px){ .value{ font-size:clamp(18px,4.6vw,24px) } }
  @supports (-webkit-touch-callout:none){
    @media (max-width:420px){ .kv .k{ white-space:normal } }
  }

  /* Print */
  @media print{
    body{ background:#fff; color:#000 }
    .actions, .gpx-actions, .credit a::after{ display:none !important }
    .page{ max-width:720px; padding:0 }
    h1{ font-size:42px; line-height:1.1 }
    .section, .day{ page-break-inside:avoid; break-inside:avoid }
    .fullbleed{ margin:0; width:auto }
    .fullbleed img{ width:100%; max-width:100%; height:auto }
    a[href^="http"]:after{ content:" <" attr(href) ">"; font-weight:400 }
  }
</style>
</head>
<body>
  <div class="page">
    <div id="status" style="opacity:.6;font-size:14px">Loading‚Ä¶</div>

    <h1 id="title" class="title"></h1>

    <div class="actions">
      <button class="btn" data-action="bookmark">Bookmark</button>
      <button class="btn" data-action="endorse">Endorse</button>
      <button class="btn" id="printBtn" title="Print or save to PDF">üñ®Ô∏è Print</button>
    </div>

    <div class="grid2">
      <div><div class="label">Category</div><div id="category" class="value"></div></div>
      <div><div class="label">Season</div><div id="season" class="value"></div></div>
      <div><div class="label">Location</div><div id="location" class="value"></div></div>
      <div><div class="label">Date</div><div id="date" class="value"></div></div>
    </div>

    <div class="fullbleed">
      <a id="heroLink" href="#" target="_blank" rel="noopener noreferrer" aria-label="Photo credit link">
        <img id="hero" alt="Expedition hero"/>
      </a>
      <div id="credit" class="credit"></div>
    </div>

    <!-- Sections mount here -->
    <div id="sections"></div>

    <!-- Shuttle map -->
    <div class="section" id="shuttleSection" style="display:none">
      <h3>Shuttle / Transportation</h3>
      <div class="embed"><iframe id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
      <div id="shuttleChips" class="pillbar"></div>
    </div>

    <!-- GPX block -->
    <div class="section" id="gpxSection" style="display:none">
      <h3>GPX Route & Elevation</h3>
      <div class="embed" id="gpxEmbedWrap">
        <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <div class="gpx-actions" id="gpxActions">
        <a id="gpxBtn" class="btn" href="#" download>DOWNLOAD GPX</a>
        <a id="gpxStudioLink" class="btn" href="#" target="_blank" rel="noopener">Open in GPX Studio</a>
        <span id="trailheads" style="opacity:.7"></span>
      </div>
      <p class="gpx-note">Starter GPX ‚Äî review and adjust in your mapping app.<br/><b>Do not rely on it as your only navigation source.</b></p>
    </div>

    <!-- Field Disclaimer moves to bottom inherently -->
    <div id="disclaimerMount"></div>
  </div>

<script>
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const qp = (k) => new URL(location.href).searchParams.get(k);
  const get = (o,p)=>p.split('.').reduce((a,c)=>a?.[c],o);
  const first = (o,keys)=>{ for(const k of keys){ const v=get(o,k); if(typeof v==="string"&&v.trim()) return v.trim(); if(v) return v; } return ""; };

  function getSlug(){
    const q = qp("slug"); if (q) return q;
    const parts = (location.pathname||"/").split("/").filter(Boolean);
    const i = parts.findIndex(p=>p.toLowerCase()==="expedition" || p.toLowerCase()==="trip");
    return i>-1 ? parts[i+1] : null;
  }

  const MAPBOX_TOKEN = "pk.eyJ1IjoiZXhwZWQtaW50ZWwiLCJhIjoiY21kc3Vrc2FtMHZkNjJrcTN6ajlmZzhlMyJ9.APi1rguilYM8GZKBnbyWFg";
  function gpxStudioURL(gpxUrl){
    if(!gpxUrl) return "";
    const options = { token: MAPBOX_TOKEN, files: [ gpxUrl ], distanceUnits: "imperial", centerOnRoutes:true };
    return "https://gpx.studio/embed?options=" + encodeURIComponent(JSON.stringify(options));
  }

  function safeParse(text){
    try{
      let x = JSON.parse(text);
      if (typeof x === "string") {
        try { x = JSON.parse(x); } catch {}
      }
      return x;
    }catch{ return null; }
  }

  function normalizeData(raw){
    if (typeof raw === "string") {
      const again = safeParse(raw);
      if (again) raw = again;
    }
    if (raw && (raw.schema_version || raw.hero_image || raw.image_link || raw.mission_text)) return raw;
    let full = null, flat = null;
    if (typeof raw?.index_json === "string") { full = safeParse(raw.index_json); }
    else if (raw?.index_json && typeof raw.index_json === "object") { full = raw.index_json; }
    if (typeof raw?.flat_json === "string") { flat = safeParse(raw.flat_json); }
    else if (raw?.flat_json && typeof raw.flat_json === "object") { flat = raw.flat_json; }
    let out = { ...(full || {}), ...(flat || {}) };
    if (out && !out.image_link) out.image_link = out.imageLink || out.credit_link || out.image_credit_link || "";
    if (out && !out.image_credit) out.image_credit = out.imageCredit || out.photo_credit || "";
    if (out && !out.hero_image) out.hero_image = out.hero?.url || out.image || out.heroImage || "";
    return Object.keys(out).length ? out : raw;
  }

  const isValidUnsplashPhoto = (u)=>{
    try{
      const x = new URL(u);
      return x.hostname === "unsplash.com" && /^\/photos\/[A-Za-z0-9_-]+/.test(x.pathname);
    }catch{ return false; }
  };

  // ---------- header detection that won't eat "GPS coordinates:" ----------
  function isHeaderLine(line){
    const L = (line||"").trim();
    if (/^DAY\s*\d+\s*:/i.test(L)) return true;                   // DAY blocks
    if (/^EXPEDITION ITINERARY\s*:/i.test(L)) return true;        // special top line
    if (!/[:]/.test(L) && /^[^a-z]+$/.test(L)) return true;       // all-caps w/o colon
    return false;
  }

  function parseSections(text){
    const lines = (text || "").split(/\r?\n/).map(s=>s.trim());
    const sections = [];
    let current = null;

    const push = ()=>{ if(current){ sections.push(current); current=null; } };

    for(const raw of lines){
      const line = raw.trim();
      if (!line) continue;
      if (/^[-‚Äì‚Äî]{2,}$/.test(line)) continue; // ignore rule-only lines
      if (/^[‚Ä¢*]\s*$/.test(line)) continue;   // ignore stray bullets

      if (isHeaderLine(line)) {
        push();
        current = { title: line, lines: [] };
      } else {
        if(!current) current = { title:"UNSECTIONED", lines:[] };
        // Expand the "a: b ‚Äî c: d" style content into separate lines when detected
        const expanded = expandInlineKVs(line);
        expanded.forEach(x => current.lines.push(x));
      }
    }
    push();
    return sections;
  }

  // break "A: B ‚Äî C: D ‚Äî E: F" into ["A: B", "C: D", "E: F"]
  function expandInlineKVs(line){
    const chunks = [];
    // split on emdash/endash hyphen separators
    const parts = line.split(/\s+[‚Äî‚Äì-]\s+/);
    for(const p of parts){
      const m = p.match(/^([^:]+):\s*(.*)$/);
      if(m) chunks.push(m[1].trim()+": "+m[2].trim());
      else chunks.push(p);
    }
    return chunks;
  }

  function renderKVRow(k, v){
    const row = document.createElement("div");
    row.className = "kv";
    const kEl = document.createElement("div"); kEl.className="k"; kEl.textContent = k;
    const vEl = document.createElement("div"); vEl.className="v"; vEl.textContent = v;
    row.append(kEl, vEl);
    return row;
  }

  function mountKVList(parent, pairs){
    const wrap = document.createElement("div"); wrap.className="kv";
    for(const [k,v] of pairs){ 
      const kEl=document.createElement("div"); kEl.className="k"; kEl.textContent=k;
      const vEl=document.createElement("div"); vEl.className="v"; vEl.textContent=v;
      wrap.append(kEl,vEl);
    }
    parent.appendChild(wrap);
  }

  function pill(txt){
    const el = document.createElement("span");
    el.className = "pill";
    el.textContent = txt;
    return el;
  }

  function buildDayCard(title, lines){
    const card = document.createElement("div");
    card.className = "day";
    const h = document.createElement("h4"); h.textContent = title.replace(/^DAY\s*\d+\s*:\s*/i,'DAY ').trim();
    card.appendChild(h);

    // first non-kv line as summary paragraph
    const summary = lines.find(l => !/^[^:]+:\s*/.test(l));
    if (summary) { const p=document.createElement("p"); p.textContent=summary; card.appendChild(p); }

    // distance/elevation -> pillbar
    const pb = document.createElement("div"); pb.className="pillbar";
    const dist = lines.find(l=>/^Distance and elevation gain\/loss:/i.test(l));
    if (dist){
      const dm = dist.match(/(\d+(?:\.\d+)?)\s*(?:mi|miles)/i);
      const up = dist.match(/[+]\s*([0-9,]+)\s*ft/i);
      const dn = dist.match(/[-]\s*([0-9,]+)\s*ft/i);
      if (dm) pb.appendChild(pill(`${dm[1]} mi`));
      if (up || dn) pb.appendChild(pill(`${up?("+"+up[1]):""} ${dn?("/ -"+dn[1]):""} ft`.replace(/\s+/g,' ').trim()));
    }
    if (pb.children.length) card.appendChild(pb);

    // The long detail line(s) -> meta box with hard returns for each "X: Y"
    const restKVs = lines.filter(l=>/^[^:]+:\s*/.test(l));
    if (restKVs.length){
      const meta = document.createElement("div"); meta.className="meta";
      restKVs.forEach(item=>{
        const m=item.match(/^([^:]+):\s*(.*)$/);
        if(m){
          const P=document.createElement("p");
          P.innerHTML = `<strong>${m[1]}:</strong> ${m[2]}`;
          meta.appendChild(P);
        }
      });
      card.appendChild(meta);
    }
    return card;
  }

  // ---------- main ----------
  async function main(){
    const status = $("status");
    const slug = getSlug();
    if(!slug){ status.textContent="Missing slug (?slug= or /expedition/{slug})"; return; }

    const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json?cb=${Date.now()}`;
    status.textContent = "Fetching‚Ä¶";

    let data;
    try{
      const res = await fetch(jsonURL, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status);
      const text = await res.text();
      let raw = safeParse(text);
      if (raw === null) raw = {};
      data = normalizeData(raw);
    }catch(e){
      status.textContent = "Fetch failed: "+e.message;
      return;
    }

    // Header fields
    $("title").textContent = first(data,["title","name"]) || "";
    $("category").textContent = first(data,["category","type"]) || "";
    $("season").textContent = first(data,["season"]) || "";
    $("location").textContent = first(data,["location","place"]) || "";

    const d = first(data,["date","when"]);
    $("date").textContent = /^\d{4}-\d{2}-\d{2}$/.test(d)
      ? new Date(d+"T00:00:00Z").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"})
      : (d||"");

    const hero = first(data,["hero_image","hero.url","image"]);
    if (hero) $("hero").src = hero;

    const creditName = first(data,["image_credit","credit","photo_credit"]) || "";
    let creditLink = first(data,["image_link","credit_link","image_credit_link"]) || "";
    if (!isValidUnsplashPhoto(creditLink)) creditLink = "";
    $("credit").innerHTML = creditName
      ? (creditLink
          ? `<a href="${creditLink}" target="_blank" rel="noopener noreferrer" title="${creditLink}">${creditName}</a>`
          : creditName)
      : "";
    const heroLinkEl = $("heroLink");
    if (heroLinkEl) {
      if (creditLink) { heroLinkEl.href = creditLink; heroLinkEl.style.pointerEvents = "auto"; }
      else { heroLinkEl.removeAttribute("href"); heroLinkEl.style.pointerEvents = "none"; }
    }

    // Build sections from mission text
    const mission = first(data,["mission_text","mission","brief","summary"]) || "";
    const sections = parseSections(mission);

    const mount = $("sections");
    const disclaimerMount = $("disclaimerMount");

    sections.forEach(sec=>{
      const title = (sec.title||"").trim();

      // GPX & Map handled separately later; skip if empty
      if (/^SHUTTLE\s*\/\s*TRANSPORTATION$/i.test(title)){
        // We'll render chips after the map with shuttle text broken into pills
        const chips = sec.lines
          .filter(l=>/^[^:]+:\s*/.test(l))
          .map(l=>l.replace(/\s+/g,' '));
        const chipWrap = $("shuttleChips");
        chips.forEach(t=>{ const el=document.createElement("span"); el.className="pill"; el.textContent=t; chipWrap.appendChild(el); });
        $("shuttleSection").style.display="";
        return;
      }

      if (/^FIELD DISCLAIMER/i.test(title)){
        const s = document.createElement("div"); s.className="section";
        const h = document.createElement("h3"); h.textContent = "Field Disclaimer";
        s.appendChild(h);
        (sec.lines.length?sec.lines:[title]).forEach(line=>{
          const p=document.createElement("p"); p.textContent = line.replace(/^FIELD DISCLAIMER\s*:?\s*/i,'');
          s.appendChild(p);
        });
        disclaimerMount.appendChild(s);
        return;
      }

      // Day blocks
      if (/^DAY\s*\d+\s*:/.test(title)){
        const s = document.createElement("div"); s.className="section";
        const card = buildDayCard(title, sec.lines);
        const h = document.createElement("h3"); h.textContent = "Itinerary Overview";
        // Only show the section header for the first day card; append cards after.
        if (!mount.querySelector('.day')) s.appendChild(h);
        s.appendChild(card);
        mount.appendChild(s);
        return;
      }

      // General section with KV rows (left bold)
      const s = document.createElement("div"); s.className="section";
      const h = document.createElement("h3"); h.textContent = title.replace(/:\s*$/, '');
      s.appendChild(h);

      const kvs = [];
      let freeParas = [];

      sec.lines.forEach(line=>{
        const m = line.match(/^([^:]+):\s*(.*)$/);
        if(m) kvs.push([m[1].trim(), m[2].trim()]);
        else freeParas.push(line);
      });

      if (kvs.length) mountKVList(s, kvs);
      freeParas.forEach(t=>{ const p=document.createElement("p"); p.textContent=t; s.appendChild(p); });

      mount.appendChild(s);
    });

    // Shuttle map (Google embed URL from JSON)
    const mapURL = first(data,["map_embed_url","map_embed","map.url"]);
    if (mapURL){ $("map").src = mapURL; $("shuttleSection").style.display=""; }

    // GPX
    const gpxURL = first(data,["gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"]);
    if (gpxURL) {
      const studio = gpxStudioURL(gpxURL);
      $("gpxStudio").src = studio;
      $("gpxStudioLink").href = studio;
      $("gpxBtn").href = gpxURL;
      const slugVal = getSlug() || "route";
      $("gpxBtn").download = slugVal + ".gpx";
      const th = [first(data,["start_trailhead","start"]), first(data,["end_trailhead","end"])].filter(Boolean).join(" ‚Üí ");
      if (th) $("trailheads").textContent = th;
      $("gpxSection").style.display="";
    }

    status.textContent = "";
    setTimeout(()=>status.remove(), 10);
  }

  // active print + simple toggles
  document.getElementById('printBtn')?.addEventListener('click', ()=>window.print());
  addEventListener('click', e=>{
    const el = e.target.closest('[data-action]');
    if(!el) return;
    el.classList.toggle('is-on');
  });

  if (typeof window !== "undefined") main();
</script>
</body>
</html>
