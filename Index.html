<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Expedition</title>

  <link rel="stylesheet" href="/fonts.css" />

  <style>
    :root{
      --bg: rgb(232, 229, 226);
      --ink: rgb(30, 30, 30);
      --paper: rgb(255, 255, 255);
      --accent: rgb(254, 87, 51);
      --line: rgba(0,0,0,.12);
      --chip: #f4f1ee;
      --font-sans: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Cantarell, "Helvetica Neue", Arial, sans-serif;

      --h1: clamp(40px, 18vw, 88px);
      --h2: 22px;
      --label: 13px;
      --body: 18px;

      --r-lg: 12px;
      --r-sm: 8px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; background:var(--bg); color:var(--ink); font-family:var(--font-sans);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    img{ display:block; width:100%; height:auto }
    a{ color:inherit; text-underline-offset:2px }

    .page{ max-width:1120px; margin:0 auto; padding:24px 16px 64px; display:grid; row-gap:20px; }
    .title{ font-size:var(--h1); line-height:1.02; font-weight:700; letter-spacing:-0.02em; }

    /* Top actions */
    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn-ghost{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; font-weight:700; border-radius:var(--r-sm);
      text-decoration:none; border:1px solid var(--line); background:transparent;
    }
    .btn-ghost svg{ width:18px; height:18px; stroke:currentColor; fill:none; stroke-width:2; }

    /* Meta row */
    .label{ font-size:var(--label); letter-spacing:.18em; text-transform:uppercase; opacity:.7; display:flex; align-items:center; gap:8px }
    .value{ font-size:clamp(18px,2.6vw,28px); line-height:1.28; font-weight:700 }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:14px 28px; align-items:start; margin-top:8px; }
    @media (min-width:960px){ .grid2{ grid-template-columns:repeat(4,1fr); } }

    /* Hero */
    .fullbleed{ width:100vw; margin-left:calc(50% - 50vw); }
    #heroLink{ display:block; }
    .credit{ text-align:right; font-size:14px; margin-top:8px; color:var(--accent); padding-right:16px; }
    .credit a{ text-decoration:underline; cursor:pointer; }

    /* Sections */
    .section{ border-top:1px solid var(--line); padding-top:16px; margin-top:18px; }
    .sh{ display:flex; align-items:center; gap:10px; margin:0 0 8px 0 }
    .sh svg{ width:22px; height:22px; stroke:currentColor; fill:none; stroke-width:2; }
    .h2{ font-size:var(--h2); line-height:1.2; font-weight:800; margin:0 }

    .mission{ font-size:var(--body); line-height:1.6; white-space:normal; }
    .lead{ opacity:.9 }

    /* Embeds */
    .embed{ aspect-ratio:16/9 } .embed iframe{ width:100%; height:100%; border:0; display:block }
    @media (max-width:480px){ .embed{ aspect-ratio:3/4 } }

    /* Day cards */
    .day{ background:rgba(0,0,0,.035); border:1px solid var(--line); border-radius:var(--r-lg); padding:14px; margin-top:14px; }
    .day h3{ font-size:20px; margin:2px 0 6px 0 }
    .day .lede{ font-size:var(--body); line-height:1.6; opacity:.92; }
    .spacer{ height:8px } /* ensures a visual gap between lede and chips */

    .chips{ display:flex; flex-wrap:wrap; gap:10px; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:var(--chip);
      border-radius:18px; padding:6px 10px; font-weight:700; font-size:14px;
    }
    .chip svg{ width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2; }

    /* Lists */
    .list{ margin:6px 0 0 0; padding-left:18px; font-size:var(--body) }
    .kv-list b{ font-weight:800 }

    /* GPX */
    .gpx-actions{ margin-top:14px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:12px 18px; font-weight:700; border-radius:28px; text-decoration:none; border:1px solid rgba(0,0,0,.12); background:var(--paper); }
    #gpxBtn{ background:#000; color:#fff; border-color:#000; }
    #gpxNote{ font-size:14px; opacity:.8; text-align:center }
    #gpxNote b{ display:block; margin-top:4px }

    /* Misc */
    @media (max-width:810px){ .value{ font-size:clamp(18px,4.6vw,24px) } }
    @media (max-width:480px){
      .page{ padding:20px 20px 48px }
      .grid2{ grid-template-columns:1fr 1fr }
      .credit{ font-size:13px }
    }
    #status{ font-size:12px; opacity:.7; max-width:720px; margin:0 auto; }
  </style>
</head>
<body>
  <div class="page">
    <div id="status">Loading…</div>

    <!-- Title -->
    <h1 id="title" class="title"></h1>

    <!-- Top actions (ghost; no blue; small radius) -->
    <div class="actions">
      <a id="actBookmark" class="btn-ghost" href="#"><svg viewBox="0 0 24 24"><path d="M7 3h10a2 2 0 0 1 2 2v14l-7-4-7 4V5a2 2 0 0 1 2-2z"/></svg>Bookmark</a>
      <a id="actShare" class="btn-ghost" href="#"><svg viewBox="0 0 24 24"><path d="M4 12h8"/><path d="M12 16l4-4-4-4"/><circle cx="18" cy="12" r="3"/></svg>Share</a>
      <a id="actPrint" class="btn-ghost" href="javascript:window.print()"><svg viewBox="0 0 24 24"><path d="M6 9V4h12v5"/><rect x="6" y="13" width="12" height="8" rx="2"/><path d="M6 17h12"/><path d="M6 13h12"/></svg>Print</a>
    </div>

    <!-- Meta -->
    <div class="grid2">
      <div><div class="label"><svg viewBox="0 0 24 24"><path d="M12 2l3 7h7l-5.5 4.5L18 21l-6-4-6 4 1.5-7.5L2 9h7z"/></svg>Category</div><div id="category" class="value"></div></div>
      <div><div class="label"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M19.1 4.9l-1.4 1.4M6.3 17.7l-1.4 1.4"/></svg>Season</div><div id="season" class="value"></div></div>
      <div><div class="label"><svg viewBox="0 0 24 24"><path d="M12 21s-7-6.6-7-11a7 7 0 1 1 14 0c0 4.4-7 11-7 11z"/><circle cx="12" cy="10" r="3"/></svg>Location</div><div id="location" class="value"></div></div>
      <div><div class="label"><svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/></svg>Date</div><div id="date" class="value"></div></div>
    </div>

    <!-- Hero -->
    <div class="fullbleed">
      <a id="heroLink" href="#" target="_blank" rel="noopener noreferrer" aria-label="Photo credit link">
        <img id="hero" alt="Expedition hero" />
      </a>
      <div id="credit" class="credit"></div>
    </div>

    <!-- Expedition Itinerary (summary only; no duplicate label text) -->
    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h10M4 17h7"/></svg><h2 class="h2">Expedition Itinerary</h2></div>
      <div id="itinerarySummary" class="mission"></div>
    </div>

    <!-- Permits & Entry -->
    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M6 2h12l2 6-8 14L4 8z"/></svg><h2 class="h2">Permits & Entry</h2></div>
      <div id="permits" class="mission"></div>
    </div>

    <!-- Shuttle / Transportation (map first; text below) -->
    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M3 12h6l3-6 3 12 3-6h3"/></svg><h2 class="h2">Shuttle & Transportation</h2></div>
      <div class="embed"><iframe id="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe></div>
      <div id="shuttle" class="mission"></div>
    </div>

    <!-- Permit & Shuttle Timeline -->
    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="16" rx="2"/><path d="M16 3v4M8 3v4M3 11h18"/></svg><h2 class="h2">Permit & Shuttle Timeline</h2></div>
      <div id="timeline" class="mission"></div>
    </div>

    <!-- Days -->
    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg><h2 class="h2">Itinerary by Day</h2></div>
      <div id="days"></div>
    </div>

    <!-- Supporting sections (icons on headers, bulleted intel inside) -->
    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg><h2 class="h2">Campsite Intel</h2></div>
      <div id="campsite" class="mission"></div>
    </div>

    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M3 12h18"/><path d="M12 3v18"/></svg><h2 class="h2">Weather & Altitude Notes</h2></div>
      <div id="weather" class="mission"></div>
    </div>

    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M4 6h16v12H4z"/><path d="M9 6v12"/><path d="M15 6v12"/></svg><h2 class="h2">Gear Checklist</h2></div>
      <div id="gear" class="mission"></div>
    </div>

    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M12 2v6M12 16v6M2 12h6M16 12h6"/></svg><h2 class="h2">Risk Matrix & Hazard Timeline</h2></div>
      <div id="risk" class="mission"></div>
    </div>

    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M3 3l18 18"/><path d="M21 3L3 21"/></svg><h2 class="h2">Conditions Watch</h2></div>
      <div id="conditions" class="mission"></div>
    </div>

    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M7 10h10M7 14h6"/></svg><h2 class="h2">Bailout Summary</h2></div>
      <div id="bailouts" class="mission"></div>
    </div>

    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M6 2h12l2 6-8 14L4 8z"/></svg><h2 class="h2">Emergency Contacts & Numbers</h2></div>
      <div id="emergency" class="mission"></div>
    </div>

    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8M8 12h8M8 16h6"/></svg><h2 class="h2">Final Brief Summary</h2></div>
      <div id="final" class="mission"></div>
    </div>

    <!-- GPX Route & Elevation (end) -->
    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><path d="M3 12h6l3-6 3 12 3-6h3"/></svg><h2 class="h2">GPX Route & Elevation</h2></div>
      <div class="embed" id="gpxEmbedWrap">
        <iframe id="gpxStudio" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </div>
      <div class="gpx-actions" id="gpxActions">
        <a id="gpxBtn" class="btn" href="#" download>DOWNLOAD GPX</a>
        <a id="gpxStudioLink" class="btn" href="#" target="_blank" rel="noopener">Open in GPX Studio</a>
        <span id="trailheads" style="opacity:.7"></span>
      </div>
      <div id="gpxNote" class="mission" style="margin-top:10px">
        Starter GPX — review and adjust in your mapping app.
        <b>Do not rely on it as your only navigation source.</b>
      </div>
    </div>

    <!-- Field Disclaimer (final) -->
    <div class="section">
      <div class="sh"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"/><path d="M8 8h8M8 12h8M8 16h6"/></svg><h2 class="h2">Field Disclaimer</h2></div>
      <div id="disclaimer" class="mission"></div>
    </div>

  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const qp = (k) => new URL(location.href).searchParams.get(k);
    const get = (o,p)=>p.split('.').reduce((a,c)=>a?.[c],o);
    const first = (o,keys)=>{ for(const k of keys){ const v=get(o,k); if(typeof v==="string"&&v.trim()) return v.trim(); if(v) return v; } return ""; };

    function getSlug(){
      const q = qp("slug"); if (q) return q;
      const parts = (location.pathname||"/").split("/").filter(Boolean);
      const i = parts.findIndex(p=>p.toLowerCase()==="expedition" || p.toLowerCase()==="trip");
      return i>-1 ? parts[i+1] : null;
    }

    const MAPBOX_TOKEN = "pk.eyJ1IjoiZXhwZWQtaW50ZWwiLCJhIjoiY21kc3Vrc2FtMHZkNjJrcTN6ajlmZzhlMyJ9.APi1rguilYM8GZKBnbyWFg";
    function gpxStudioURL(gpxUrl){
      if(!gpxUrl) return "";
      const options = { token: MAPBOX_TOKEN, files: [ gpxUrl ], distanceUnits: "imperial" };
      return "https://gpx.studio/embed?options=" + encodeURIComponent(JSON.stringify(options));
    }

    function safeParse(text){
      try{
        let x = JSON.parse(text);
        if (typeof x === "string") {
          try { x = JSON.parse(x); } catch {}
        }
        return x;
      }catch{ return null; }
    }

    function normalizeData(raw){
      if (typeof raw === "string") {
        const again = safeParse(raw);
        if (again) raw = again;
      }
      if (raw && (raw.schema_version || raw.hero_image || raw.image_link || raw.mission_text)) return raw;
      let full = null, flat = null;
      if (typeof raw?.index_json === "string") { full = safeParse(raw.index_json); }
      else if (raw?.index_json && typeof raw.index_json === "object") { full = raw.index_json; }
      if (typeof raw?.flat_json === "string") { flat = safeParse(raw.flat_json); }
      else if (raw?.flat_json && typeof raw.flat_json === "object") { flat = raw.flat_json; }
      let out = { ...(full || {}), ...(flat || {}) };
      if (out && !out.image_link) out.image_link = out.imageLink || out.credit_link || out.image_credit_link || "";
      if (out && !out.image_credit) out.image_credit = out.imageCredit || out.photo_credit || "";
      if (out && !out.hero_image) out.hero_image = out.hero?.url || out.image || out.heroImage || "";
      return Object.keys(out).length ? out : raw;
    }

    const isValidUnsplashPhoto = (u)=>{
      try{
        const x = new URL(u);
        return x.hostname === "unsplash.com" && /^\/photos\/[A-Za-z0-9_-]+/.test(x.pathname);
      }catch{ return false; }
    };

    // ---- Formatting helpers ----
    const br = s => s.replace(/\n/g, "<br/>");

    // Convert dashed list lines to <ul>
    function dashedToUl(block){
      const lines = block.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const items = lines.filter(l=>/^- /.test(l));
      if(!items.length) return `<div class="mission">${br(block)}</div>`;
      const non = lines.filter(l=>!/^- /.test(l));
      const top = non.length ? `<div class="mission">${non.join("<br/>")}</div>` : "";
      const ul = "<ul class='list'>" + items.map(s=>"<li>"+s.replace(/^- /,"")+"</li>").join("") + "</ul>";
      return top + ul;
    }

    // Days: extract blocks starting with DAY N:
    function extractDayBlocks(text){
      const out = [];
      const re = /(DAY\s*\d+:[\s\S]*?)(?=\n\s*⸻|$)/gi;
      let m; while((m = re.exec(text))){
        out.push(m[1].trim());
      }
      return out;
    }

    function splitLedeAndFacts(dayBlock){
      const lines = dayBlock.split(/\r?\n/).map(l=>l.trim());
      const header = lines.shift(); // "DAY N: ..."
      const rest = lines.join("\n").trim();

      // lede = first paragraph until first dash-bullet or known label:
      const parts = rest.split(/\n(?=- |\w.*?:)/);
      const lede = parts.shift()?.replace(/^[-•]\s*/,"").trim() || "";
      const facts = (parts.join("\n") || "").trim();
      return { header, lede, facts };
    }

    // Chips from fact labels
    function factsToChips(facts){
      const ln = facts.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const chips = [];

      const pick = (re,label,iconPath,transform=(s)=>s)=>{
        const i = ln.findIndex(x=>re.test(x));
        if(i>-1){
          const val = ln[i].replace(re,"$2").trim();
          if(val){
            chips.push(`<span class="chip"><svg viewBox="0 0 24 24">${iconPath}</svg>${label}: ${transform(val)}</span>`);
          }
          ln.splice(i,1);
        }
      };

      pick(/^(-\s*)?Distance and elevation gain\/loss:\s*(.*)$/i,"Distance",
        `<rect x="3" y="7" width="18" height="12" rx="2"/><path d="M7 7V5h10v2"/>`,
        s=>s.replace(/Primary.*$/i,"").trim()
      );
      pick(/^(-\s*)?Primary trail\(s\) used:\s*(.*)$/i,"Trail",
        `<path d="M3 17l8-14 8 14"/><path d="M12 13v8"/>`
      );
      pick(/^(-\s*)?Terrain:\s*(.*)$/i,"Terrain",
        `<path d="M3 20l9-16 9 16z"/>`
      );
      pick(/^(-\s*)?Notable features:\s*(.*)$/i,"Features",
        `<path d="M12 2l3 7H5z"/>`
      );
      pick(/^(-\s*)?Key water sources:\s*(.*)$/i,"Water",
        `<path d="M12 2v6"/><path d="M5 11h14"/>`
      );
      pick(/^(-\s*)?Campsite location:\s*(.*)$/i,"Campsite",
        `<path d="M12 21s-7-6.6-7-11a7 7 0 1 1 14 0c0 4.4-7 11-7 11z"/><circle cx="12" cy="10" r="3"/>`
      );
      pick(/^(-\s*)?Safety:\s*(.*)$/i,"Safety",
        `<path d="M12 2l9 4-9 16L3 6z"/>`
      );
      pick(/^(-\s*)?Trail tip:\s*(.*)$/i,"Tip",
        `<path d="M5 12h14"/>`
      );
      pick(/^(-\s*)?Bailout:\s*(.*)$/i,"Bailout",
        `<path d="M6 3h12v6H6z"/><path d="M6 9l-3 6h18l-3-6"/>`
      );
      pick(/^(-\s*)?Decision point:\s*(.*)$/i,"Decision",
        `<circle cx="12" cy="12" r="9"/><path d="M12 7v10"/>`
      );
      pick(/^(-\s*)?Morale marker:\s*(.*)$/i,"Morale",
        `<path d="M12 20l-3-3h6z"/>`
      );

      // ignore any remaining long lines here (they’ll render below as list if present)
      return chips.length ? `<div class="chips">${chips.join("")}</div>` : "";
    }

    // ---- MAIN ----
    async function main(){
      const status = $("status");
      const slug = getSlug();
      if(!slug){ status.textContent="Missing slug (?slug= or /expedition/{slug})"; return; }

      const jsonURL = `https://rtpfkfhvlkuagwqdsnfj.supabase.co/storage/v1/object/public/expedition/${slug}.json?cb=${Date.now()}`;
      status.textContent = "Fetching…";

      let data;
      try{
        const res = await fetch(jsonURL, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        let raw = safeParse(text);
        if (raw === null) raw = {};
        data = normalizeData(raw);
      }catch(e){
        status.textContent = "Fetch failed: "+e.message;
        return;
      }

      // header/meta/hero
      $("title").textContent = first(data,["title","name"]) || "";
      $("category").textContent = first(data,["category","type"]) || "";
      $("season").textContent = first(data,["season"]) || "";
      $("location").textContent = first(data,["location","place"]) || "";
      const d = first(data,["date","when"]);
      $("date").textContent = /^\d{4}-\d{2}-\d{2}$/.test(d)
        ? new Date(d+"T00:00:00Z").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"})
        : (d||"");
      const hero = first(data,["hero_image","hero.url","image"]);
      if (hero) $("hero").src = hero;

      const creditName = first(data,["image_credit","credit","photo_credit"]) || "";
      let creditLink = first(data,["image_link","credit_link","image_credit_link"]) || "";
      if (!isValidUnsplashPhoto(creditLink)) creditLink = "";
      $("credit").innerHTML = creditName
        ? (creditLink
            ? `<a href="${creditLink}" target="_blank" rel="noopener noreferrer" title="${creditLink}">${creditName}</a>`
            : creditName)
        : "";
      const heroLinkEl = $("heroLink");
      if (heroLinkEl) {
        if (creditLink) {
          heroLinkEl.href = creditLink;
          heroLinkEl.style.pointerEvents = "auto";
        } else {
          heroLinkEl.removeAttribute("href");
          heroLinkEl.style.pointerEvents = "none";
        }
      }

      // Mission text
      const mission = first(data,["mission_text","mission","brief","summary"]) || "";

      // Map & GPX
      const mapURL = first(data,["map_embed_url","map_embed","map.url"]);
      if (mapURL) $("map").src = mapURL;

      const gpxURL = first(data,["gpx_download_link","gpx_url","gpx","gpxFile","gpx_file","gpxDownload","gpx_download"]);
      if (gpxURL) {
        const studio = gpxStudioURL(gpxURL);
        $("gpxStudio").src = studio;
        $("gpxStudioLink").href = studio;
        $("gpxBtn").href = gpxURL;
        $("gpxBtn").download = (slug||"route") + ".gpx";
        const th = [first(data,["start_trailhead","start"]), first(data,["end_trailhead","end"])].filter(Boolean).join(" → ");
        if (th) $("trailheads").textContent = th;
      } else {
        $("gpxEmbedWrap").innerHTML = `<div style="opacity:.7;font-size:14px">No GPX URL found (expected <code>gpx_download_link</code>).</div>`;
        $("gpxActions").style.display = "none";
      }

      // --- Parse sections from mission text by headers / dividers ---
      function block(h){ // get a named block between this header and next divider
        const re = new RegExp(`${h.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\$&")}[\\s\\S]*?(?=\\n\\s*⸻|$)`,"i");
        const m = mission.match(re);
        return m ? m[0].replace(new RegExp(`^${h}\\s*\\n?`,"i"),"").trim() : "";
      }

      // 1) Expedition Itinerary summary (grab only the top key stats; avoid repeating the header line)
      const itBlock = block("EXPEDITION ITINERARY:.*");
      const summaryLines = [];
      const pushIf = (rx,label)=>{ const m = itBlock.match(rx); if(m){ summaryLines.push(`<b>${label}:</b> ${m[1].trim()}`); } };
      pushIf(/PRIMARY OBJECTIVE:\s*(.*)/i,"Primary Objective");
      pushIf(/TRIP DURATION:\s*(.*)/i,"Trip Duration");
      pushIf(/TOTAL ESTIMATED MILEAGE:\s*(.*)/i,"Total Mileage");
      pushIf(/EXPERIENCE LEVEL:\s*(.*)/i,"Experience Level");
      pushIf(/TERRAIN TYPE:\s*(.*)/i,"Terrain Type");
      pushIf(/Cumulative elevation gain\/loss.*?:\s*(.*)/i,"Elevation Gain/Loss");
      pushIf(/Start and end trailhead.*?:\s*(.*)/i,"Trailheads");
      pushIf(/GPS coordinates.*?:\s*(.*)/i,"GPS Coordinates");
      $("itinerarySummary").innerHTML = `<div class="kv-list">${summaryLines.map(s=>`<div>${s}</div>`).join("")}</div>`;

      // 2) Permits & Entry
      const permits = block("PERMITS \\& ENTRY");
      $("permits").innerHTML = dashedToUl(permits);

      // 3) Shuttle / Transportation
      const shuttle = block("SHUTTLE \\/? TRANSPORTATION");
      $("shuttle").innerHTML = dashedToUl(shuttle);

      // 4) Timeline
      const timeline = block("PERMIT \\& SHUTTLE TIMELINE");
      if(timeline){
        const rows = timeline.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>{
          const m = l.match(/^-\s*([^:]+):\s*(.*)$/);
          if(m) return `<div><b>${m[1]}:</b> ${m[2]}</div>`;
          return `<div>${l.replace(/^- /,"")}</div>`;
        }).join("");
        $("timeline").innerHTML = rows;
      }

      // 5) Days
      const dayBlocks = extractDayBlocks(mission);
      $("days").innerHTML = dayBlocks.map(db=>{
        const {header, lede, facts} = splitLedeAndFacts(db);
        const chips = factsToChips(facts);
        const title = header.replace(/^DAY\s*/i,"DAY ").replace(/\s+TO\s+/i," → ");
        return `<div class="day">
                  <h3>${title}</h3>
                  <div class="lede">${lede}</div>
                  <div class="spacer"></div>
                  ${chips}
                </div>`;
      }).join("");

      // 6) Supporting sections
      $("campsite").innerHTML   = dashedToUl(block("CAMPSITE INTEL"));
      $("weather").innerHTML    = dashedToUl(block("WEATHER \\& ALTITUDE NOTES"));
      $("gear").innerHTML       = dashedToUl(block("GEAR CHECKLIST"));
      $("risk").innerHTML       = dashedToUl(block("RISK MATRIX \\& HAZARD TIMELINE"));
      $("conditions").innerHTML = dashedToUl(block("CONDITIONS WATCH"));
      $("bailouts").innerHTML   = dashedToUl(block("BAILOUT SUMMARY"));
      $("emergency").innerHTML  = dashedToUl(block("EMERGENCY CONTACTS \\& NUMBERS"));
      $("final").innerHTML      = dashedToUl(block("FINAL BRIEF SUMMARY"));
      $("disclaimer").innerHTML = dashedToUl(block("FIELD DISCLAIMER"));

      // Share button behavior (native share if available)
      const shareBtn = $("actShare");
      if(shareBtn && navigator.share){
        shareBtn.addEventListener("click", (e)=>{
          e.preventDefault();
          navigator.share({ title: document.title, url: location.href }).catch(()=>{});
        });
      }

      status.textContent = "";
      setTimeout(()=>status.remove(), 10);
    }

    if (typeof window !== "undefined") main();
  </script>
</body>
</html>
