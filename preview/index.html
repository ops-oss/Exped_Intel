<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Scout Live Preview</title>
<style>
  :root{ --bg:#efefec; --ink:#1f1f1f; --paper:#fff; --accent:#fe5733; --div:rgba(0,0,0,.12); --div-soft:rgba(0,0,0,.08); }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .shell{display:grid; grid-template-columns:minmax(320px,460px) 1fr; gap:16px; max-width:1200px; margin:0 auto; padding:16px;}
  @media (max-width:980px){ .shell{ grid-template-columns:1fr; } }

  /* Left panel */
  .panel{ background:var(--paper); border:1px solid var(--div); border-radius:12px; padding:16px; }
  .form-panel > h2{
    font-weight:900; font-size:clamp(48px,7vw,72px); line-height:1.02; letter-spacing:-0.025em; margin:0 0 8px;
  }
  .muted{opacity:.7; font-size:14px; line-height:1.5}

  /* Form grid */
  .grp{margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; align-items:end}
  .row-1{grid-column:1 / -1}
  .grp label{font-size:12px; letter-spacing:.08em; text-transform:uppercase; opacity:.7}
  .grp input, .grp select, .grp textarea{
    width:100%; padding:12px 14px; border:1px solid var(--div); border-radius:12px; background:#fff; font:inherit;
    transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .grp textarea{ min-height:120px; resize:vertical; line-height:1.5; }
  .grp input:focus, .grp select:focus, .grp textarea:focus{
    outline:0; border-color:rgba(0,0,0,.28); box-shadow:0 0 0 3px rgba(0,0,0,.06);
  }
  #scoutForm select{
    background-image:linear-gradient(to bottom,transparent,transparent),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23111' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    background-repeat:no-repeat; background-position:right 12px center; background-size:18px; padding-right:38px;
  }

  /* Buttons */
  .btn{
    appearance:none !important; background:#111 !important; color:#fff !important; border:none !important;
    border-radius:8px !important; font-weight:800 !important; font-size:15px !important; letter-spacing:.015em !important;
    padding:12px 18px !important; cursor:pointer;
    transition:background .12s ease, transform .08s ease, box-shadow .14s ease;
    box-shadow:0 2px 0 rgba(0,0,0,.25), 0 4px 6px rgba(0,0,0,.22);
  }
  .btn:hover{ background:#333 !important; transform:translateY(-1px);
    box-shadow:0 2px 0 rgba(0,0,0,.25), 0 6px 10px rgba(0,0,0,.25); }
  .btn:active{ background:#000 !important; transform:translateY(0);
    box-shadow:0 1px 0 rgba(0,0,0,.3), 0 3px 6px rgba(0,0,0,.2); }
  .btn[disabled]{ opacity:.55; cursor:default }
  .btn.ghost{ background:#fff !important; color:#111 !important; border:1px solid rgba(0,0,0,.18) !important; box-shadow:none !important; }

  /* Right preview */
  .preview{background:transparent; padding:0}
  .page{background:transparent}
  .title{font-weight:900; letter-spacing:-.02em; line-height:1.02; font-size:clamp(48px,7vw,72px); margin:4px 8px 12px}
  .meta{display:grid; grid-template-columns:1fr 1fr; gap:6px 28px; padding:8px; margin:0 8px 12px;}
  .meta .cell{background:transparent !important; border:0 !important; padding:0 !important; box-shadow:none !important;}
  .meta .label{font-size:12px; letter-spacing:.12em; text-transform:uppercase; opacity:.65; margin-bottom:2px}
  .meta .value{font-size:clamp(18px,2.2vw,24px); line-height:1.28}
  @media (min-width:820px){ .meta{grid-template-columns:repeat(4,1fr);} }

  .hero{margin:0 8px 16px; border-radius:12px; overflow:hidden; border:1px solid var(--div)}
  .hero img{display:block; width:100%; height:auto; aspect-ratio:16/9; object-fit:cover; background:#ddd}

  /* Tabs + card */
  .tabs{margin:0 8px}
  .tablist{display:flex; gap:8px; padding:0; margin:0; list-style:none}
  .ei-tab{
    appearance:none; border:none; display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
    font-weight:800; font-size:14px; background:#fff; border:1px solid var(--div); border-radius:12px; cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.02);
  }
  .ei-tab[aria-selected="false"]{opacity:.78}
  .ei-tab[aria-selected="true"]{opacity:1; border-color:rgba(0,0,0,.22)}
  .card{
    background:#fff; border:1px solid var(--div); border-radius:12px; border-top-left-radius:0;
    padding:14px; position:relative; top:-1px; margin-bottom:16px; transition:opacity .18s ease, transform .18s ease;
  }
  .card.is-enter{ opacity:0; transform: translateY(4px); }
  .card.is-enter.is-on{ opacity:1; transform: translateY(0); }

  .subhead{margin:4px 0 10px; opacity:.8}
  .row{display:flex; gap:12px; align-items:flex-start; padding:8px 0; border-top:1px dashed var(--div-soft)}
  .row:first-of-type{border-top:0}
  .row .k{flex:0 0 220px; font-weight:800}
  @media (max-width:560px){ .row{flex-direction:column} .row .k{flex:0 0 auto} }
  .chips{display:flex; flex-wrap:wrap; gap:8px 10px}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#fff; border:1px solid rgba(0,0,0,.18); border-radius:8px; font-size:14px}
  .chip.secondary{ background:#f5f5f5; border-color:rgba(0,0,0,.12); font-size:13.5px }
  .muter{opacity:.6}
  .empty{padding:24px; text-align:center; border:1px dashed var(--div); border-radius:12px; background:#fff; margin:8px}

  /* CTA area */
  #blueprintCta{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; }
  #blueprintCta small{ font-size:13px; opacity:.65; margin-top:1px; }
  #blueprintCta .btn-cta{
    appearance:none !important; border:none !important; padding:12px 18px !important; border-radius:8px !important;
    font-weight:800 !important; font-size:15px !important; line-height:1 !important; letter-spacing:.015em !important;
    background:#fe5733 !important; color:#fff !important;
    box-shadow:0 2px 0 rgba(0,0,0,.25), 0 4px 6px rgba(0,0,0,.22) !important;
    transition:transform .08s ease, box-shadow .14s ease, filter .14s ease !important; will-change:transform,box-shadow,filter;
  }
  #blueprintCta .btn-cta:hover{
    filter:brightness(1.05); transform:translateY(-1px);
    box-shadow:0 2px 0 rgba(0,0,0,.25), 0 6px 10px rgba(0,0,0,.25) !important;
  }
  #blueprintCta .btn-cta:active{
    transform:translateY(0); filter:brightness(.98);
    box-shadow:0 1px 0 rgba(0,0,0,.3), 0 3px 6px rgba(0,0,0,.2) !important;
  }

  /* Loader (inside card) */
  #scoutLoading{ display:flex; align-items:center; gap:14px; padding:16px; border:1px dashed var(--div); border-radius:12px; background:#fff; }
  #scoutLoading .spin{ width:22px; height:22px; border-radius:50%; border:3px solid rgba(0,0,0,.12); border-top-color:#fe5733; animation: ei-spin .8s linear infinite; }
  #scoutLoading .h{ font-weight:800; margin:0 0 4px; }
  #scoutLoading .p{ opacity:.65; font-size:13px; margin:0 0 10px; }
  #scoutLoading .bar{ position:relative; height:6px; background:rgba(0,0,0,.06); border-radius:999px; overflow:hidden;}
  #scoutLoading .bar span{ position:absolute; inset:0 auto 0 0; width:35%; background:#fe5733; border-radius:999px; animation: ei-sweep 1.1s ease-in-out infinite; }

  @keyframes ei-spin { to { transform: rotate(360deg); } }
  @keyframes ei-sweep { 0%{left:-35%;width:35%} 50%{left:35%;width:40%} 100%{left:100%;width:35%} }

  /* Mobile tweaks */
  @media (max-width:640px){
    .shell{padding:10px; gap:10px}
    .form-panel.panel{padding:12px}
    #scoutForm.grp{grid-template-columns:1fr; gap:8px}
    .title{font-size:clamp(28px,8vw,40px); margin:6px 8px}
    .meta{grid-template-columns:1fr 1fr; gap:6px 10px}
    .hero{margin:0 8px 10px}
    .tablist{gap:6px}
    .ei-tab{padding:8px 10px; font-size:13px}
    .card{padding:12px}
    .btn, .btn-cta{width:100%}
  }
  /* required / optional markers driven by classes */
#scoutForm label.is-required::after{
  content:" *";
  color:#fe5733;
  font-weight:700;
}
#scoutForm label.is-optional::after{
  content:" (optional)";
  opacity:.55;
  font-weight:500;
}
/* opt-out support if you add data-no-auto on a label */
#scoutForm label[data-no-auto]::after{ content:none !important; }
  /* ===== CLEAN SELECT STYLING FIX ===== */

/* Remove native arrows (Chrome, Safari, Firefox) */
#scoutForm select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  text-overflow: ellipsis;          /* avoids clipping long placeholder */
  white-space: nowrap;
  overflow: hidden;
}

/* Custom single arrow (SVG) — perfectly aligned, replaces double */
#scoutForm select {
  background-image:
    linear-gradient(to bottom, transparent, transparent),
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23111' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 18px;
  padding-right: 40px; /* space for custom arrow */
}

/* Force consistent vertical alignment */
#scoutForm select option {
  line-height: 1.4;
  padding: 4px 6px;
}
  /* ===== Date Input Placeholder Refinement ===== */

/* Target only the trip date field */
#tripDate {
  font-size: 15px !important;
  letter-spacing: 0.03em;
  text-align: left;
  padding-left: 12px;
}

/* Shrink and lighten placeholder text */
#tripDate::placeholder {
  font-size: 13px;
  letter-spacing: 0.05em;
  color: rgba(0,0,0,0.45);
}

/* Ensure calendar icon stays vertically centered */
#tripDate::-webkit-calendar-picker-indicator {
  margin-left: -2px;
  opacity: 0.8;
  cursor: pointer;
}
  /* ===== Global placeholder size refinement ===== */
#scoutForm ::placeholder {
  font-size: 13px !important;
  letter-spacing: 0.03em;
  color: rgba(0,0,0,0.45) !important;
}

/* Match placeholder feel for selects */
#scoutForm select {
  font-size: 15px !important;
}

/* Compact dropdown labels so “Select From Dropdown” fits cleanly */
#scoutForm select option:first-child {
  font-size: 13px !important;
  color: rgba(0,0,0,0.5);
}
/* ↓ Smaller text inside selects so long placeholder fits */
#scoutForm select{
  font-size: 14px !important;          /* was 16 */
  padding-right: 38px;                  /* keep room for arrow */
}
#scoutForm select option{ font-size: 14px !important; }

/* Make it even smaller only while the placeholder is selected */
#scoutForm select:has(option[value=""]:checked){
  font-size: 13px !important;
  letter-spacing: 0;
}

/* ↓ Date input: shrink visible text & placeholder */
#scoutForm input[type="date"]{
  font-size: 14px !important;           /* was 16 */
}
#scoutForm input[type="date"]::-webkit-datetime-edit{
  font-size: 14px !important;
}
#scoutForm input[type="date"]::placeholder{
  font-size: 14px !important;
}
  .hero figcaption {
  font-size: 12px;
  opacity: .7;
  padding: 6px 8px;
  background: #fff;
  border-top: 1px solid var(--div);
}
  /* Hero loading overlay */
.hero{ position:relative; } /* ensure overlay positions correctly */
#hero_loading{
  position:absolute; inset:auto 8px 8px 8px;  /* bottom bar */
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border:1px solid var(--div); border-radius:10px;
  background:rgba(255,255,255,.92); backdrop-filter:saturate(1.2) blur(2px);
  box-shadow:0 2px 10px rgba(0,0,0,.08);
  font-size:13px; line-height:1.3;
}
#hero_loading[hidden]{ display:none; }
#hero_loading .spin{
  width:18px; height:18px; border-radius:50%;
  border:3px solid rgba(0,0,0,.12); border-top-color:var(--accent);
  animation: ei-spin .8s linear infinite;
}
  #pv_hero {
  background: linear-gradient(145deg, #f2f2f2, #d9d9d9);
  object-fit: cover;
}
  #hero_loading {
  position: absolute;
  inset: 0;                       /* fill the image frame */
  display: flex;
  align-items: center;
  justify-content: center;        /* center horizontally & vertically */
  gap: 10px;
  background: rgba(255,255,255,0.85);
  backdrop-filter: saturate(1.2) blur(3px);
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.3;
  z-index: 2;
}

#hero_loading[hidden] {
  display: none;
}
</style>
</head>
<body>
  <main class="shell">
    <!-- LEFT: form -->
    <aside class="panel form-panel">
      <h2>Discover Your Recon</h2>
      <p class="muted">Your objective sets the direction. Our intel builds the route.</p>

      <form id="scoutForm" class="grp" novalidate>
        <!-- Trip title -->
        <div class="row-1">
          <label for="tripTitle">Trip title (optional)</label>
          <input id="tripTitle" name="title" data-ei-meta="title" placeholder="Zion West Rim Adventure"/>
        </div>

        <!-- Date + Based in -->
        <div>
          <label for="tripDate">Trip date</label>
          <input id="tripDate" type="date" name="tripDate" data-ei-meta="date"/>
        </div>
        <div>
          <label for="fBasedIn">(City/State/Country)</label>
          <input id="fBasedIn" name="based_in" type="text" placeholder="Boulder, CO" required/>
        </div>

        <!-- Name + Email -->
        <div>
          <label for="fName">Name</label>
          <input id="fName" name="name" type="text" placeholder="Jane Rider" required/>
        </div>
        <div>
          <label for="fEmail">Email</label>
          <input id="fEmail" name="email" type="email" placeholder="jane@domain.com" required/>
        </div>

        <!-- Experience + Primary Objective -->
        <div>
          <label for="fExp">Experience level</label>
          <select id="fExp" name="experience_level" required>
            <option value="">— Select —</option>
            <option>Beginner</option>
            <option>Intermediate</option>
            <option>Advanced</option>
            <option>Elite</option>
          </select>
        </div>
        <div>
          <label for="fObjective">Primary Objective?</label>
          <select id="fObjective" name="primary_objective" data-ei-meta="category" required>
            <option value="">Select From Dropdown</option>
            <option>Out and Back</option>
            <option>Loop Hike</option>
            <option>End-To-End Traverse</option>
            <option>Peak Summit / High Alpine Trekking</option>
            <option>Multi Week Section / Through Hike</option>
            <option>Summit Expedition</option>
            <option>Packrafting / Paddling Expedition</option>
            <option>Hybrid / Multi-Sport Traverse</option>
          </select>
        </div>

        <!-- Ideal trip length + Preferred terrain -->
        <div>
          <label for="fLength">Ideal Trip Length?</label>
          <select id="fLength" name="ideal_trip_length" required>
            <option value="">Select From Dropdown</option>
            <option>1–2</option>
            <option>3–4</option>
            <option>5–6</option>
            <option>7+</option>
          </select>
        </div>
        <div>
          <label for="fTerrain">Preferred terrain</label>
          <select id="fTerrain" name="preferred_terrain" required>
            <option value="">Select From Dropdown</option>
            <option>Alpine Lakes</option>
            <option>Large Mountains</option>
            <option>Coastal</option>
            <option>Forest</option>
            <option>Rivers</option>
            <option>Desert</option>
            <option>Glacial / Snowfield</option>
            <option>Scrambling & Peakbagging</option>
          </select>
        </div>

        <!-- Destination + idea -->
        <div>
          <label for="fDestination">Destination</label>
          <select id="fDestination">
            <option value="">Select From Dropdown</option>
            <option>I know exactly where</option>
            <option>I have a few ideas</option>
            <option>I want you to choose for me</option>
          </select>
        </div>
        <div>
          <label for="fIdea">Destination idea</label>
          <input id="fIdea" name="destination_idea" data-ei-meta="location" type="text" placeholder="e.g., Wheeler Peak, Lost Coast…"/>
        </div>

        <!-- Additional details -->
        <div class="row-1">
          <label for="fAdditional">Additional details</label>
          <textarea id="fAdditional" name="additional" rows="5"
            placeholder="Fitness, recent trips, gear constraints, permit constraints, group size, etc."></textarea>
        </div>

        <!-- Actions -->
        <div class="row-1" style="display:flex; gap:10px; align-items:center; margin-top:6px">
          <button class="btn" id="btnGenerate" type="submit">Generate Scout</button>
          <button class="btn ghost" id="loadSample" data-dev type="button">Load sample 3 options</button>
        </div>
      </form>
    </aside>

    <!-- RIGHT: live preview -->
    <section class="panel preview">
      <div class="page">
        <h1 class="title" id="pv_title">Scout Recon</h1>

        <div class="meta">
          <div class="cell"><div class="label">Category</div><div class="value" id="pv_category">—</div></div>
          <div class="cell"><div class="label">Season</div><div class="value" id="pv_season">—</div></div>
          <div class="cell"><div class="label">Location</div><div class="value" id="pv_location">—</div></div>
          <div class="cell"><div class="label">Date</div><div class="value" id="pv_date">—</div></div>
        </div>

        <figure class="hero">
  <img id="pv_hero"
     alt="Hero image"
     src="../assets/recon-placeholder.jpg"
     decoding="async"
     loading="eager" />

  <div id="hero_loading" hidden aria-live="polite">
    <div class="spin"></div>
    <span>Recon in progress — locating your terrain…</span>
  </div>

  <figcaption id="pv_credit" style="display:none;padding:6px 8px;font-size:13px;"></figcaption>
</figure>

        <nav class="tabs" aria-label="Options">
          <ul class="tablist" role="tablist" id="optTabs"></ul>
        </nav>

        <div class="card" id="optCard">
          <p class="subhead muter">Your route options will appear here after you submit the form (or load samples).</p>
          <div class="empty">No options loaded yet.</div>
          <div class="cta" id="blueprintCta" style="display:none">
            <button class="btn-cta" id="btnBlueprint" type="button" disabled>Blueprint this route →</button>
            <small id="ctaHint">Select an option above</small>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
/* ---------- tiny helpers ---------- */
const $id = (id)=>document.getElementById(id);
const chip = (t,secondary=false)=>`<span class="chip${secondary?' secondary':''}">${t}</span>`;
const fmtDateView = (s)=> s ? new Date(s+"T00:00:00").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"}) : "—";

/* ===== Parse SCOUT text (options only) ===== */
function parseScoutOptions(txt){
  const sections=[]; const re=/OPTION\s+(\d+)\s+–\s+([^\n]+)\s*\n([\s\S]*?)(?=\n---|\nFINAL RECOMMENDATION|$)/g; let m;
  while((m=re.exec(txt))!==null){
    const [,idx,title,body]=m;
    const grab=(label)=>{ const r=new RegExp(label+":\\s*([\\s\\S]*?)(?:\\n\\n|\\r\\n\\r\\n|\\n(?=[A-Z][A-Za-z ]+:)|$)");
      const mm=body.match(r); return mm?mm[1].trim():""; };
    const kv=(label)=>grab(label).split("\n")[0].trim();
    const region=kv("Region");
    const dist=kv("Distance and elevation gain/loss");
    const duration=kv("Suggested Duration");
    const objective=kv("Primary Objective");
    const terrain=kv("Terrain");
    const season=kv("Ideal Season");
    const hazards=kv("Known Hazards");
    const culmin=kv("Culminating Objective");
    const objClass=kv("Objective Class");
    const advantage=kv("Strategic Advantage");
    const routeType=kv("Route Type");
    const overview=grab("Route Overview");
    const logistics=grab("Logistics Snapshot");
    const intelBlock=grab("Intel Score \\(1–10\\)");

    let miles=null, gain_ft=null, loss_ft=null;
    const mmiles=dist.match(/([\d.,]+)\s*miles?/i); if(mmiles) miles=mmiles[1];
    const mgain=dist.match(/\+([\d.,]+)\s*ft/i);    const mloss=dist.match(/-([\d.,]+)\s*ft/i);
    if(mgain) gain_ft=mgain[1].replace(/,/g,""); if(mloss) loss_ft=mloss[1].replace(/,/g,"");

    const intel={}; if(intelBlock){
      intelBlock.split("\n").forEach(line=>{
        const t=line.match(/•?\s*([A-Za-z ]+):\s*(\d+)/); if(t) intel[t[1].trim()]=Number(t[2]);
      });
    }

    let blueprint_url=""; const linkMatch=body.match(/\[Blueprint[^\]]*\]\((https?:\/\/[^\s)]+)\)/i);
    if(linkMatch) blueprint_url=linkMatch[1];

    sections.push({ index:Number(idx), title:title.trim(), region, overview, miles, gain_ft, loss_ft, duration,
      objective, terrain, season, hazards, culminating_objective:culmin, objective_class:objClass,
      strategic_advantage:advantage, route_type:routeType, logistics, intel, blueprint_url });
  }
  return sections;
}

/* ===== Build one option card body ===== */
function buildScoutCard(opt, index){
  const chips=[];
  if(opt.duration) chips.push(chip(opt.duration));
  if(opt.miles)    chips.push(chip(`${opt.miles} miles`));
  if(opt.gain_ft || opt.loss_ft){
    const up = opt.gain_ft ? Number(opt.gain_ft).toLocaleString() : "0";
    const dn = opt.loss_ft ? Number(opt.loss_ft).toLocaleString() : "0";
    chips.push(chip(`+${up} ft / -${dn} ft`));
  }
  if(opt.terrain) chips.push(chip(opt.terrain,true));

  let logisticsHTML=""; if(opt.logistics){
    const lines = opt.logistics.replace(/\r/g,"").split("\n").map(s=>s.replace(/^[•\-\u2022]\s*/,"").trim()).filter(Boolean);
    if(lines.length){ logisticsHTML = `<ul style="margin:6px 0 0 18px; padding:0; line-height:1.5">${lines.map(li=>`<li>${li}</li>`).join("")}</ul>`; }
  }

  const intelHTML = Object.keys(opt.intel||{}).length
    ? `<div class="chips" style="margin-top:8px">${Object.entries(opt.intel).map(([k,v])=>`<span class="chip secondary">${k}: ${v}</span>`).join(" ")}</div>`
    : "";

  return `
    <div>
      <h3 style="margin:0 0 4px">${opt.title || `Option ${index+1}`}</h3>
      ${opt.region ? `<p class="subhead">${opt.region}</p>` : ""}
      ${chips.length ? `<div class="chips" style="margin:6px 0 10px">${chips.join(" ")}</div>` : ""}
      ${opt.overview ? `<p class="previewP" style="margin-top:8px">${opt.overview}</p>` : ""}
      <div class="row"><div class="k">Primary Objective:</div><div>${opt.objective || "—"}</div></div>
      <div class="row"><div class="k">Ideal Season:</div><div>${opt.season || "—"}</div></div>
      <div class="row"><div class="k">Known Hazards:</div><div>${opt.hazards || "—"}</div></div>
      <div class="row"><div class="k">Culminating Objective:</div><div>${opt.culminating_objective || "—"}</div></div>
      <div class="row"><div class="k">Objective Class:</div><div>${opt.objective_class || "—"}</div></div>
      <div class="row"><div class="k">Strategic Advantage:</div><div>${opt.strategic_advantage || "—"}</div></div>
      <div class="row"><div class="k">Route Type:</div><div>${opt.route_type || "—"}</div></div>
      ${logisticsHTML ? `<div class="row" style="border-top:1px dashed var(--div-soft); padding-top:10px"><div class="k">Logistics Snapshot:</div><div>${logisticsHTML}</div></div>` : ""}
      ${intelHTML}
    </div>
  `;
}
// === CHECKOUT (Scout ➜ Blueprint) ===
const CHECKOUT_ENDPOINT =
  "https://rtpfkfhvlkuagwqdsnfj.supabase.co/functions/v1/create-checkout-session";

// 👉 Put your Stripe Price ID here (from the Scout → Blueprint product)
const PRICE_UPGRADE = "price_1S4jmKKyANuReHHWTf5jC6CB"; // <-- replace with your real Price ID

/* ===== CTA wiring ===== */
function ensureCTA(){
  const card=$id('optCard'); if(!card) return;
  let wrap=$id('blueprintCta');
  if(!wrap){
    wrap=document.createElement('div'); wrap.id='blueprintCta'; wrap.className='cta';
    wrap.innerHTML=`<button class="btn-cta" id="btnBlueprint" type="button" disabled>Blueprint this route →</button><small id="ctaHint">Select an option above</small>`;
    card.appendChild(wrap);
  }
}

function saveScoutContext(optIndex){
  try {
    const ctx = { options: SCOUT.options || [], chosenIndex: optIndex, createdAt: Date.now() };
    localStorage.setItem("ei_scout_v1", JSON.stringify(ctx));
  } catch {}
}

async function startCheckout(opt){
  saveScoutContext(ACTIVE);

  const btn = document.getElementById("btnBlueprint");
  if (btn) { btn.disabled = true; btn.textContent = "Opening checkout…"; }

  try {
    const payload = {
      price_id: PRICE_UPGRADE, // ✅ REQUIRED by your edge function
      customer_email: document.getElementById("fEmail")?.value || "",
      metadata: {
        option_index: ACTIVE + 1,
        option_title: opt.title || `Option ${ACTIVE + 1}`,
        // add anything useful for webhook / orders:
        intake_id: window.EI_INTAKE_ID || "",
        source: "scout_preview"
      }
    };

    const res = await fetch(CHECKOUT_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data?.url) throw new Error("No checkout URL");

    window.location.href = data.url;
  } catch (err) {
    console.error(err);
    alert("Checkout unavailable. Please try again.");
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = `Blueprint this route →`;
    }
  }
}

function updateCTA_forScout(opt){
  const wrap=$id('blueprintCta'), btn=$id('btnBlueprint'), hint=$id('ctaHint');
  if(!wrap||!btn||!hint) return;
  if(!opt){ wrap.style.display='none'; return; }

  btn.disabled=false;
  btn.textContent=`Blueprint “${opt.title || `Option ${ACTIVE+1}`}” →`;
  hint.textContent='Purchase to unlock full Blueprint';
  wrap.style.display='flex';
  btn.onclick=()=> startCheckout(opt);
}

/* ===== State + tabs ===== */
let SCOUT={ options:[] }, ACTIVE=0;

function setActive(idx){
  ACTIVE=idx;
  const tabs=$id("optTabs"), card=$id("optCard"); if(!tabs||!card) return;
  tabs.querySelectorAll("button").forEach((b,i)=>b.setAttribute("aria-selected", i===idx ? "true" : "false"));
  const opt=SCOUT.options[idx];
  card.innerHTML=buildScoutCard(opt, idx);
  ensureCTA(); updateCTA_forScout(opt);
}

function renderTabs(){
  const tabs=$id("optTabs"); if(!tabs) return;
  tabs.innerHTML=(SCOUT.options||[]).map((o,i)=>{
    const label=o.label||o.title||o.route||o.tagline?.marketing||"";
    const name=label ? `OPTION ${i+1} — ${label}` : `OPTION ${i+1}`;
    return `<li><button type="button" class="ei-tab" role="tab" aria-selected="${i===ACTIVE?'true':'false'}" data-idx="${i}">${name}</button></li>`;
  }).join("");
  tabs.onclick=(e)=>{ const b=e.target.closest("button[data-idx]"); if(!b) return; const idx=+b.dataset.idx; if(Number.isInteger(idx)) setActive(idx); };
}

/* ===== Sample data (dev) ===== */
document.getElementById("loadSample")?.addEventListener("click", ()=>{
  SCOUT.options = [
    { index:1, title:"Mount Bierstadt Summit", region:"Front Range, Colorado", overview:"Classic CO 14er with a well-defined path to the summit.",
      miles:"7", gain_ft:"2850", loss_ft:"2850", duration:"1–2 days", objective:"Peak Summit / High Alpine Trekking",
      terrain:"Alpine meadows and rocky switchbacks", season:"mid-July–Sept", hazards:"Afternoon thunderstorms, altitude sickness",
      culminating_objective:"Mount Bierstadt, 14,065 ft", objective_class:"Class 1", strategic_advantage:"Straightforward ascent with big alpine views.",
      route_type:"Out-and-Back", logistics:"- Permit: No\n- Trailhead Access: Easy\n- Water: Requires planning\n- Campsite: Limited\n- Exit Strategy: Commit to full route",
      intel:{Solitude:5,"Photo Ops":8,"Physical Challenge":6,"Navigation Difficulty":3,"Scenic Reward":9},
      blueprint_url:"https://www.expeditionintel.com/upgrade?source=scout&option=1" },
    { index:2, title:"Mount Elbert Summit", region:"Sawatch Range, Colorado", overview:"Colorado’s highest peak; steep final push; massive vistas.",
      miles:"9", gain_ft:"4700", loss_ft:"4700", duration:"1–2 days", objective:"Peak Summit / High Alpine Trekking",
      terrain:"Forested trails and alpine ridges", season:"mid-July–Sept", hazards:"Weather changes, altitude effects",
      culminating_objective:"Mount Elbert, 14,440 ft", objective_class:"Class 1", strategic_advantage:"Prestige of CO high point with stunning views.",
      route_type:"Out-and-Back", logistics:"- Permit: No\n- Trailhead Access: Easy\n- Water: Sparse\n- Campsite: Abundant dispersed\n- Exit Strategy: Commit to full route",
      intel:{Solitude:4,"Photo Ops":9,"Physical Challenge":8,"Navigation Difficulty":3,"Scenic Reward":10},
      blueprint_url:"https://www.expeditionintel.com/upgrade?source=scout&option=2" },
    { index:3, title:"Quandary Peak Summit", region:"Tenmile Range, Colorado", overview:"Popular but rewarding summit with big Breck views.",
      miles:"6.75", gain_ft:"3450", loss_ft:"3450", duration:"1–2 days", objective:"Peak Summit / High Alpine Trekking",
      terrain:"Forested slopes and rocky ridges", season:"mid-July–Sept", hazards:"Weather changes, altitude effects",
      culminating_objective:"Quandary Peak, 14,265 ft", objective_class:"Class 1", strategic_advantage:"Straightforward climb; quick summit adventure.",
      route_type:"Out-and-Back", logistics:"- Permit: No\n- Trailhead Access: Easy\n- Water: Plan to carry\n- Campsite: Limited\n- Exit Strategy: Commit to full route",
      intel:{Solitude:4,"Photo Ops":8,"Physical Challenge":6,"Navigation Difficulty":2,"Scenic Reward":9},
      blueprint_url:"https://www.expeditionintel.com/upgrade?source=scout&option=3" }
  ];
  ACTIVE=0; renderTabs(); setActive(0);
});

/* ===== Submit to Edge ===== */
const ENDPOINT = "https://rtpfkfhvlkuagwqdsnfj.supabase.co/functions/v1/shadow-scout-recon-send";

// === HERO IMAGE ENDPOINT ===
const HERO_ENDPOINT = "https://rtpfkfhvlkuagwqdsnfj.supabase.co/functions/v1/hero-image";
// Cancel in-flight lookups when user types fast
let heroAbort;
async function fetchHero({ place, region, orientation = "landscape" }) {
  if (heroAbort) heroAbort.abort();
  heroAbort = new AbortController();

  const q = [place, region].filter(Boolean).join(" ").trim();
  if (!q) return null;

  const u = new URL(HERO_ENDPOINT);
  u.searchParams.set("source", "auto");      // NPS first, then Unsplash
  u.searchParams.set("q", q);
  u.searchParams.set("orientation", orientation);
  u.searchParams.set("max", "1");

  const res = await fetch(u.toString(), { signal: heroAbort.signal });
  if (!res.ok) return null;
  const json = await res.json();             // { count, data: [ {src, credit, link, ...} ] }
  return (json.data && json.data[0]) || null;
}
  
$id("scoutForm")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const f=e.currentTarget;
  const get=(n)=> (f.elements.namedItem(n)?.value || "").trim();

  // combine destination
  const pref=(f.querySelector("#fDestination")?.value || "").trim();
  const idea=get("destination_idea");
  const destCombined = pref ? (idea ? `${pref}: ${idea}` : pref) : idea;
  const dateISO = get("tripDate");
  const season  = seasonFromISODate(dateISO);

// normalize en-dash to hyphen for enums like 1-2, 3-4, 5-6, 7+
const normalizeDash = s => (s || "").replace(/[–—]/g, "-");

// --- final payload (camelCase to match Edge) ---
const payload = {
  name: get("name"),
  email: get("email"),
  basedIn: get("based_in"),
  experienceLevel: get("experience_level"),
  primaryObjective: get("primary_objective"),
  idealTripLength: get("ideal_trip_length"),
  preferredTerrain: get("preferred_terrain"),
  destinationIdea: destCombined,     // optional; Edge doesn't require it
  additional: get("additional"),
  tripWindow: season                 // <-- was trip_window
};

  const required = [
  "name",
  "email",
  "basedIn",
  "experienceLevel",
  "primaryObjective",
  "idealTripLength",
  "preferredTerrain"
];
  const miss=required.filter(k=>!payload[k]); if(miss.length){ alert("Please complete:\n• "+miss.join("\n• ")); return; }

  const btn=$id("btnGenerate"); if(btn){ btn.disabled=true; btn.textContent="Generating…"; }
  const card=$id("optCard");
  if(card) card.innerHTML=`
    <div id="scoutLoading">
      <div class="spin"></div>
      <div>
        <div class="h">Generating your Scout Recon</div>
        <div class="p">Compiling routes and intel…</div>
        <div class="bar"><span></span></div>
      </div>
    </div>`;

  try {
    const res = await fetch(ENDPOINT, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload),
  keepalive: true
});

// Try to parse JSON (new mode: includes intake_id + text)
let data = {};
try {
  data = await res.json();
} catch {
  // Fallback if old text-only response
  const txt = await res.text();
  data = { text: txt };
}

// ✅ Store intake_id (used later in Stripe upgrade metadata)
if (data.intake_id) {
  localStorage.setItem("ei_intake_id", data.intake_id);
}

const text = data.text || "";

    if (!res.ok || !text) {
      card && (card.innerHTML = `<div class="empty">Something went wrong. Please try again.</div>`);
      return;
    }

    const opts = parseScoutOptions(text);
    if (!opts.length) {
      console.warn("Could not parse Scout text:", text);
      card && (card.innerHTML = `<div class="empty">Scout was sent via email. (Preview parsing unavailable)</div>`);
      return;
    }

    SCOUT.options = opts.sort((a,b)=>a.index-b.index);
    ACTIVE = 0;
    renderTabs();
    setActive(0);
  } catch (err) {
    console.error(err);
    card && (card.innerHTML = `<div class="empty">Network error. Please try again.</div>`);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = "Generate Scout"; }
  }
}); // <-- closes addEventListener
/* =========================
   Live preview wiring
   ========================= */
function seasonFromISODate(iso){
  if(!iso) return "";
  const m = Number(iso.slice(5,7));
  if([12,1,2].includes(m)) return "Winter";
  if([3,4,5].includes(m))  return "Spring";
  if([6,7,8].includes(m))  return "Summer";
  return "Fall";
}

(function liveMirror(){
  const form = document.getElementById("scoutForm");
  if (!form) return;

  const OUT = {
    title:    document.getElementById("pv_title"),
    category: document.getElementById("pv_category"),
    season:   document.getElementById("pv_season"),
    location: document.getElementById("pv_location"),
    date:     document.getElementById("pv_date"),
    hero:     document.getElementById("pv_hero")
  };
  
  const heroLoader = document.getElementById("hero_loading");
  const showHeroLoading = (on) => {
  if (!heroLoader) return;
  heroLoader.hidden = !on;
};

    // Debounced hero updater
let heroTimer = null;

async function updateHeroIfNeeded(placeText) {
  clearTimeout(heroTimer);

  heroTimer = setTimeout(async () => {
    const heroImg = OUT.hero;
    if (!heroImg) return;

    if (!placeText || placeText.trim().length < 3) {
  // show a static default so users see something right away
  heroImg.src = "/assets/recon-placeholder.jpg"; 
  const credit = document.getElementById("pv_credit");
  if (credit) { 
    credit.textContent = ""; 
    credit.style.display = "none"; 
  }
  showHeroLoading(false);
  return;
}

    // show loading overlay
    showHeroLoading(true);
    heroImg.style.opacity = "0.6";

    try {
      // Try to split "Place, Region" into parts so NPS/Unsplash match better
      const [placePart, regionPart] = placeText.split(/\s*[,|-]\s*/);
      const place = (placePart || "").trim();
      const region = (regionPart || "").trim();

      const hit = await fetchHero({
        place,
        region,
        orientation: "landscape"
      });

      if (hit && hit.src) {
        heroImg.src = hit.src;
        heroImg.alt = hit.alt || placeText;

        const credit = document.getElementById("pv_credit");
        if (credit) {
          credit.innerHTML = hit.credit ? hit.credit : "";
          credit.style.display = hit.credit ? "block" : "none";
        }
      }
    } catch (err) {
      console.error("Hero fetch error:", err);
    } finally {
      heroImg.style.opacity = "1";
      showHeroLoading(false); // hide overlay when done
    }
  }, 250);
}

  const getMeta = (k)=> form.querySelector(`[data-ei-meta="${k}"]`)?.value?.trim() || "";

  function paint(){
  const dateISO = getMeta("date");
  const season  = seasonFromISODate(dateISO) || "—";

  OUT.title    && (OUT.title.textContent    = getMeta("title")    || "Scout Recon");
  OUT.category && (OUT.category.textContent = getMeta("category") || "—");
  OUT.season   && (OUT.season.textContent   = season);
  OUT.location && (OUT.location.textContent = getMeta("location") || "—");
  OUT.date     && (OUT.date.textContent     = dateISO ? fmtDateView(dateISO) : "—");

  const loc = getMeta("location");
  const ttl = getMeta("title");
  const heroQuery = loc || ttl;           // fall back to the title
  updateHeroIfNeeded(heroQuery);
}

  form.addEventListener("input", paint);
  form.addEventListener("change", paint);
  paint();
})();
/* ===== Initial ===== */
(function initPreview(){
  ensureCTA();
})();
  /* =========================================================
   MARK REQUIRED / OPTIONAL LABELS
   ========================================================= */
(function markRequiredOptional(){
  const form = document.getElementById('scoutForm');
  if (!form) return;
  form.querySelectorAll('label').forEach(label=>{
    if (label.hasAttribute('data-no-auto')) return; // skip if manually controlled
    const ctrl = label.nextElementSibling;
    if (!ctrl) return;
    label.classList.toggle('is-required',  ctrl.matches('[required]'));
    label.classList.toggle('is-optional', !ctrl.matches('[required]'));
  });
})();
</script>
</body>
</html>
