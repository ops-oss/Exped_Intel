<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Scout Live Preview</title>
<style>
  :root{ --bg:#efefec; --ink:#1f1f1f; --paper:#fff; --accent:#fe5733; --div:rgba(0,0,0,.12); --div-soft:rgba(0,0,0,.08); }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .shell {
  display: grid;
  grid-template-columns: 35% 65%; /* widen the right panel */
  gap: 24px;
  max-width: 1200px;
  margin: 0 auto;
  padding: 16px;
}

@media (max-width: 900px) {
  .shell {
    grid-template-columns: 1fr;
  }
}
  

  /* Left panel */
  .panel{ background:var(--paper); border:1px solid var(--div); border-radius:12px; padding:16px; }
  .form-panel > h2{
    font-weight:900; font-size:clamp(48px,7vw,72px); line-height:1.02; letter-spacing:-0.025em; margin:0 0 8px;
  }
  .muted{opacity:.7; font-size:14px; line-height:1.5}

  /* Form grid */
  .grp{margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:8px 12px; align-items:end}
  .row-1{grid-column:1 / -1}
  .grp label{font-size:12px; letter-spacing:.08em; text-transform:uppercase; opacity:.7}
  .grp input, .grp select, .grp textarea{
    width:100%; padding:12px 14px; border:1px solid var(--div); border-radius:12px; background:#fff; font:inherit;
    transition:border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .grp textarea{ min-height:120px; resize:vertical; line-height:1.5; }
  .grp input:focus, .grp select:focus, .grp textarea:focus{
    outline:0; border-color:rgba(0,0,0,.28); box-shadow:0 0 0 3px rgba(0,0,0,.06);
  }
  #scoutForm select{
    background-image:linear-gradient(to bottom,transparent,transparent),
      url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23111' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
    background-repeat:no-repeat; background-position:right 12px center; background-size:18px; padding-right:38px;
  }

  /* Buttons */
  .btn{
    appearance:none !important; background:#111 !important; color:#fff !important; border:none !important;
    border-radius:8px !important; font-weight:800 !important; font-size:15px !important; letter-spacing:.015em !important;
    padding:12px 18px !important; cursor:pointer;
    transition:background .12s ease, transform .08s ease, box-shadow .14s ease;
    box-shadow:0 2px 0 rgba(0,0,0,.25), 0 4px 6px rgba(0,0,0,.22);
  }
  .btn:hover{ background:#333 !important; transform:translateY(-1px);
    box-shadow:0 2px 0 rgba(0,0,0,.25), 0 6px 10px rgba(0,0,0,.25); }
  .btn:active{ background:#000 !important; transform:translateY(0);
    box-shadow:0 1px 0 rgba(0,0,0,.3), 0 3px 6px rgba(0,0,0,.2); }
  .btn[disabled]{ opacity:.55; cursor:default }
  .btn.ghost{ background:#fff !important; color:#111 !important; border:1px solid rgba(0,0,0,.18) !important; box-shadow:none !important; }

.actions.duo {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  align-items: stretch;
}

/* Base */
.btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-radius: 10px;
  padding: 14px 18px;
  font-size: 18px;
  font-weight: 500;
  border: 1px solid var(--chip-border, rgba(0,0,0,.22));
  cursor: pointer;
  transition: background .2s ease, color .2s ease, border-color .2s ease;
}
.btn .label { transition: opacity .2s ease; }
.btn .label.hover { opacity: 0; position: absolute; }

/* Scout: ghost ‚Üí black */
.btn.ghost {
  background: transparent;
  color: var(--ink);
}
.btn.ghost:hover {
  background: var(--ink);
  color: var(--paper);
}
.btn.ghost:hover .label.default { opacity: 0; }
.btn.ghost:hover .label.hover   { opacity: 1; }

/* Blueprint: black ‚Üí orange */
.btn.cta {
  background: var(--ink);
  color: var(--paper);
  border-color: transparent;
}
.btn.cta:hover {
  background: var(--accent); /* your Expedition orange */
  color: var(--paper);
}
.btn.cta:hover .label.default { opacity: 0; }
.btn.cta:hover .label.hover   { opacity: 1; }

@media (max-width:640px){ .actions.duo { grid-template-columns: 1fr; } }

  .actions.actions--form{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin-top:10px;
  width:100%;
}
@media (max-width:720px){ .actions.actions--form{ grid-template-columns:1fr; } }

.btn{
  display:inline-flex; align-items:center; justify-content:center;
  height:48px; padding:0 16px; border-radius:10px;
  border:1px solid var(--chip-border, rgba(0,0,0,.22));
  font:600 16px/1 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  letter-spacing:.01em; white-space:nowrap; cursor:pointer;
  transition: background-color .18s ease, color .18s ease, border-color .18s ease;
}
.btn--full{ width:100%; }

.btn--ghost{ background:transparent; color:var(--ink); }
.btn--ghost:hover{ background:var(--ink); color:var(--paper); }

.btn--cta{ background:var(--ink); color:var(--paper); border-color:transparent; }
.btn--cta:hover{ background:var(--accent); color:var(--paper); }

.actions--form .btn{ overflow:hidden; text-overflow:ellipsis; }
 
  /* Right preview */
  .preview{background:transparent; padding:0}
  .page{background:transparent}
  .title{font-weight:900; letter-spacing:-.02em; line-height:1.02; font-size:clamp(48px,7vw,72px); margin:4px 8px 12px}
  .meta{display:grid; grid-template-columns:1fr 1fr; gap:6px 28px; padding:8px; margin:0 8px 12px;}
  .meta .cell{background:transparent !important; border:0 !important; padding:0 !important; box-shadow:none !important;}
  .meta .label{font-size:12px; letter-spacing:.12em; text-transform:uppercase; opacity:.65; margin-bottom:2px}
  .meta .value{font-size:clamp(18px,2.2vw,24px); line-height:1.28}
  @media (min-width:820px){ .meta{grid-template-columns:repeat(4,1fr);} }

  .hero{margin:0 8px 16px; border-radius:12px; overflow:hidden; border:1px solid var(--div)}
  .hero img{display:block; width:100%; height:auto; aspect-ratio:16/9; object-fit:cover; background:#ddd}

  /* Tabs + card */
  .tabs{margin:0 8px}
  .tablist{display:flex; gap:8px; padding:0; margin:0; list-style:none}
  .ei-tab{
    appearance:none; border:none; display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
    font-weight:800; font-size:14px; background:#fff; border:1px solid var(--div); border-radius:12px; cursor:pointer;
    box-shadow:0 1px 0 rgba(0,0,0,.02);
  }
  .ei-tab[aria-selected="false"]{opacity:.78}
  .ei-tab[aria-selected="true"]{opacity:1; border-color:rgba(0,0,0,.22)}
  .card{
    background:#fff; border:1px solid var(--div); border-radius:12px; border-top-left-radius:0;
    padding:14px; position:relative; top:-1px; margin-bottom:16px; transition:opacity .18s ease, transform .18s ease;
  }
  .card.is-enter{ opacity:0; transform: translateY(4px); }
  .card.is-enter.is-on{ opacity:1; transform: translateY(0); }

  .subhead{margin:4px 0 10px; opacity:.8}
  .row{display:flex; gap:12px; align-items:flex-start; padding:8px 0; border-top:1px dashed var(--div-soft)}
  .row:first-of-type{border-top:0}
  .row .k{flex:0 0 220px; font-weight:800}
  @media (max-width:560px){ .row{flex-direction:column} .row .k{flex:0 0 auto} }
  .chips{display:flex; flex-wrap:wrap; gap:8px 10px}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:#fff; border:1px solid rgba(0,0,0,.18); border-radius:8px; font-size:14px}
  .chip.secondary{ background:#f5f5f5; border-color:rgba(0,0,0,.12); font-size:13.5px }
  .muter{opacity:.6}
  .empty{padding:24px; text-align:center; border:1px dashed var(--div); border-radius:12px; background:#fff; margin:8px}

  /* CTA area */
  #blueprintCta{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:10px; }
  #blueprintCta small{ font-size:13px; opacity:.65; margin-top:1px; }
  #blueprintCta .btn-cta{
    appearance:none !important; border:none !important; padding:12px 18px !important; border-radius:8px !important;
    font-weight:800 !important; font-size:15px !important; line-height:1 !important; letter-spacing:.015em !important;
    background:#fe5733 !important; color:#fff !important;
    box-shadow:0 2px 0 rgba(0,0,0,.25), 0 4px 6px rgba(0,0,0,.22) !important;
    transition:transform .08s ease, box-shadow .14s ease, filter .14s ease !important; will-change:transform,box-shadow,filter;
  }
  #blueprintCta .btn-cta:hover{
    filter:brightness(1.05); transform:translateY(-1px);
    box-shadow:0 2px 0 rgba(0,0,0,.25), 0 6px 10px rgba(0,0,0,.25) !important;
  }
  #blueprintCta .btn-cta:active{
    transform:translateY(0); filter:brightness(.98);
    box-shadow:0 1px 0 rgba(0,0,0,.3), 0 3px 6px rgba(0,0,0,.2) !important;
  }

  /* Loader (inside card) */
  #scoutLoading{ display:flex; align-items:center; gap:14px; padding:16px; border:1px dashed var(--div); border-radius:12px; background:#fff; }
  #scoutLoading .spin{ width:22px; height:22px; border-radius:50%; border:3px solid rgba(0,0,0,.12); border-top-color:#fe5733; animation: ei-spin .8s linear infinite; }
  #scoutLoading .h{ font-weight:800; margin:0 0 4px; }
  #scoutLoading .p{ opacity:.65; font-size:13px; margin:0 0 10px; }
  #scoutLoading .bar{ position:relative; height:6px; background:rgba(0,0,0,.06); border-radius:999px; overflow:hidden;}
  #scoutLoading .bar span{ position:absolute; inset:0 auto 0 0; width:35%; background:#fe5733; border-radius:999px; animation: ei-sweep 1.1s ease-in-out infinite; }

  @keyframes ei-spin { to { transform: rotate(360deg); } }
  @keyframes ei-sweep { 0%{left:-35%;width:35%} 50%{left:35%;width:40%} 100%{left:100%;width:35%} }

  /* Mobile tweaks */
  @media (max-width:640px){
    .shell{padding:10px; gap:10px}
    .form-panel.panel{padding:12px}
    #scoutForm.grp{grid-template-columns:1fr; gap:8px}
    .title{font-size:clamp(28px,8vw,40px); margin:6px 8px}
    .meta{grid-template-columns:1fr 1fr; gap:6px 10px}
    .hero{margin:0 8px 10px}
    .tablist{gap:6px}
    .ei-tab{padding:8px 10px; font-size:13px}
    .card{padding:12px}
    .btn, .btn-cta{width:100%}
  }
  /* required / optional markers driven by classes */
#scoutForm label.is-required::after{
  content:" *";
  color:#fe5733;
  font-weight:700;
}
#scoutForm label.is-optional::after{
  content:" (optional)";
  opacity:.55;
  font-weight:500;
}
/* opt-out support if you add data-no-auto on a label */
#scoutForm label[data-no-auto]::after{ content:none !important; }
  /* ===== CLEAN SELECT STYLING FIX ===== */

/* Remove native arrows (Chrome, Safari, Firefox) */
#scoutForm select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  text-overflow: ellipsis;          /* avoids clipping long placeholder */
  white-space: nowrap;
  overflow: hidden;
}

/* Custom single arrow (SVG) ‚Äî perfectly aligned, replaces double */
#scoutForm select {
  background-image:
    linear-gradient(to bottom, transparent, transparent),
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23111' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polyline points='6 9 12 15 18 9'/></svg>");
  background-repeat: no-repeat;
  background-position: right 14px center;
  background-size: 18px;
  padding-right: 40px; /* space for custom arrow */
}

/* Force consistent vertical alignment */
#scoutForm select option {
  line-height: 1.4;
  padding: 4px 6px;
}
  /* ===== Date Input Placeholder Refinement ===== */

/* Target only the trip date field */
#tripDate {
  font-size: 15px !important;
  letter-spacing: 0.03em;
  text-align: left;
  padding-left: 12px;
}

/* Shrink and lighten placeholder text */
#tripDate::placeholder {
  font-size: 13px;
  letter-spacing: 0.05em;
  color: rgba(0,0,0,0.45);
}

/* Ensure calendar icon stays vertically centered */
#tripDate::-webkit-calendar-picker-indicator {
  margin-left: -2px;
  opacity: 0.8;
  cursor: pointer;
}
  /* ===== Global placeholder size refinement ===== */
#scoutForm ::placeholder {
  font-size: 13px !important;
  letter-spacing: 0.03em;
  color: rgba(0,0,0,0.45) !important;
}

/* Match placeholder feel for selects */
#scoutForm select {
  font-size: 15px !important;
}

/* Compact dropdown labels so ‚ÄúSelect From Dropdown‚Äù fits cleanly */
#scoutForm select option:first-child {
  font-size: 13px !important;
  color: rgba(0,0,0,0.5);
}
/* ‚Üì Smaller text inside selects so long placeholder fits */
#scoutForm select{
  font-size: 14px !important;          /* was 16 */
  padding-right: 38px;                  /* keep room for arrow */
}
#scoutForm select option{ font-size: 14px !important; }

/* Make it even smaller only while the placeholder is selected */
#scoutForm select:has(option[value=""]:checked){
  font-size: 13px !important;
  letter-spacing: 0;
}

/* ‚Üì Date input: shrink visible text & placeholder */
#scoutForm input[type="date"]{
  font-size: 14px !important;           /* was 16 */
}
#scoutForm input[type="date"]::-webkit-datetime-edit{
  font-size: 14px !important;
}
#scoutForm input[type="date"]::placeholder{
  font-size: 14px !important;
}
  .hero figcaption {
  font-size: 12px;
  opacity: .7;
  padding: 6px 8px;
  background: #fff;
  border-top: 1px solid var(--div);
}
  /* Hero loading overlay */
.hero{ position:relative; } /* ensure overlay positions correctly */
#hero_loading{
  position:absolute; inset:auto 8px 8px 8px;  /* bottom bar */
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border:1px solid var(--div); border-radius:10px;
  background:rgba(255,255,255,.92); backdrop-filter:saturate(1.2) blur(2px);
  box-shadow:0 2px 10px rgba(0,0,0,.08);
  font-size:13px; line-height:1.3;
}
#hero_loading[hidden]{ display:none; }
#hero_loading .spin{
  width:18px; height:18px; border-radius:50%;
  border:3px solid rgba(0,0,0,.12); border-top-color:var(--accent);
  animation: ei-spin .8s linear infinite;
}
  #pv_hero {
  background: linear-gradient(145deg, #f2f2f2, #d9d9d9);
  object-fit: cover;
}
  #hero_loading {
  position: absolute;
  inset: 0;                       /* fill the image frame */
  display: flex;
  align-items: center;
  justify-content: center;        /* center horizontally & vertically */
  gap: 10px;
  background: rgba(255,255,255,0.85);
  backdrop-filter: saturate(1.2) blur(3px);
  border-radius: 12px;
  font-size: 13px;
  line-height: 1.3;
  z-index: 2;
}

#hero_loading[hidden] {
  display: none;
}
  /* =========================
   FINAL OVERRIDES (buttons)
   ========================= */

/* 1) Lock the actions row to a 2-col grid on desktop */
.actions.actions--form{
  display: grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap: 14px !important;
  width: 100% !important;
  margin-top: 12px !important;
  box-sizing: border-box;
}

/* 2) Only stack on small screens (tighten breakpoint) */
@media (max-width: 560px){
  .actions.actions--form{ grid-template-columns: 1fr !important; }
}

/* 3) Normalize the base button so ‚Äúghost‚Äù can actually be transparent */
.actions.actions--form .btn{
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  height: 52px !important;
  padding: 0 22px !important;
  width: 100% !important;
  border-radius: 10px !important;
  border: 1px solid var(--chip-border, rgba(0,0,0,.22)) !important;
  box-sizing: border-box !important;

  /* make sure no global .btn background bleeds in */
  background: transparent !important;
  color: var(--ink) !important;

  font: 600 17px/1.1 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif !important;
  letter-spacing: .01em !important;

  transition: background-color .2s ease, color .2s ease, border-color .2s ease !important;
  white-space: nowrap !important;
  overflow: visible !important;
  text-overflow: unset !important;
}

/* 4) Scout: ghost by default, black on hover */
.actions.actions--form .btn--ghost{
  background: transparent !important;
  color: var(--ink) !important;
  border-color: var(--chip-border, rgba(0,0,0,.22)) !important;
}
.actions.actions--form .btn--ghost:hover{
  background: var(--ink) !important;
  color: var(--paper) !important;
}

/* 5) Blueprint: black by default, Expedition Orange on hover */
.actions.actions--form .btn--cta{
  background: var(--ink) !important;
  color: var(--paper) !important;
  border-color: transparent !important;
}
.actions.actions--form .btn--cta:hover{
  background: var(--accent, #FF6A00) !important;  /* fallback orange */
  color: var(--paper) !important;
}
  /* =========================
   ACTION BUTTONS ‚Äî FINAL OVERRIDES
   ========================= */

/* Keep buttons inside the form column and prevent grid overflow */
.actions.actions--form{
  display: grid !important;
  grid-template-columns: minmax(0,1fr) minmax(0,1fr) !important; /* <- key: allows shrinking */
  gap: 14px !important;
  width: 100% !important;
  margin-top: 12px !important;
  box-sizing: border-box !important;
  align-self: stretch !important;    /* stay within the form‚Äôs column */
  justify-self: stretch !important;
}
.actions.actions--form > *{ min-width: 0 !important; } /* prevent content from widening the grid */

/* Stack only when the LEFT FORM column gets narrow */
@media (max-width: 900px){
  .actions.actions--form{ grid-template-columns: 1fr !important; }
}

/* Uniform button sizing/typography (no overflow, no wrapping) */
.actions.actions--form .btn{
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  height: 52px !important;
  padding: 0 22px !important;
  width: 100% !important;
  max-width: 100% !important;
  min-width: 0 !important;
  border-radius: 10px !important;
  border: 1px solid var(--chip-border, rgba(0,0,0,.22)) !important;
  box-sizing: border-box !important;

  background: transparent !important;     /* base = transparent so ghost works */
  color: var(--ink) !important;

  font: 600 17px/1.1 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif !important;
  letter-spacing: .01em !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;

  transition: background-color .2s ease, color .2s ease, border-color .2s ease !important;
}

/* Scout: ghost default ‚Üí black hover */
.actions.actions--form .btn--ghost{
  background: transparent !important;
  color: var(--ink) !important;
  border-color: var(--chip-border, rgba(0,0,0,.22)) !important;
}
.actions.actions--form .btn--ghost:hover{
  background: var(--ink) !important;
  color: var(--paper) !important;
}

/* Blueprint: black default ‚Üí orange hover */
.actions.actions--form .btn--cta{
  background: var(--ink) !important;
  color: var(--paper) !important;
  border-color: transparent !important;
}
.actions.actions--form .btn--cta:hover{
  background: var(--accent, #ff6a00) !important; /* fallback orange */
  color: var(--paper) !important;
}
  /* ==============================
   FINAL ‚Äì FORM ACTION BUTTONS
   ============================== */

/* container: always full width, always stacked */
.actions.actions--form {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  justify-content: flex-start !important;
  width: 100% !important;
  margin-top: 16px !important;
  gap: 10px !important;          /* space between buttons */
  box-sizing: border-box !important;
}

/* button base */
.actions.actions--form .btn {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  height: 52px !important;
  width: 100% !important;
  border-radius: 10px !important;
  border: 1px solid var(--chip-border, rgba(0,0,0,.22)) !important;
  font: 600 17px/1.1 "Helvetica Neue", Helvetica, Arial, sans-serif !important;
  letter-spacing: .01em !important;
  text-align: center !important;
  white-space: nowrap !important;
  cursor: pointer !important;
  transition: background-color .18s ease, color .18s ease !important;
  box-sizing: border-box !important;
}

/* Scout (ghost default ‚Üí black on hover) */
.actions.actions--form .btn--ghost {
  background: transparent !important;
  color: var(--ink) !important;
}
.actions.actions--form .btn--ghost:hover {
  background: var(--ink) !important;
  color: var(--paper) !important;
}

/* Blueprint (black default ‚Üí orange on hover) */
.actions.actions--form .btn--cta {
  background: var(--ink) !important;
  color: var(--paper) !important;
  border-color: transparent !important;
}
.actions.actions--form .btn--cta:hover {
  background: var(--accent, #ff6a00) !important;
  color: var(--paper) !important;
}
  .ei-footer {
  background: #111;
  color: #f5f5f5;
  padding: 20px 16px 28px;
  font-size: 11px;
}

.ei-footer-inner {
  max-width: 960px;
  margin: 0 auto;
  text-align: center;
}

/* Mission notice line */
.ei-footer-mission {
  color: #ff6a00; /* Expedition Intel orange */
  text-transform: uppercase;
  letter-spacing: 0.06em;
  line-height: 1.6;
  border-top: 1px solid rgba(255, 255, 255, 0.2);
  padding-top: 8px;
  margin: 0 0 12px;
}

/* ¬© line */
.ei-footer-meta {
  margin: 0 0 4px;
}

/* Links line */
.ei-footer-links {
  margin: 0;
}

.ei-footer a {
  color: #ff6a00;
  text-decoration: none;
}

.ei-footer a:hover {
  text-decoration: underline;
}

.ei-footer-separator {
  display: inline-block;
  padding: 0 6px;
  opacity: 0.7;
}

/* Card container polish */
#optCard {
  border-radius: 12px;
  padding: 20px 24px;
  background: #f7f7f7;
  border: 1px solid #e3e3e3;
}

/* General text in the card */
#optCard .subhead.muter {
  font-size: 12px;
  line-height: 1.6;
  color: #555;
  margin-bottom: 0.75rem;
}

/* Risk label styling (the bold line) */
#optCard .subhead.muter strong {
  display: block;
  font-size: 11px;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: #ff6a00; /* your orange */
  margin-bottom: 4px;
}

/* Terms/Privacy line */
#optCard .subhead.muter a {
  text-decoration: underline;
  font-weight: 500;
}

  #optCard {
  text-align: center;
}

#optCard .subhead.muter {
  text-align: center;
}

#optCard .empty {
  text-align: center;
}

  /* Make links in the options card orange */
#optCard a {
  color: #ff6a00;
  text-decoration: underline;
  font-weight: 500;
}

#optCard a:hover {
  text-decoration: none;
}

  /* Match options card width to hero image */
#optCard {
  margin: 0 8px 16px;           /* same horizontal insets as .hero */
  border-radius: 12px;
  padding: 20px 24px;
  background: #f7f7f7;
  border: 1px solid #e3e3e3;
}

  /* Softer, pill-style tabs that float more */
.tablist{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  padding:0;
  margin:0 8px 8px;        /* align with hero/card insets */
  list-style:none;
  justify-content:center;  /* center them under the image */
}

.ei-tab{
  appearance:none;
  border:1px solid var(--div);
  background:#fff;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  padding:8px 14px;
  border-radius:999px;                         /* full pill */
  font-weight:700;
  font-size:12px;
  letter-spacing:0.08em;
  text-transform:uppercase;
  cursor:pointer;
  box-shadow:0 2px 4px rgba(0,0,0,.04);
  transition:
    border-color .15s ease,
    box-shadow .15s ease,
    background-color .15s ease,
    transform .1s ease,
    opacity .12s ease;
}

.ei-tab[aria-selected="false"]{
  opacity:.7;
}

.ei-tab[aria-selected="true"]{
  opacity:1;
  background:#fff5ec;
  border-color:#ff6a00;
  color:#111;
  box-shadow:0 4px 10px rgba(0,0,0,.08);
  transform:translateY(-1px);
}

.ei-tab:hover{
  border-color:#ff6a00;
  box-shadow:0 3px 6px rgba(0,0,0,.08);
  transform:translateY(-1px);
}

  /* Tabs wrapper: match hero/card insets */
.tabs{
  margin: 0 8px 8px;   /* same horizontal margin as .hero and #optCard */
}

/* Tab list: full width inside that wrapper */
.tablist{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  padding:0;
  margin:0;
  list-style:none;
  justify-content:flex-start;  /* no centering, align like chips */
}

  /* Chip-style option tabs (no pills) */
.ei-tab{
  appearance:none;
  border:1px solid rgba(0,0,0,.18);
  background:#f5f5f5;                  /* like .chip.secondary */
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:8px 12px;
  border-radius:8px;                   /* match chip radius */
  font-weight:700;
  font-size:13px;
  letter-spacing:.02em;
  text-transform:none;                 /* text is already ‚ÄúOPTION 1 ‚Äî ‚Ä¶‚Äù */
  cursor:pointer;
  box-shadow:0 1px 0 rgba(0,0,0,.02);
  transition:
    background-color .15s ease,
    border-color .15s ease,
    box-shadow .15s ease,
    opacity .12s ease;
}

.ei-tab[aria-selected="false"]{
  opacity:.8;
}

.ei-tab[aria-selected="true"]{
  opacity:1;
  background:#fff;
  border-color:#ff6a00;                /* brand orange */
  box-shadow:0 2px 4px rgba(0,0,0,.08);
}

.ei-tab:hover{
  background:#fff;
  border-color:#ff6a00;
}

  @media (max-width:640px){
  .tablist{
    gap:6px;
  }

  /* Allow tabs to wrap but keep a clean grid feel */
  .ei-tab{
    flex: 1 1 calc(50% - 6px);  /* roughly 2-up on small screens */
    justify-content:center;
  }
}

  /* Scout options card: all content left-aligned */
#optCard,
#optCard p,
#optCard .subhead,
#optCard .subhead.muter,
#optCard .row,
#optCard .chips,
#optCard .empty {
  text-align: left;
}

  /* Kill iOS blue on selects (mobile + desktop) */
#scoutForm select {
  color: #222 !important;                 /* normal value color */
  -webkit-text-fill-color: #222 !important;
}

/* Placeholder state (when the empty option is selected) */
#scoutForm select:has(option[value=""]:checked) {
  color: rgba(0,0,0,0.45) !important;     /* softer grey for "Select From Dropdown" */
  -webkit-text-fill-color: rgba(0,0,0,0.45) !important;
}
</style>
</head>
<body>
  <main class="shell">
    <!-- LEFT: form -->
    <aside class="panel form-panel">
      <h2>Discover. Decide. Design.</h2>
      <p style="font-weight:700; font-size:1.5em;">
        Start with recon or straight to the Blueprint. Your intel builds live.</p>

      <form id="scoutForm" class="grp" novalidate>
        <!-- Trip title -->
        <div class="row-1">
          <label for="tripTitle">Trip title (optional)</label>
          <input id="tripTitle" name="title" data-ei-meta="title" placeholder="Zion West Rim Adventure"/>
        </div>

        <!-- Date + Based in -->
        <div>
          <label for="tripDate">Trip date</label>
          <input id="tripDate" type="date" name="tripDate" data-ei-meta="date" required/>
        </div>
        <div>
          <label for="fBasedIn">(City/State/Country)</label>
          <input id="fBasedIn" name="based_in" type="text" placeholder="Boulder, CO" required/>
        </div>

        <!-- Name + Email -->
        <div>
          <label for="fName">Name</label>
          <input id="fName" name="name" type="text" placeholder="Jane Rider" required/>
        </div>
        <div>
          <label for="fEmail">Email</label>
          <input id="fEmail" name="email" type="email" placeholder="jane@domain.com" required/>
        </div>

        <!-- Experience + Primary Objective -->
        <div>
          <label for="fExp">Experience level</label>
          <select id="fExp" name="experience_level" required>
            <option value="">‚Äî Select ‚Äî</option>
            <option>Beginner</option>
            <option>Intermediate</option>
            <option>Advanced</option>
            <option>Elite</option>
          </select>
        </div>
        <div>
          <label for="fObjective">Primary Objective?</label>
          <select id="fObjective" name="primary_objective" data-ei-meta="category" required>
            <option value="">Select From Dropdown</option>
            <option>Out and Back</option>
            <option>Loop Hike</option>
            <option>End-To-End Traverse</option>
            <option>Peak Summit / High Alpine Trekking</option>
            <option>Multi Week Section / Through Hike</option>
            <option>Summit Expedition</option>
            <option>Packrafting / Paddling Expedition</option>
            <option>Hybrid / Multi-Sport Traverse</option>
          </select>
        </div>

        <!-- Ideal trip length + Preferred terrain -->
        <div>
          <label for="fLength">Ideal Trip Length?</label>
          <select id="fLength" name="ideal_trip_length" required>
            <option value="">Select From Dropdown</option>
            <option>1‚Äì2</option>
            <option>3‚Äì4</option>
            <option>5‚Äì6</option>
            <option>7+</option>
          </select>
        </div>
        <div>
          <label for="fTerrain">Preferred terrain</label>
          <select id="fTerrain" name="preferred_terrain" required>
            <option value="">Select From Dropdown</option>
            <option>Alpine Lakes</option>
            <option>Large Mountains</option>
            <option>Coastal</option>
            <option>Forest</option>
            <option>Rivers</option>
            <option>Desert</option>
            <option>Glacial / Snowfield</option>
            <option>Scrambling & Peakbagging</option>
          </select>
        </div>

        <!-- Destination + idea -->
        <div>
          <label for="fDestination">Destination</label>
          <select id="fDestination">
            <option value="">Select From Dropdown</option>
            <option>I know exactly where</option>
            <option>I have a few ideas</option>
            <option>I want you to choose for me</option>
          </select>
        </div>
        <div>
          <label for="fIdea">Destination idea (required for blueprint) </label>
          <input id="fIdea" name="destination_idea" data-ei-meta="location" type="text" placeholder="e.g., Mt Whitney, Lost Coast Trail‚Ä¶"/>
        </div>

        <!-- Additional details -->
        <div class="row-1">
          <label for="fAdditional">Additional details</label>
          <textarea id="fAdditional" name="additional" rows="5"
            placeholder="Fitness, recent trips, gear constraints, permit constraints, group size, etc."></textarea>
        </div>

<!-- Actions -->
<div class="row-1" style="display:flex; gap:10px; align-items:center; margin-top:6px">
<div class="actions actions--form">
  <button id="btnGenerateScout" class="btn btn--ghost" type="submit">
    Discover Free Scout
  </button>

  <button id="btnBuyBlueprint" class="btn btn--cta" type="button">
    Advance to Expedition Blueprint $99
  </button>
</div>
      </form>
    </aside>

    <!-- RIGHT: live preview -->
    <section class="panel preview">
      <div class="page">
        <h1 class="title" id="pv_title">Type to Set Objective</h1>

        <div class="meta">
          <div class="cell"><div class="label">Category</div><div class="value" id="pv_category">‚Äî</div></div>
          <div class="cell"><div class="label">Season</div><div class="value" id="pv_season">‚Äî</div></div>
          <div class="cell"><div class="label">Location</div><div class="value" id="pv_location">‚Äî</div></div>
          <div class="cell"><div class="label">Date</div><div class="value" id="pv_date">‚Äî</div></div>
        </div>

        <figure class="hero">
  <img id="pv_hero"
     alt="Hero image"
     src="../assets/recon-placeholder.jpg"
     decoding="async"
     loading="eager" />

  <div id="hero_loading" hidden aria-live="polite">
    <div class="spin"></div>
    <span>Recon in progress ‚Äî locating your terrain‚Ä¶</span>
  </div>

  <figcaption id="pv_credit" style="display:none;padding:6px 8px;font-size:13px;"></figcaption>
</figure>

        <nav class="tabs" aria-label="Options">
          <ul class="tablist" role="tablist" id="optTabs"></ul>
        </nav>

        <div class="card" id="optCard">

  <p class="subhead muter">
    <strong>Backcountry Risk Notice ‚Äì Scout Recon</strong><br>
    This Scout Recon is planning intel only. Expedition Intel does not guide trips, supervise you in the field, or provide rescue or emergency services. Backcountry travel involves serious risks, including injury and death.
  </p>

  <p class="subhead muter">
    By viewing and using this intel, you acknowledge that you are solely responsible for verifying conditions, securing permits, preparing your team, and making all decisions in the field.
  </p>

  <p class="subhead muter">
    Full details:
    <a href="https://www.expeditionintel.com/terms-of-service" target="_blank" rel="noopener noreferrer">
      Terms of Service
    </a>
    ¬∑
    <a href="https://www.expeditionintel.com/privacy-policy" target="_blank" rel="noopener noreferrer">
      Privacy Policy
    </a>
  </p>

  <div class="empty">Your route options will appear here after you submit the form.</div>
  <div class="cta" id="blueprintCta" style="display:none">
    <button class="btn-cta" id="btnBlueprint" type="button" disabled>Blueprint this route ‚Üí</button>
    <small id="ctaHint">Select an option above</small>
  </div>
</div>
    </section>
  </main>

  <footer class="ei-footer">
  <div class="ei-footer-inner">
    <p class="ei-footer-mission">
      MISSION NOTICE: Expedition Intel issues backcountry recon and route intel only. What you do with it is your call. 
      The outdoors is unforgiving‚Äîinjury, exposure, and death are possible outcomes. By using this site and our intel, 
      you acknowledge that you are solely responsible for your preparation, decisions, and safety.

      We are not your guide, not your rescue plan, and not your insurance.
    </p>

    <p class="ei-footer-meta">
      ¬© 2025 Expedition Intel
    </p>

    <p class="ei-footer-links">
      <a href="https://www.expeditionintel.com/terms-of-service" target="_blank" rel="noopener noreferrer">
        Terms &amp; Disclaimer
      </a>
      <span class="ei-footer-separator">|</span>
      <a href="https://www.expeditionintel.com/privacy-policy" target="_blank" rel="noopener noreferrer">
        Privacy Policy
      </a>
    </p>
  </div>
</footer>

<script>
/* ---------- tiny helpers ---------- */
const $id = (id)=>document.getElementById(id);
const chip = (t,secondary=false)=>`<span class="chip${secondary?' secondary':''}">${t}</span>`;
const fmtDateView = (s)=> s ? new Date(s+"T00:00:00").toLocaleDateString(undefined,{month:"short",day:"numeric",year:"numeric"}) : "‚Äî";

/* ===== Parse SCOUT text (options only) ===== */
function parseScoutOptions(txt){
  const sections=[]; const re=/OPTION\s+(\d+)\s+‚Äì\s+([^\n]+)\s*\n([\s\S]*?)(?=\n---|\nFINAL RECOMMENDATION|$)/g; let m;
  while((m=re.exec(txt))!==null){
    const [,idx,title,body]=m;
    const grab=(label)=>{ const r=new RegExp(label+":\\s*([\\s\\S]*?)(?:\\n\\n|\\r\\n\\r\\n|\\n(?=[A-Z][A-Za-z ]+:)|$)");
      const mm=body.match(r); return mm?mm[1].trim():""; };
    const kv=(label)=>grab(label).split("\n")[0].trim();
    const region=kv("Region");
    const dist=kv("Distance and elevation gain/loss");
    const duration=kv("Suggested Duration");
    const objective=kv("Primary Objective");
    const terrain=kv("Terrain");
    const season=kv("Ideal Season");
    const hazards=kv("Known Hazards");
    const culmin=kv("Culminating Objective");
    const objClass=kv("Objective Class");
    const advantage=kv("Strategic Advantage");
    const routeType=kv("Route Type");
    const overview=grab("Route Overview");
    const logistics=grab("Logistics Snapshot");
    const intelBlock=grab("Intel Score \\(1‚Äì10\\)");

    let miles=null, gain_ft=null, loss_ft=null;
    const mmiles=dist.match(/([\d.,]+)\s*miles?/i); if(mmiles) miles=mmiles[1];
    const mgain=dist.match(/\+([\d.,]+)\s*ft/i);    const mloss=dist.match(/-([\d.,]+)\s*ft/i);
    if(mgain) gain_ft=mgain[1].replace(/,/g,""); if(mloss) loss_ft=mloss[1].replace(/,/g,"");

    const intel={}; if(intelBlock){
      intelBlock.split("\n").forEach(line=>{
        const t=line.match(/‚Ä¢?\s*([A-Za-z ]+):\s*(\d+)/); if(t) intel[t[1].trim()]=Number(t[2]);
      });
    }

    let blueprint_url=""; const linkMatch=body.match(/\[Blueprint[^\]]*\]\((https?:\/\/[^\s)]+)\)/i);
    if(linkMatch) blueprint_url=linkMatch[1];

    sections.push({ index:Number(idx), title:title.trim(), region, overview, miles, gain_ft, loss_ft, duration,
      objective, terrain, season, hazards, culminating_objective:culmin, objective_class:objClass,
      strategic_advantage:advantage, route_type:routeType, logistics, intel, blueprint_url });
  }
  return sections;
}

/* ===== Build one option card body ===== */
function buildScoutCard(opt, index){
  const chips=[];
  if(opt.duration) chips.push(chip(opt.duration));
  if(opt.miles)    chips.push(chip(`${opt.miles} miles`));
  if(opt.gain_ft || opt.loss_ft){
    const up = opt.gain_ft ? Number(opt.gain_ft).toLocaleString() : "0";
    const dn = opt.loss_ft ? Number(opt.loss_ft).toLocaleString() : "0";
    chips.push(chip(`+${up} ft / -${dn} ft`));
  }
  if(opt.terrain) chips.push(chip(opt.terrain,true));

  let logisticsHTML=""; if(opt.logistics){
    const lines = opt.logistics.replace(/\r/g,"").split("\n").map(s=>s.replace(/^[‚Ä¢\-\u2022]\s*/,"").trim()).filter(Boolean);
    if(lines.length){ logisticsHTML = `<ul style="margin:6px 0 0 18px; padding:0; line-height:1.5">${lines.map(li=>`<li>${li}</li>`).join("")}</ul>`; }
  }

  const intelHTML = Object.keys(opt.intel||{}).length
    ? `<div class="chips" style="margin-top:8px">${Object.entries(opt.intel).map(([k,v])=>`<span class="chip secondary">${k}: ${v}</span>`).join(" ")}</div>`
    : "";

  return `
    <div>
      <h3 style="margin:0 0 4px">${opt.title || `Option ${index+1}`}</h3>
      ${opt.region ? `<p class="subhead">${opt.region}</p>` : ""}
      ${chips.length ? `<div class="chips" style="margin:6px 0 10px">${chips.join(" ")}</div>` : ""}
      ${opt.overview ? `<p class="previewP" style="margin-top:8px">${opt.overview}</p>` : ""}
      <div class="row"><div class="k">Primary Objective:</div><div>${opt.objective || "‚Äî"}</div></div>
      <div class="row"><div class="k">Ideal Season:</div><div>${opt.season || "‚Äî"}</div></div>
      <div class="row"><div class="k">Known Hazards:</div><div>${opt.hazards || "‚Äî"}</div></div>
      <div class="row"><div class="k">Culminating Objective:</div><div>${opt.culminating_objective || "‚Äî"}</div></div>
      <div class="row"><div class="k">Objective Class:</div><div>${opt.objective_class || "‚Äî"}</div></div>
      <div class="row"><div class="k">Strategic Advantage:</div><div>${opt.strategic_advantage || "‚Äî"}</div></div>
      <div class="row"><div class="k">Route Type:</div><div>${opt.route_type || "‚Äî"}</div></div>
      ${logisticsHTML ? `<div class="row" style="border-top:1px dashed var(--div-soft); padding-top:10px"><div class="k">Logistics Snapshot:</div><div>${logisticsHTML}</div></div>` : ""}
      ${intelHTML}
    </div>
  `;
}
// === CHECKOUT (Scout ‚ûú Blueprint) ===
const CHECKOUT_ENDPOINT =
  "https://rtpfkfhvlkuagwqdsnfj.supabase.co/functions/v1/create-checkout-session";

// üëâ Put your Stripe Price ID here (from the Scout ‚Üí Blueprint product)
const PRICE_UPGRADE = "price_1S4jmKKyANuReHHWTf5jC6CB"; // <-- replace with your real Price ID

/* ===== CTA wiring ===== */
function ensureCTA(){
  const card=$id('optCard'); if(!card) return;
  let wrap=$id('blueprintCta');
  if(!wrap){
    wrap=document.createElement('div'); wrap.id='blueprintCta'; wrap.className='cta';
    wrap.innerHTML=`<button class="btn-cta" id="btnBlueprint" type="button" disabled>Blueprint this route ‚Üí</button><small id="ctaHint">Select an option above</small>`;
    card.appendChild(wrap);
  }
}

function saveScoutContext(optIndex){
  try {
    const ctx = { options: SCOUT.options || [], chosenIndex: optIndex, createdAt: Date.now() };
    localStorage.setItem("ei_scout_v1", JSON.stringify(ctx));
  } catch {}
}

async function startCheckout(opt){
  saveScoutContext(ACTIVE);

  const btn = document.getElementById("btnBlueprint");
  if (btn) { btn.disabled = true; btn.textContent = "Opening checkout‚Ä¶"; }

  try {
    const payload = {
      price_id: PRICE_UPGRADE, // ‚úÖ REQUIRED by your edge function
      customer_email: document.getElementById("fEmail")?.value || "",
      metadata: {
  source: "scout_preview",
  intake_id: (window.EI_INTAKE_ID || localStorage.getItem("EI_INTAKE_ID") || ""),
  option_index: String(ACTIVE + 1),
  option_title: String(opt.title || `Option ${ACTIVE + 1}`),
  option_uid: String(opt.option_uid || ""),
  user_name:  document.getElementById("fName")?.value?.trim() || "",
  user_email: document.getElementById("fEmail")?.value?.trim() || "",
  trip_date: document.getElementById("tripDate")?.value || "",
  primary_objective: document.getElementById("fObjective")?.value || "",
  preferred_terrain: document.getElementById("fTerrain")?.value || "",
  ideal_trip_length: document.getElementById("fLength")?.value || "",
  based_in: document.getElementById("fBasedIn")?.value || "",
  destination_idea: document.getElementById("fIdea")?.value || "",
  notes: (document.getElementById("fAdditional")?.value || "").slice(0,480),
  trip_window: document.getElementById("tripDate")?.value || "",
}
    };

    const res = await fetch(CHECKOUT_ENDPOINT, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    if (!res.ok || !data?.url) throw new Error("No checkout URL");

    window.location.href = data.url;
  } catch (err) {
    console.error(err);
    alert("Checkout unavailable. Please try again.");
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = `Blueprint this route ‚Üí`;
    }
  }
}

function updateCTA_forScout(opt){
  const wrap=$id('blueprintCta'), btn=$id('btnBlueprint'), hint=$id('ctaHint');
  if(!wrap||!btn||!hint) return;
  if(!opt){ wrap.style.display='none'; return; }

  btn.disabled=false;
  btn.textContent=`Blueprint ‚Äú${opt.title || `Option ${ACTIVE+1}`}‚Äù ‚Üí`;
  hint.textContent='Purchase to unlock full Blueprint';
  wrap.style.display='flex';
  btn.onclick=()=> startCheckout(opt);
}

/* ===== State + tabs ===== */
let SCOUT={ options:[] }, ACTIVE=0;

function setActive(idx){
  ACTIVE=idx;
  const tabs=$id("optTabs"), card=$id("optCard"); if(!tabs||!card) return;
  tabs.querySelectorAll("button").forEach((b,i)=>b.setAttribute("aria-selected", i===idx ? "true" : "false"));
  const opt=SCOUT.options[idx];
  card.innerHTML=buildScoutCard(opt, idx);
  ensureCTA(); updateCTA_forScout(opt);
}

function renderTabs(){
  const tabs=$id("optTabs"); if(!tabs) return;
  tabs.innerHTML=(SCOUT.options||[]).map((o,i)=>{
    const label=o.label||o.title||o.route||o.tagline?.marketing||"";
    const name=label ? `OPTION ${i+1} ‚Äî ${label}` : `OPTION ${i+1}`;
    return `<li><button type="button" class="ei-tab" role="tab" aria-selected="${i===ACTIVE?'true':'false'}" data-idx="${i}">${name}</button></li>`;
  }).join("");
  tabs.onclick=(e)=>{ const b=e.target.closest("button[data-idx]"); if(!b) return; const idx=+b.dataset.idx; if(Number.isInteger(idx)) setActive(idx); };
}

/* ===== Sample data (dev) ===== */
document.getElementById("loadSample")?.addEventListener("click", ()=>{
  SCOUT.options = [
    { index:1, title:"Mount Bierstadt Summit", region:"Front Range, Colorado", overview:"Classic CO 14er with a well-defined path to the summit.",
      miles:"7", gain_ft:"2850", loss_ft:"2850", duration:"1‚Äì2 days", objective:"Peak Summit / High Alpine Trekking",
      terrain:"Alpine meadows and rocky switchbacks", season:"mid-July‚ÄìSept", hazards:"Afternoon thunderstorms, altitude sickness",
      culminating_objective:"Mount Bierstadt, 14,065 ft", objective_class:"Class 1", strategic_advantage:"Straightforward ascent with big alpine views.",
      route_type:"Out-and-Back", logistics:"- Permit: No\n- Trailhead Access: Easy\n- Water: Requires planning\n- Campsite: Limited\n- Exit Strategy: Commit to full route",
      intel:{Solitude:5,"Photo Ops":8,"Physical Challenge":6,"Navigation Difficulty":3,"Scenic Reward":9},
      blueprint_url:"https://www.expeditionintel.com/upgrade?source=scout&option=1" },
    { index:2, title:"Mount Elbert Summit", region:"Sawatch Range, Colorado", overview:"Colorado‚Äôs highest peak; steep final push; massive vistas.",
      miles:"9", gain_ft:"4700", loss_ft:"4700", duration:"1‚Äì2 days", objective:"Peak Summit / High Alpine Trekking",
      terrain:"Forested trails and alpine ridges", season:"mid-July‚ÄìSept", hazards:"Weather changes, altitude effects",
      culminating_objective:"Mount Elbert, 14,440 ft", objective_class:"Class 1", strategic_advantage:"Prestige of CO high point with stunning views.",
      route_type:"Out-and-Back", logistics:"- Permit: No\n- Trailhead Access: Easy\n- Water: Sparse\n- Campsite: Abundant dispersed\n- Exit Strategy: Commit to full route",
      intel:{Solitude:4,"Photo Ops":9,"Physical Challenge":8,"Navigation Difficulty":3,"Scenic Reward":10},
      blueprint_url:"https://www.expeditionintel.com/upgrade?source=scout&option=2" },
    { index:3, title:"Quandary Peak Summit", region:"Tenmile Range, Colorado", overview:"Popular but rewarding summit with big Breck views.",
      miles:"6.75", gain_ft:"3450", loss_ft:"3450", duration:"1‚Äì2 days", objective:"Peak Summit / High Alpine Trekking",
      terrain:"Forested slopes and rocky ridges", season:"mid-July‚ÄìSept", hazards:"Weather changes, altitude effects",
      culminating_objective:"Quandary Peak, 14,265 ft", objective_class:"Class 1", strategic_advantage:"Straightforward climb; quick summit adventure.",
      route_type:"Out-and-Back", logistics:"- Permit: No\n- Trailhead Access: Easy\n- Water: Plan to carry\n- Campsite: Limited\n- Exit Strategy: Commit to full route",
      intel:{Solitude:4,"Photo Ops":8,"Physical Challenge":6,"Navigation Difficulty":2,"Scenic Reward":9},
      blueprint_url:"https://www.expeditionintel.com/upgrade?source=scout&option=3" }
  ];
  ACTIVE=0; renderTabs(); setActive(0);
});

/* ===== Submit to Edge ===== */
const ENDPOINT = "https://rtpfkfhvlkuagwqdsnfj.supabase.co/functions/v1/shadow-scout-recon-send";

// Make sure intake ID persists between form submit and checkout
window.EI_INTAKE_ID = localStorage.getItem("ei_intake_id") || "";
  
// === HERO IMAGE ENDPOINT ===
const HERO_ENDPOINT = "https://rtpfkfhvlkuagwqdsnfj.supabase.co/functions/v1/hero-image";
// Cancel in-flight lookups when user types fast
let heroAbort;
async function fetchHero({ place, region, orientation = "landscape" }) {
  if (heroAbort) heroAbort.abort();
  heroAbort = new AbortController();

  const q = [place, region].filter(Boolean).join(" ").trim();
  if (!q) return null;

  const u = new URL(HERO_ENDPOINT);
  u.searchParams.set("source", "auto");      // NPS first, then Unsplash
  u.searchParams.set("q", q);
  u.searchParams.set("orientation", orientation);
  u.searchParams.set("max", "1");

  const res = await fetch(u.toString(), { signal: heroAbort.signal });
  if (!res.ok) return null;
  const json = await res.json();             // { count, data: [ {src, credit, link, ...} ] }
  return (json.data && json.data[0]) || null;
}
  
$id("scoutForm")?.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const f=e.currentTarget;
  const get=(n)=> (f.elements.namedItem(n)?.value || "").trim();

  // combine destination
  const pref=(f.querySelector("#fDestination")?.value || "").trim();
  const idea=get("destination_idea");
  const destCombined = pref ? (idea ? `${pref}: ${idea}` : pref) : idea;
  const dateISO = get("tripDate");
  const season  = seasonFromISODate(dateISO);

// normalize en-dash to hyphen for enums like 1-2, 3-4, 5-6, 7+
const normalizeDash = s => (s || "").replace(/[‚Äì‚Äî]/g, "-");

// --- final payload (camelCase to match Edge) ---
const payload = {
  name: get("name"),
  email: get("email"),
  basedIn: get("based_in"),
  experienceLevel: get("experience_level"),
  primaryObjective: get("primary_objective"),
  idealTripLength: get("ideal_trip_length"),
  preferredTerrain: get("preferred_terrain"),
  destinationIdea: destCombined,     // optional; Edge doesn't require it
  additional: get("additional"),
  tripWindow: season                 // <-- was trip_window
};

  const required = [
  "name",
  "email",
  "basedIn",
  "experienceLevel",
  "primaryObjective",
  "idealTripLength",
  "preferredTerrain"
];
  const miss=required.filter(k=>!payload[k]); if(miss.length){ alert("Please complete:\n‚Ä¢ "+miss.join("\n‚Ä¢ ")); return; }

  const btn=$id("btnGenerate"); if(btn){ btn.disabled=true; btn.textContent="Generating‚Ä¶"; }
  const card=$id("optCard");
  if(card) card.innerHTML=`
    <div id="scoutLoading">
      <div class="spin"></div>
      <div>
        <div class="h">Generating your Scout Recon</div>
        <div class="p">Compiling routes and intel‚Ä¶</div>
        <div class="bar"><span></span></div>
      </div>
    </div>`;

  try {
    const res = await fetch(ENDPOINT, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload),
  keepalive: true
});

// Try to parse JSON (new mode: includes intake_id + text)
let data = {};
try {
  data = await res.json();
} catch {
  // Fallback if old text-only response
  const txt = await res.text();
  data = { text: txt };
}

// ‚úÖ Store intake_id for this preview session (used by checkout)
if (data.intake_id) {
  try {
    window.EI_INTAKE_ID = data.intake_id;
    localStorage.setItem("EI_INTAKE_ID", data.intake_id);
    console.debug("[preview] EI_INTAKE_ID set ->", data.intake_id);
  } catch (_) {}
}

const text = data.text || "";

    if (!res.ok || !text) {
      card && (card.innerHTML = `<div class="empty">Something went wrong. Please try again.</div>`);
      return;
    }

    const opts = parseScoutOptions(text);
if (!opts.length) {
  console.warn("Could not parse Scout text:", text);
  card && (card.innerHTML = `<div class="empty">Scout was sent via email. (Preview parsing unavailable)</div>`);
  return;
}

/* --- D. Ensure each parsed option carries option_uid (fallback) --- */
(function attachUidFallback() {
  function extractUidFromUrl(href) {
    try {
      const u = new URL(href, location.origin);
      const b64 = u.searchParams.get("b64");
      if (b64) {
        const decoded = JSON.parse(decodeURIComponent(atob(b64)));
        return String(decoded?.metadata?.option_uid || "");
      }
      return String(u.searchParams.get("option_uid") || "");
    } catch {
      return "";
    }
  }
  opts.forEach(o => {
    const href = o?.cta?.url || o?.href || "";
    if (!o.option_uid) o.option_uid = extractUidFromUrl(href);
  });
})();

/* --- Prefer canonical from your schema: scout_latest_payload --- */
try {
  const iid = window.EI_INTAKE_ID || "";
  if (iid) {
    const r = await fetch(
      `${SUPABASE_URL}/rest/v1/scout_latest_payload?select=options&intake_id=eq.${encodeURIComponent(iid)}&limit=1`,
      { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` } }
    );
    const arr = await r.json().catch(() => []);
    const canonical = Array.isArray(arr) && arr[0]?.options ? arr[0].options : null;

    if (canonical && canonical.length) {
      // map canonical -> your UI shape (index/title/region/option_uid)
      const withUids = canonical.map((o, i) => ({
        index:  Number(o.option_index ?? (i + 1)),
        title:  String(o.title ?? `Option ${i + 1}`),
        region: String(o.region ?? ""),
        option_uid: String(o.option_uid ?? "")
      })).sort((a, b) => a.index - b.index);

      SCOUT.options = withUids;
    } else {
      SCOUT.options = opts.sort((a, b) => a.index - b.index);
    }
  } else {
    SCOUT.options = opts.sort((a, b) => a.index - b.index);
  }
} catch {
  SCOUT.options = opts.sort((a, b) => a.index - b.index);
}

// drop any stale hrefs from older runs (safety)
SCOUT.options.forEach(o => { o.blueprint_url = null; });

ACTIVE = 0;
renderTabs();
setActive(0);
  } catch (err) {
    console.error(err);
    card && (card.innerHTML = `<div class="empty">Network error. Please try again.</div>`);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = "Generate Scout"; }
  }
}); // <-- closes addEventListener
/* =========================
   Live preview wiring
   ========================= */
function seasonFromISODate(iso){
  if(!iso) return "";
  const m = Number(iso.slice(5,7));
  if([12,1,2].includes(m)) return "Winter";
  if([3,4,5].includes(m))  return "Spring";
  if([6,7,8].includes(m))  return "Summer";
  return "Fall";
}

(function liveMirror(){
  const form = document.getElementById("scoutForm");
  if (!form) return;

  const OUT = {
    title:    document.getElementById("pv_title"),
    category: document.getElementById("pv_category"),
    season:   document.getElementById("pv_season"),
    location: document.getElementById("pv_location"),
    date:     document.getElementById("pv_date"),
    hero:     document.getElementById("pv_hero")
  };
  
  const heroLoader = document.getElementById("hero_loading");
  const showHeroLoading = (on) => {
  if (!heroLoader) return;
  heroLoader.hidden = !on;
};

    // Debounced hero updater
let heroTimer = null;

async function updateHeroIfNeeded(placeText) {
  clearTimeout(heroTimer);

  heroTimer = setTimeout(async () => {
    const heroImg = OUT.hero;
    if (!heroImg) return;

    if (!placeText || placeText.trim().length < 3) {
  // show a static default so users see something right away
  heroImg.src = "/assets/recon-placeholder.jpg"; 
  const credit = document.getElementById("pv_credit");
  if (credit) { 
    credit.textContent = ""; 
    credit.style.display = "none"; 
  }
  showHeroLoading(false);
  return;
}

    // show loading overlay
    showHeroLoading(true);
    heroImg.style.opacity = "0.6";

    try {
      // Try to split "Place, Region" into parts so NPS/Unsplash match better
      const [placePart, regionPart] = placeText.split(/\s*[,|-]\s*/);
      const place = (placePart || "").trim();
      const region = (regionPart || "").trim();

      const hit = await fetchHero({
        place,
        region,
        orientation: "landscape"
      });

      if (hit && hit.src) {
        heroImg.src = hit.src;
        heroImg.alt = hit.alt || placeText;

        const credit = document.getElementById("pv_credit");
        if (credit) {
          credit.innerHTML = hit.credit ? hit.credit : "";
          credit.style.display = hit.credit ? "block" : "none";
        }
      }
    } catch (err) {
      console.error("Hero fetch error:", err);
    } finally {
      heroImg.style.opacity = "1";
      showHeroLoading(false); // hide overlay when done
    }
  }, 250);
}

  const getMeta = (k)=> form.querySelector(`[data-ei-meta="${k}"]`)?.value?.trim() || "";

  function paint(){
  const dateISO = getMeta("date");
  const season  = seasonFromISODate(dateISO) || "‚Äî";

  OUT.title    && (OUT.title.textContent    = getMeta("title")    || "Name Your Expedition");
  OUT.category && (OUT.category.textContent = getMeta("category") || "‚Äî");
  OUT.season   && (OUT.season.textContent   = season);
  OUT.location && (OUT.location.textContent = getMeta("location") || "‚Äî");
  OUT.date     && (OUT.date.textContent     = dateISO ? fmtDateView(dateISO) : "‚Äî");

  const loc = getMeta("location");
  const ttl = getMeta("title");
  const heroQuery = loc || ttl;           // fall back to the title
  updateHeroIfNeeded(heroQuery);
}

  form.addEventListener("input", paint);
  form.addEventListener("change", paint);
  paint();
})();
/* ===== Initial ===== */
(function initPreview(){
  ensureCTA();
})();
  /* =========================================================
   MARK REQUIRED / OPTIONAL LABELS
   ========================================================= */
(function markRequiredOptional(){
  const form = document.getElementById('scoutForm');
  if (!form) return;
  form.querySelectorAll('label').forEach(label=>{
    if (label.hasAttribute('data-no-auto')) return; // skip if manually controlled
    const ctrl = label.nextElementSibling;
    if (!ctrl) return;
    label.classList.toggle('is-required',  ctrl.matches('[required]'));
    label.classList.toggle('is-optional', !ctrl.matches('[required]'));
  });
})();
</script>
  <!-- PURCHASE EXPEDITION BLUEPRINT HANDLER -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const $ = (sel) => document.querySelector(sel);
  const val = (sel) => {
    const el = $(sel);
    return el ? (el.value || "").trim() : "";
  };

  function getFormValues() {
    return {
      title: val('[name="trip_title"], #trip_title, [data-ei="trip_title"]'),
      trip_date: val('[name="trip_date"], #trip_date, [data-ei="trip_date"], #tripDate, [name="tripDate"]'),
      based_in: val('[name="city"], [name="based_in"], #based_in, [data-ei="based_in"]'),
      destination: val('[name="destination"], #destination, [data-ei="destination"]'),
      destination_idea: val('[name="destination_idea"], #destination_idea, [data-ei="destination_idea"]'),
      name: val('[name="name"], #name, [data-ei="name"]'),
      email: val('[name="email"], #email, [data-ei="email"]'),
      experience_level: val('[name="experience_level"], #experience_level, [data-ei="experience_level"]'),
      primary_objective: val('[name="primary_objective"], #primary_objective, [data-ei="primary_objective"]'),
      ideal_trip_length: val('[name="ideal_trip_length"], #ideal_trip_length, [data-ei="ideal_trip_length"]'),
      preferred_terrain: val('[name="preferred_terrain"], #preferred_terrain, [data-ei="preferred_terrain"]'),
      additional: val('[name="additional"], #additional, [data-ei="additional"]')
    };
  }

  async function buyBlueprintDirect() {
    console.log("‚úÖ buyBlueprintDirect fired");

    const f = getFormValues();
if (!f.email) {
  alert("Please add your email so we can send your Blueprint.");
  return;
}
if (!f.destination_idea) {
  alert("Add a Destination idea so we can build your Blueprint correctly.");
  return;
}

    const BLUEPRINT_PRICE_ID = "price_1SRw3ZKyANuReHHWei4HLs5K";

    const payload = {
      price_id: BLUEPRINT_PRICE_ID,
      customer_email: f.email,
      success_url: "https://www.expeditionintel.com/success?session_id={CHECKOUT_SESSION_ID}",
      cancel_url: "https://www.expeditionintel.com/checkout/canceled",
      metadata: {
        source: "blueprint_direct",
        user_name: f.name,
        user_email: f.email,
        title: f.title,
        trip_date: f.trip_date,
        based_in: f.based_in,
        destination: f.destination,
        destination_idea: f.destination_idea,
        experience_level: f.experience_level,
        primary_objective: f.primary_objective,
        ideal_trip_length: f.ideal_trip_length,
        preferred_terrain: f.preferred_terrain,
        notes: f.additional
      }
    };

    try {
      const res = await fetch("https://rtpfkfhvlkuagwqdsnfj.supabase.co/functions/v1/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const j = await res.json();
      console.log("Stripe response:", j);

      if (!res.ok || !j.url) {
        console.error("‚ùå Checkout error:", j);
        alert("Checkout error. Try again.");
        return;
      }

      window.location.href = j.url;
    } catch (e) {
      console.error("‚ùå Network or fetch error:", e);
      alert("Network error. Try again.");
    }
  }

  const btn = document.getElementById("btnBuyBlueprint");
  if (btn) {
    btn.addEventListener("click", buyBlueprintDirect);
    console.log("‚öôÔ∏è Blueprint listener attached to #btnBuyBlueprint");
  } else {
    console.error("‚ùå Button not found: #btnBuyBlueprint");
  }
});
</script>
</body>
</html>
